<html lang="en">
<head>
    <script src="/hoctiengtrung/hanzi-writer.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc Ti·∫øng Trung Ph·ªìn Th·ªÉ</title>
 <style>
/* Nh√≥m 1: CSS chung (Global Styles) */
body {
            font-family: arial;
            font-size: 20px;
            text-align: center;
            color: black;
            background-color: white;
            background-image: url("/hoctiengtrung/anhnen3.jpg");
            background-size: 480px auto;
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed; /* Add this line to fix the background image */
            margin: 0 auto;
            padding: 0;
            max-width: 480px;
            min-height: 100vh;
            position: relative;
        }
@font-face {
            font-family: hz;
            src: url("/hoctiengtrung/KaiTi-1.ttf");
        }
.header-container {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
    width: 100%;
}
.correct {
    background-color: green !important;
}
.incorrect {
    background-color: red;
}
button {
    font-size: 30px;
    padding: 5px;
    font-family: hz;
    border-radius: 10px;
    border: none;
    background-color: rgba(255, 255, 255, 0.7);
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    width: 100%;
    justify-content: center;
    text-align: left;
}
button2 {
    font-size: 20px;
    padding: 5px;
    border-radius: 20px;
    border: none;
    background-color: rgba(255, 255, 255, 0.7);
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    margin-right: 0;
}

/* Nh√≥m 2: M√†n h√¨nh ch·ªçn ch·∫ø ƒë·ªô v√† kh·ªüi ƒë·ªông */
#mode-selection-screen {
    text-align: center;
    margin-top: 50px;
}
#mode-selection-screen button2.mode-button {
    font-size: 18px;
    padding: 8px 16px;
    width: 200px;
    background-color: #4CAF50 !important;
    color: white;
    font-family: Arial;
    cursor: pointer;
    border-radius: 10px;
    border: none;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    margin: 5px;
}
#mode-selection-screen button2.mode-button.active {
    background-color: #55edbd !important;
}
#mode-selection-screen button2.mode-button:hover:not(.active) {
    background-color: #f2921d !important;
}
#mode-selection-screen button2.mode-button:disabled,
#mode-selection-screen button2.mode-button.disabled {
    background-color: #e0e0e0 !important;
    cursor: not-allowed;
    opacity: 0.6;
}
.mode-button {
    font-size: 24px;
    padding: 10px 20px;
    width: 300px;
    background-color: #4CAF50;
    color: white;
    font-family: Arial;
    cursor: pointer;
}
.mode-button:hover {
    background-color: #45a049;
}
.mode-button.disabled {
    pointer-events: none;
    opacity: 0.5;
    cursor: not-allowed;
    background-color: #cccccc;
}
.quiz-type-button {
    font-size: 18px;
    padding: 8px 10px;
    width: 95px;
    background-color: #2196F3;
    color: white;
    font-family: Arial;
    cursor: pointer;
    border-radius: 10px;
    border: none;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
	cursor: pointer;
}
.quiz-type-button.quiz-type-active {
    background-color: #2451f2; /* M√†u xanh khi ƒë∆∞·ª£c ch·ªçn */
    color: white; /* Ch·ªØ tr·∫Øng ƒë·ªÉ d·ªÖ ƒë·ªçc */
}
.quiz-type-button:hover {
    background-color: #55edbd;
}
.quiz-type-button:disabled {
    pointer-events: none;
    opacity: 0.5;
    background-color: #cccccc;
}
#quiz-type-buttons {
    display: flex;
    margin-top: 10px;
    justify-content: center;
    gap: 5px;
    flex-wrap: wrap
}
#start-screen {
    text-align: center;
    margin-top: 50px;
}
#start-screen input {
    font-size: 20px;
    padding: 5px;
    width: 100px;
    margin-right: 10px;
    margin-bottom: 10px;
}
#start-screen button2 {
    font-size: 20px;
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    font-family: arial;
}
#start-screen input[type="number"],
#start-screen input[type="text"] {
    width: 250px;
    padding: 8px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
}
#start-screen input[type="number"]::-webkit-inner-spin-button,
#start-screen input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
#start-screen input[type="number"] {
    -moz-appearance: textfield;
}
.welcome-title {
    font-family: Arial;
    font-size: 30px;
    font-weight: bold;
    color: blue;
    white-space: pre-line;
    text-align: center;
}

/* Nh√≥m 3: Giao di·ªán tr√≤ ch∆°i ch√≠nh */
#game-container {
    display: none;
}
#status-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 0 10px 10px 10px;
    margin-top: 0px;
    padding: 0px;
}
#timer {
    font-size: 18px;
    color: orange;
}
#total-count {
    font-size: 15px;
    color: blue;
}
#wrong-count {
    font-size: 15px;
    color: red;
}
#review-mode {
    font-size: 15px;
    color: green;
    display: none;
}
#meaning-container {
    text-align: left;
    margin-bottom: 5px;
    margin-top: -10px;
}
#meaning-container p {
    margin-bottom: 0;
}
#pinyin-container {
    text-align: center;
    margin-top: 0;
    display: flex;
    justify-content: center;
    gap: 5px;
    background-color: rgba(255, 255, 255, 0.7);
    padding: 10px;
    border-radius: 10px;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    width: 100%;
    box-sizing: border-box;
    display: none;
}
.pinyin-kyhieu-group {
    text-align: center;
    margin-top: 0;
    display: flex;
    justify-content: center;
    gap: 5px;
}
#pinyin {
    font-size: 20px;
    color: blue;
    display: none;
}
#kyhieu {
    font-size: 20px;
    color: red;
    display: none;
}
#question {
    font-size: 35px;
    font-family: hz;
    color: #000000;
    margin-bottom: 0px;
    text-align: center;
}
#meaning, #pinyin, #kyhieu, #phanTich, #question {
    white-space: pre-wrap;
}
#phanTich-container {
    text-align: left;
    margin-top: 10px;
    background-color: rgba(255, 255, 255, 0.7);
    padding: 10px;
    border-radius: 10px;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    width: 100%;
    box-sizing: border-box;
    display: none;
}
#phanTich {
    font-size: 20px;
    color: purple;
    display: none;
    white-space: pre-wrap;
}
#dialogue-container {
    padding: 0px;
    width: 100%;
    box-sizing: border-box;
    margin-top: 10px;
}
.dialogue-box {
    font-size: 30px;
    margin: 0px;
    padding: 5px;
    border-radius: 10px;
    background-color: rgba(255, 255, 255, 0.7);
    display: inline-block;
    font-family: hz;
    width: 100%;
    box-sizing: border-box;
    white-space: pre-wrap;
}
.dialogue-box .nhanvat {
    margin-right: 0px;
    display: inline;
}
.dialogue-box span {
    display: inline;
}
.dialogue-box.kieu-A {
    background-color: rgba(255, 179, 186, 0.8); /* pastel pink */
    text-align: left;
    width: 100%;
    box-sizing: border-box;
}

.dialogue-box.kieu-B {
    background-color: rgba(186, 225, 255, 0.8); /* pastel blue */
    text-align: left;
    width: 100%;
    box-sizing: border-box;
}

.dialogue-box.kieu-C {
    background-color: rgba(255, 223, 186, 0.8); /* pastel orange */
    text-align: left;
    width: 100%;
    box-sizing: border-box;
}

.dialogue-box.kieu-D {
    background-color: rgba(202, 255, 191, 0.8); /* pastel green */
    text-align: left;
    width: 100%;
    box-sizing: border-box;
}

.dialogue-box.kieu-K {
    background-color: rgba(255, 255, 186, 0.8); /* pastel yellow */
    text-align: left;
    width: 100%;
    box-sizing: border-box;
}

.dialogue-box.kieu-E {
    background-color: rgba(255, 255, 255, 0.5);
    text-align: center;
    box-sizing: border-box;
    font-size: 40px;
    font-weight: bold;
}
.dialogue-box.kieu-F {
    background-color: rgba(255, 255, 255, 0.5);
    text-align: center;
    box-sizing: border-box;
    font-size: 25px;
}
.dialogue-box.kieu-G {
    background-color: rgba(255, 255, 255, 0.5);
    text-align: center;
    box-sizing: border-box;
    font-size: 35px;
}
.nhanvat {
    color: blue;
    font-weight: bold;
}
#word-scramble-game {
    display: none;
    text-align: left;
    margin-top: 0px;
    position: relative;
    width: 100%;
}
#scrambled-input {
    font-size: 20px;
    padding: 5px 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
    background-color: rgba(255, 255, 255, 0.7);
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    text-align: left;
    min-height: 30px;
    width: 100%;
    margin: 0 auto 10px auto;
    display: block;
    box-sizing: border-box;
    display: none;
}
#scrambled-buttons {
    display: flex;
    flex-wrap: wrap;
    justify-content: left;
    max-width: 100%;
    margin-top: 5px;
}
#scrambled-buttons button {
    font-size: 30px;
    padding: 5px;
    border-radius: 10px;
    border: none;
    background-color: rgba(255, 255, 255, 0.7);
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 35px;
    height: 35px;
    gap: 1px;
    margin: 1px;
}
#scrambled-buttons button.incorrect {
    background-color: red !important;
    color: white;
}
#writing-container {
    display: none;
    text-align: center;
    margin: 20px auto;
    background-color: rgba(255, 255, 255, 0.7);
    padding: 10px;
    border-radius: 10px;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}
#writing-canvas {
    width: 200px;
    height: 200px;
    margin: 0 auto;
    border: 2px solid rgba(255, 105, 180, 0.5);
    border-radius: 5px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    position: relative;
    overflow: hidden;
    background: linear-gradient(to right, rgba(255, 105, 180, 0.3) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 105, 180, 0.3) 1px, transparent 1px);
    background-size: 33.33% 33.33%;
}
#current-char {
    font-size: 40px;
    font-family: hz;
    margin: 10px 0;
}
#writing-progress {
    font-size: 20px;
    color: blue;
    margin-top: 10px;
    display: inline;
    vertical-align: middle;
}
.toggle-outline-button {
    font-size: 14px;
    padding: 5px 10px;
    border-radius: 5px;
    background-color: #2196F3;
    color: white;
    border: none;
    cursor: pointer;
    margin-right: 10px;
    vertical-align: middle;
    width: 80px;
    height: 30px;
    box-sizing: border-box;
}
.toggle-outline-button:hover {
    opacity: 0.9;
}
#writing-container > div {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: nowrap;
}
.button-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
	margin-top: 10px;
}
.input-container {
    text-align: center;
    margin-top: -10px;
    padding: 20px;
}
.answer-input {
    font-size: 20px;
    padding: 5px 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
    background-color: rgba(255, 255, 255, 0.7);
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    width: 200px;
    text-align: center;
}
.button-container {
    text-align: center;
    padding: 5px;
    margin-top: 0px;
    margin-bottom: 0px;
}
#meaning-display-buttons button2.meaning-button {
    font-size: 16px;
    padding: 6px 12px;
    width: 120px;
    background-color: #cccccc !important;
    color: white;
    font-family: Arial;
    cursor: pointer;
    border-radius: 5px;
    border: none;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}
#meaning-display-buttons button2.meaning-button.active {
    background-color: #2196F3 !important;
}
#meaning-display-buttons button2.meaning-button:hover:not(.active) {
    background-color: #b0b0b0 !important;
}
#feedback {
    font-size: 24px;
    text-align: center;
    margin-top: 20px;
    display: none;
}
#dice-button {
    display: none !important;
}

/* Nh√≥m 4: Popup v√† panel ph·ª• */
#completion-message {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 35px;
    color: green;
    background-color: rgba(255, 255, 255, 0.9);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
	width: 90%;
}
#hanzi-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    z-index: 1000;
    max-width: 400px;
    width: 90%;
    max-height: 80vh; /* Gi·ªõi h·∫°n chi·ªÅu cao t·ªëi ƒëa */
    overflow-y: auto; /* Th√™m thanh cu·ªôn d·ªçc khi n·ªôi dung d√†i */
    text-align: left;
    font-size: 18px;
    font-family: Arial, sans-serif;
}
#hanzi-popup p {
    margin: 5px 0;
    white-space: pre-wrap; /* ƒê·∫£m b·∫£o xu·ªëng d√≤ng theo \n */
}
#hanzi-popup hr {
    margin: 10px 0;
    border: 0;
    border-top: 1px solid #ccc;
}
#hanzi-popup .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 20px;
    cursor: pointer;
    color: #333;
}
#hanzi-popup .close-btn:hover {
    color: #FF0000;
}
#hanzi-popup-content {
    line-height: 1.5;
    text-align: left; /* ƒê·∫£m b·∫£o n·ªôi dung cƒÉn tr√°i */
}
#info-popup, #author-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    z-index: 1000;
    max-width: 500px;
    width: 90%;
    text-align: left;
    font-size: 16px;
    font-family: Arial;
    max-height: 80vh;
    overflow-y: auto;
}
#info-popup .close-btn, #author-popup .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 20px;
    cursor: pointer;
    color: #333;
}
#info-popup .close-btn:hover, #author-popup .close-btn:hover {
    color: #FF0000;
}
#author-popup img {
    max-width: 100%;
    height: auto;
    display: block;
    margin-bottom: 10px;
    max-height: 250px;
    margin: 0 auto;
}
#info-popup-content, #author-popup-content {
    white-space: pre-wrap;
}
#nested-info-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    z-index: 1001;
    max-width: 500px;
    width: 90%;
    text-align: left;
    font-size: 16px;
    font-family: Arial;
    max-height: 80vh;
    overflow-y: auto;
}
#nested-info-popup .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 20px;
    cursor: pointer;
    color: #333;
}
#nested-info-popup .close-btn:hover {
    color: #FF0000;
}
#nested-info-popup-content {
    white-space: pre-wrap;
}
#nested-info-popup-content a {
    display: inline-block;
    font-size: 16px;
    padding: 5px 10px;
    margin: 2px;
    border-radius: 5px;
    border: none;
    background-color: #4CAF50;
    color: white;
    text-decoration: none;
    cursor: pointer;
    font-family: Arial;
}
#nested-info-popup-content a:hover {
    background-color: #45a049;
}
.hanzi-clickable {
    cursor: pointer;
    color: #000000;
}
.hanzi-clickable:hover {
    color: #FF0000;
}

/* Nh√≥m 5: C√¥ng c·ª• h·ªó tr·ª£ */
.menu-container {
    display: none;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 1000;
    width: 96%;
    max-width: 1200px;
    margin: 20px auto;
    position: static;
    border-radius: 10px;
    background-color: rgba(255, 255, 255, 0.8);
}
.volume-buttons {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-gap: 5px;
    margin-bottom: 10px;
}
.volume-btn {
    font-size: 16px;
    padding: 5px 5px;
    cursor: pointer;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 5px;
    text-align: center;
    font-family: Arial;
    width: 100%;
    box-sizing: border-box;
}
.volume-btn.active {
    background-color: #4CAF50;
    color: white;
}
.lesson-buttons {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    grid-gap: 5px;
    margin-bottom: 10px;
}
.lesson-btn {
    font-size: 14px;
    padding: 1px 5px;
    cursor: pointer;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 5px;
    text-align: center;
    font-family: arial;
    width: 100%;
    box-sizing: border-box;
}
.lesson-btn.active {
    background-color: #4CAF50;
    color: white;
}
.table-container {
    margin: 0px auto;
    width: 100%;
    max-width: 1200px;
    font-size: 12px;
}
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
}
tr:hover {
    background-color: #f5f5f5;
    cursor: pointer;
}
.search-container {
    text-align: center;
    margin: 20px auto;
    display: none;
}
.search-input {
    padding: 5px;
    font-size: 16px;
    width: 200px;
}
.search-btn {
    padding: 5px 10px;
    font-size: 16px;
    cursor: pointer;
    margin-left: 10px;
    border-radius: 5px;
    border: none;
    background-color: rgba(255, 255, 255, 0.7);
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    margin-right: 5px;
    cursor: pointer;
    font-family: arial;
}
.hanzii-container {
    width: 100%;
    height: 2000px;
    overflow: hidden;
    position: relative;
    margin-top: 20px;
    display: none;
}
.hanzii-container iframe {
    position: absolute;
    top: -250px;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}
.translate-container {
    width: 100%;
    height: 300px;
    overflow: hidden;
    position: relative;
    margin-top: 20px;
    display: none;
}
.translate-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}
.iframe-container {
    width: 100%;
    height: 3000px;
    overflow: hidden;
    position: relative;
    margin-top: 20px;
    display: none;
}
.iframe-container iframe {
    position: absolute;
    top: -300px;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}
#related-hanzi-list {
    display: none;
    margin-top: 20px;
    text-align: left;
    font-size: 18px;
    overflow-y: auto;
    border: none;
    padding: 10px;
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 20px;
    width: 100%;
    max-width: 100%;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    height: auto;
    box-sizing: border-box;
}
#related-hanzi-list p {
    margin: 5px 0;
}
#sub-mode-buttons {
    flex-wrap: wrap;
    width: 100%;
    justify-content: center;
	display: flex;
    flex-direction: row;
    gap: 10px;
    margin-top: 10px;
}
.sub-mode-button {
    background-color: #f77219;
    font-size: 18px; /* Nh·ªè h∆°n n√∫t g·ªëc */
    padding: 4px 8px; /* Nh·ªè h∆°n n√∫t g·ªëc */
    color: white; /* Ch·ªØ t·ªëi ƒë·ªÉ d·ªÖ ƒë·ªçc */
}
button3 {
    font-size: 16px;
    padding: 5px 10px;
    border-radius: 5px; /* Bo g√≥c */
    border: 0px;
    background-color: #2196F3;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
	color: white; /* Ch·ªØ tr·∫Øng */
    margin-right: 0;
	cursor: pointer;
}

button3.read-complete-button:hover {
    background-color: #1976D2; /* ƒê·∫≠m h∆°n khi hover */
}
#read-complete-container {
    display: flex;
    align-items: center; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
    justify-content: center; /* CƒÉn gi·ªØa theo chi·ªÅu ngang */
    gap: 10px; /* Kho·∫£ng c√°ch gi·ªØa n√∫t v√† ch·ªØ */
    margin-top: 10px;
}

.read-complete-text {
    font-size: 14px;
    color: #333; /* M√†u ch·ªØ t·ªëi */
}
#learn-another-button {
    width: 200px;
    background-color: #4CAF50;
}
#learn-another-button:hover {
    background-color: #45a049;
}
.popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
.popup-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.8);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    margin: 0;
}
#lesson-list-button {
    font-size: 16px;
    padding: 5px 10px;
    border-radius: 5px;
    border: none;
    background-color: #2196F3;
    color: white;
    cursor: pointer;
    margin-bottom: 10px;
}

#lesson-list-container {
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 5px;
    padding: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

#lesson-list-table {
    font-family: 'Noto Sans CJK SC', Arial, sans-serif;
    font-size: 14px;
}

#lesson-list-table th, #lesson-list-table td {
    padding: 8px;
    text-align: center;
    border: 1px solid #ccc;
}

#lesson-list-table tbody tr {
    cursor: pointer;
}

#lesson-list-table tbody tr:hover {
    background-color: #f0f0f0;
}
#lesson-list-table tbody tr.locked {
    color: #888;
    cursor: not-allowed;
}

#lesson-list-table tbody tr.locked:hover {
    background-color: transparent;
}

#random-mission-container {
    background-color: rgba(255, 255, 255, 0.9);
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}
#account-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
    font-size: 20px;
    gap: 10px;
}

#account-image {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
}

#account-info > div {
    text-align: center;
}

#account-info .progress-container {
    width: 200px;
    height: 20px;
    background-color: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
}

#level-progress {
    width: 0%;
    height: 100%;
    background-color: #4CAF50;
    border-radius: 10px;
    transition: width 0.5s ease-in-out;
    display: flex;
    align-items: center;
    justify-content: center;
}

#level-progress-text {
    color: white;
    font-size: 14px;
    text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
    position: absolute;
    width: 100%;
    text-align: center;
}
#earned-exp {
    font-size: 20px;
    color: green;
}
.auth-screen {
    display: block;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 1);
    background-size: cover;
    background-position: center;
    z-index: 1000;
    font-family: 'Noto Sans CJK SC', Arial, sans-serif;
    overflow-y: auto; /* Cho ph√©p cu·ªôn n·∫øu n·ªôi dung qu√° d√†i */
}

.auth-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start; /* B·∫Øt ƒë·∫ßu t·ª´ tr√™n ƒë·ªÉ tr√°nh cƒÉn gi·ªØa g√¢y l·ªách */
    min-height: 100vh; /* Chi·ªÅu cao t·ªëi thi·ªÉu b·∫±ng m√†n h√¨nh */
    background-image: url('/hoctiengtrung/nen.jpg'); /* Thay b·∫±ng link ·∫£nh n·ªÅn c·ªßa b·∫°n */
    background-size: cover; /* ƒê·∫£m b·∫£o ·∫£nh ph·ªß to√†n b·ªô container */
    background-position: center bottom; /* CƒÉn ·∫£nh v·ªÅ ph√≠a d∆∞·ªõi */
    padding: 30px;
    max-width: 400px;
    margin: 20px auto; /* CƒÉn gi·ªØa v·ªõi l·ªÅ tr√™n/d∆∞·ªõi */
    box-sizing: border-box;
    overflow-y: auto; /* Cho ph√©p cu·ªôn b√™n trong n·∫øu n·ªôi dung d√†i */
}

.auth-container h2 {
    color: #333;
    margin-bottom: 20px;
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
    max-width: 300px;
}

.input-group input {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
    width: 100%;
    box-sizing: border-box;
}

.show-password {
    padding: 0px;
    display: flex;
    align-items: center;
    font-size: 14px;
    color: white;
    cursor: pointer;
    white-space: nowrap;
}

.show-password input[type="checkbox"] {
    margin: 10px; /* X√≥a margin m·∫∑c ƒë·ªãnh c·ªßa checkbox */
    padding: 0; /* X√≥a padding m·∫∑c ƒë·ªãnh */
    width: 16px; /* K√≠ch th∆∞·ªõc checkbox */
    height: 16px;
margin-left: 50px; /* D·ªãch sang ph·∫£i 10px */
}

.auth-button {
    padding: 10px 20px;
    background-color: #2196F3;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 25px !important; /* B·∫Øt bu·ªôc √°p d·ª•ng */
    font-family: 'Arial', sans-serif;
    margin: 5px;
    transition: background-color 0.3s;
    display: flex; /* CƒÉn gi·ªØa theo c·∫£ hai chi·ªÅu */
    justify-content: center; /* CƒÉn gi·ªØa ngang */
    align-items: center; /* CƒÉn gi·ªØa d·ªçc */
    text-align: center; /* ƒê·∫£m b·∫£o cƒÉn gi·ªØa ngang */
    line-height: 1; /* ƒêi·ªÅu ch·ªânh chi·ªÅu cao d√≤ng */
    width: auto; /* N√∫t m·ªü r·ªông theo n·ªôi dung */
}

.auth-button:hover {
    background-color: #1976D2;
}

.toggle-link {
    margin-top: 5px;
    font-size: 14px;
    color: white;
}

.toggle-link a {
    color: #2196F3;
    text-decoration: none;
}

.toggle-link a:hover {
    text-decoration: underline;
}

.auth-error {
    color: red;
    font-size: 14px;
    margin-top: 3px;
    display: none;
}

/* ·∫®n header-container khi auth-screen hi·ªÉn th·ªã */
.auth-screen ~ .header-container {
    display: none;
}
#login-logo {
    display: block;
    margin-top: 20px;
    margin-bottom: 0px;
    width: 300px;
    height: auto;
}

.youtube-container {
    margin-top: 20px;
    display: flex;
    justify-content: center;
}

#youtube-player {
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}
.promo-title {
    color: white;
    font-size: 25px;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5), 
                 0 0 10px rgba(255, 255, 255, 0.8), 
                 0 0 20px rgba(255, 255, 255, 0.6);
    margin: 0; /* Gi·ªØ margin m·∫∑c ƒë·ªãnh */
    margin-bottom: 10px; /* Th√™m 10px b√™n d∆∞·ªõi */
    text-align: center;
}

.button-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    margin-top: 0px;
}

.promo-button {
    padding: 8px 15px;
    background-color: #f39821;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    font-size: 14px;
    transition: background-color 0.3s;
    width: 200px; /* ƒê·∫∑t chi·ªÅu r·ªông c·ªë ƒë·ªãnh cho n√∫t */
    text-align: center; /* CƒÉn gi·ªØa ch·ªØ trong n√∫t */
}

.promo-button:hover {
    background-color: #1976D2;
}
.divider {
    width: 100%;
    height: 1px;
    background-color: white;
    margin-bottom: 10px; /* Th√™m 10px b√™n d∆∞·ªõi */
}
.content-wrapper {
    padding: 0 10px; /* Th√™m padding tr√°i v√† ph·∫£i */
    box-sizing: border-box;
    max-width: 480px; /* H·∫πp h∆°n 480px c·ªßa body ƒë·ªÉ t·∫°o kho·∫£ng c√°ch */
    margin: 0 auto; /* CƒÉn gi·ªØa div */
}
#info-popup-content p, #nested-info-popup-content p, #author-popup-content p {
            margin: -5px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 0px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 0px;
            vertical-align: middle; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
            text-align: center; /* CƒÉn gi·ªØa theo chi·ªÅu ngang (t√πy ch·ªçn, n·∫øu mu·ªën) */
        }
        th {
            background-color: #f2f2f2;
            color: #333;
        }
        #info-popup-content table table, #nested-info-popup-content table table, #author-popup-content table table {
            border: 1px solid #ddd;
            margin: 0;
            width: 100%;
        }
        #info-popup-content table table th, #info-popup-content table table td,
        #nested-info-popup-content table table th, #nested-info-popup-content table table td,
        #author-popup-content table table th, #author-popup-content table table td {
            border: 1px solid #ddd;
            padding: 0px;
            font-size: 0.9em;
        }
        #info-popup-content ul, #nested-info-popup-content ul, #author-popup-content ul {
            margin-top: -20px;
            margin-bottom: -10px;
            padding-left: 10px;
        }
        #info-popup-content ul li, #nested-info-popup-content ul li, #author-popup-content ul li {
            margin:  -7px 0;
            padding: 0;
        }
        #info-popup-content h1, #nested-info-popup-content h1, #author-popup-content h1 {
            font-size: 1.8em;
            margin: 0px 0;
            color: navy;
        }
        #info-popup-content h2, #nested-info-popup-content h2, #author-popup-content h2 {
            font-size: 1.5em;
            margin: 0px 0;
            color: navy;
        }
        #info-popup-content h3, #nested-info-popup-content h3, #author-popup-content h3 {
            font-size: 1.3em;
            margin: 0px 0;
            color: navy;
        }
        a {
            color: blue;
            text-decoration: underline;
            cursor: pointer;
        }
        img {
            max-width: 100%;
            height: auto;
            max-height: 250px;
            display: block;
            margin: 0 auto;
        }
</style>
</head>
<body>
   <!-- Nh√≥m 1: Header -->
<div class="header-container">
    <img src="/hoctiengtrung/anhnenmoi.png" style="width: 100%; height: auto;">
</div>
<div id="auth-screen" class="auth-screen">
    <div class="auth-container">
<img id="login-logo" src="/hoctiengtrung/logo.jpg" alt="Login Banner" width="300" height="auto">
<div class="welcome-text" style="color: white; text-align: center; font-size: 14px; margin-bottom: 10px; margin: 5px 0;">
    <p style="margin: 5px 0;">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi ‚ÄúH·ªçc Ti·∫øng Trung Ph·ªìn Th·ªÉ‚Äù!</p>
    <p style="margin: 5px 0;">Tr·∫£i nghi·ªám c√°ch h·ªçc ch·ªØ H√°n truy·ªÅn th·ªëng k·∫øt h·ª£p ph∆∞∆°ng ph√°p h·ªçc th√¥ng minh, tr·ª±c quan.</p>
    <p style="margin: 5px 0;">H√£y ƒêƒÉng Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu h√†nh tr√¨nh h·ªçc s√¢u, nh·ªõ l√¢u, hi·ªÉu r·ªông ch·ªØ H√°n truy·ªÅn th·ªëng!</p>
</div>
<div class="divider"></div>
        <div id="login-container">
            <div class="input-group">
                <input type="text" id="login-user" placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
                <input type="password" id="login-pass" placeholder="M·∫≠t kh·∫©u" required>
                <label class="show-password">
                    <input type="checkbox" id="show-login-pass"> Hi·ªán m·∫≠t kh·∫©u
                </label>
                <button id="login-button" class="auth-button">ƒêƒÉng Nh·∫≠p</button>
                <p id="login-error" class="auth-error"></p>
                <p class="toggle-link">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" id="show-register">ƒêƒÉng k√Ω ngay</a></p>
            </div>
        </div>
        <div id="register-container" style="display: none;">
            <div class="input-group">
                <input type="text" id="register-name" placeholder="T√™n hi·ªÉn th·ªã" required>
                <input type="text" id="register-user" placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
                <input type="password" id="register-pass" placeholder="M·∫≠t kh·∫©u" required>
                <label class="show-password">
                    <input type="checkbox" id="show-register-pass"> Hi·ªán m·∫≠t kh·∫©u
                </label>
                <button id="register-button" class="auth-button">ƒêƒÉng K√Ω</button>
                <p id="register-error" class="auth-error"></p>
                <p class="toggle-link">ƒê√£ c√≥ t√†i kho·∫£n? <a href="#" id="show-login">ƒêƒÉng nh·∫≠p</a></p>
            </div>
        </div>
<div class="divider"></div>
        <div class="promo-section">
            <h3 class="promo-title">N·ªÄN VƒÇN MINH 5.000 NƒÇM H·ªíI SINH</h3>
            <div id="youtube-container">
                <iframe id="youtube-player" width="300" height="169" src="" frameborder="0" allowfullscreen></iframe>
            </div>
<h5 style="color: white; text-align: justify; margin: 5px 0;">Shen Yun l√† ƒëo√†n ngh·ªá thu·∫≠t m√∫a c·ªï ƒëi·ªÉn Trung Qu·ªëc h√†ng ƒë·∫ßu th·∫ø gi·ªõi, th√¥ng qua lo·∫°i h√¨nh ngh·ªá thu·∫≠t c·ªï ƒëi·ªÉn ƒë·ªÉ ph·ª•c h∆∞ng v√† h·ªìng d∆∞∆°ng vƒÉn h√≥a truy·ªÅn th·ªëng Trung Hoa ch√¢n ch√≠nh g·∫ßn nh∆∞ ƒë√£ b·ªã th·∫•t l·∫°c.</h5>
            <div class="button-group">
                <a href="https://vi.shenyunperformingarts.org/" target="_blank" class="promo-button">T√¨m hi·ªÉu SHENYUN</a>
                <a href="https://www.shenyuncreations.com/vi-VN" target="_blank" class="promo-button">Xem SHENYUN online</a>
            </div>
      <br>
<br>
<br>
<br>
<br>
        </div>
    </div>
</div>

<!-- Nh√≥m 2: M√†n h√¨nh ch·ªçn ch·∫ø ƒë·ªô v√† kh·ªüi ƒë·ªông -->
<!-- M√†n h√¨nh ch·ªçn ch·∫ø ƒë·ªô -->
<div id="mode-selection-screen" style="text-align: center; margin-top: 30px;">
<div id="account-info" style="display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; font-size: 20px; gap: 10px;">
    <img id="account-image" src="" alt="Avatar" style="width: 200px; height: 200px; border-radius: 10%; object-fit: cover;">
    <div style="text-align: center;">
        <span id="account-name"></span>
    </div>
 <div style="text-align: center;">
        <span id="account-danhHieu">A</span>
    </div>
    <div style="text-align: center;">
        H·ªçc l·ª±c: <span id="account-exp">0</span> ƒëi·ªÉm
    </div>
    <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
        <div style="text-align: center;">
            C·∫•p: <span id="account-level">1</span>
        </div>
        <div style="width: 200px; height: 20px; background-color: #e0e0e0; border-radius: 10px; overflow: hidden; position: relative;">
            <div id="level-progress" style="width: 0%; height: 100%; background-color: #4CAF50; border-radius: 10px; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center;">
                <span id="level-progress-text" style="color: white; font-size: 14px; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); position: absolute; width: 100%; text-align: center;">0%</span>
            </div>
        </div>
    </div>
</div>
    <div style='font-family: "Arial"; font-size: 30px; font-weight: bold; color: blue;'>
        Ch·ªçn ch·∫ø ƒë·ªô h·ªçc
    </div>
<!-- Container cho c√°c n√∫t lo·∫°i √¥n t·∫≠p -->
    <div id="quiz-type-buttons" style="display: none; margin-top: 10px; justify-content: center; gap: 5px;"></div>
 <br>
    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
        <button2 class="mode-button" data-mode="taiwanese">Ti·∫øng Trung ƒê√†i Loan</button2>
        <button2 class="mode-button" data-mode="samtukinh">Tam T·ª± Kinh</button2>
        <button2 class="mode-button disabled" data-mode="thientuvan" disabled>Thi√™n T·ª± VƒÉn</button2>
        <button2 class="mode-button" data-mode="poetry">300 B√†i Th∆° ƒê∆∞·ªùng</button2>
        <button2 class="mode-button disabled" data-mode="hongngam" disabled>H·ªìng Ng√¢m</button2>
    </div>
    
</div>

<!-- M√†n h√¨nh kh·ªüi ƒë·ªông -->
<div id="start-screen" style="display: none;">
    <div class="welcome-title"></div>
    <br>
<!-- Th√™m n√∫t Danh s√°ch b√†i v√† container cho b·∫£ng -->
    <div>
        <button2 id="lesson-list-button" class="quiz-type-button">Danh s√°ch b√†i</button2>
        <div id="lesson-list-container" style="display: none; margin-top: 10px; max-height: 300px; overflow-y: auto;">
            <table id="lesson-list-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ccc; padding: 8px;">B√†i</th>
                        <th style="border: 1px solid #ccc; padding: 8px;">T√™n</th>
                        <th style="border: 1px solid #ccc; padding: 8px;">Level c·∫ßn</th>
                        <th style="border: 1px solid #ccc; padding: 8px;">Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody id="lesson-list-body"></tbody>
            </table>
        </div>
    </div>
<br>
	 <div>
        <label for="lesson-input">Ch·ªçn b√†i <em>(v√≠ d·ª•: 16, 1-5, 1,5):</em></label><br>
        <input type="text" id="lesson-input" placeholder="ƒê·ªÉ tr·ªëng ƒë·ªÉ ch·ªçn ng·∫´u nhi√™n">
    </div>
    <div id="dialogue-select-container" style="display: none;">
        <label for="dialogue-number">Ch·ªçn h·ªôi tho·∫°i <em>(Nh·∫≠p s·ªë):</em></label><br>
        <input type="number" id="dialogue-number" min="1" placeholder="ƒê·ªÉ tr·ªëng ƒë·ªÉ ch·ªçn ng·∫´u nhi√™n">
    </div>
    <div id="word-count-container">
        <label for="word-count">S·ªë t·ª´ c·∫ßn √¥n t·∫≠p:</label><br>
        <input type="number" id="word-count" value="30" min="1">
    </div>
    <div id="time-limit-container">
        <label for="time-limit">Th·ªùi gian m·ªói c√¢u (gi√¢y):</label><br>
        <input type="number" id="time-limit" value="20" min="1">
    </div>
<!-- Th√™m div cho nhi·ªám v·ª• ng·∫´u nhi√™n -->
    <div id="random-mission-container" style="text-align: center; margin-bottom: 10px; font-size: 18px; color: #2196F3; font-weight: bold;">
        <span id="random-mission-text"></span>
    </div>
<div id="meaning-display-buttons" style="display: flex; justify-content: center; gap: 5px; margin-top: 5px;">
            <button2 class="meaning-button active" data-value="show">1.Luy·ªán ƒë·ªçc</button2>
            <button2 class="meaning-button" data-value="hide">2.Luy·ªán nghe</button2>
        </div>
<br>
    <!-- Th√™m n√∫t Quay L·∫°i -->
    <div style="display: flex; justify-content: center; gap: 10px;">
        <button2 id="back-to-mode-button" class="quiz-type-button">QUAY L·∫†I</button2>
        <button2 id="start-button" class="quiz-type-button">B·∫ÆT ƒê·∫¶U</button2>
    </div>
</div>
<!-- Bao quanh -->
 <div class="content-wrapper">
        <!-- Nh√≥m 3: Giao di·ªán tr√≤ ch∆°i ch√≠nh -->
<div id="game-container">
   
    <!-- Tr·∫°ng th√°i tr√≤ ch∆°i -->
    <div id="status-container">
        <span id="wrong-count">S·ªë c√¢u b·ªã sai: 0</span>
        <span id="timer">Th·ªùi gian: 20</span>   
        <span id="total-count">T·ªïng s·ªë c√¢u: 0</span>
        <span id="review-mode">√în t·∫≠p c√¢u sai</span>
    </div>
<div style="text-align: center;">
        <span id="earned-exp">ƒêi·ªÉm: 0</span>
    </div>

    <!-- Hi·ªÉn th·ªã c√¢u h·ªèi -->
    <div id="meaning-container">
        <p>
            <span style="font-size:20px; color: blue; font-weight: bold;">
                <em>D·ªãch nghƒ©a: </em>
            </span>
            <span id="meaning" style="font-size:20px;"></span>
        </p>
    </div>
    <div id="pinyin-container">
        <div id="question"></div>
        <div class="pinyin-kyhieu-group">
            <span id="pinyin"></span>
            <span id="kyhieu"></span>
        </div>
		<div id="read-complete-container" style="display: none; text-align: center; margin-top: 10px;">
        <button3 id="read-complete-button" style="font-size: 16px; padding: 5px 10px;">ƒê√£ ƒë·ªçc xong</button3>
		<span id="read-complete-text" class="read-complete-text"> << B·∫•m ƒë·ªÉ chuy·ªÉn c√¢u ti·∫øp theo</span>
    </div>
    </div>
    <div id="phanTich-container">
        <span id="phanTich"></span>
    </div>

    <!-- Ch·∫ø ƒë·ªô ch∆°i -->
    <div id="word-scramble-game"></div>
    <img id="dialogue-image" src="" alt="Dialogue Image" style="max-width: 100%; max-height: 200px; height: auto; display: none; margin: 5px auto 0 auto;">
    <div id="dialogue-display" style="display: none; text-align: center; max-height: 350px; overflow-y: auto;">
        <div id="dialogue-container" style="display: flex; flex-direction: column; gap: 0px;"></div>
        <div id="scrambled-buttons" class="button-grid"></div>
        <div class="button-container">
            <button2 id="dice-button" style="display: none;">üé≤</button2>
            <button2 id="back-button">üîô</button2>
            <button2 id="next-button">üîú</button2>
        </div>
    </div>
    <div id="writing-container" style="display: none;">
        <div id="writing-canvas"></div>
        <div style="text-align: center;">
            <span id="writing-progress"></span>
        </div>
    </div>

    <!-- ƒêi·ªÅu khi·ªÉn tr√≤ ch∆°i -->
    <div class="button-grid" id="option-buttons"></div>
    <div id="feedback"></div>
    <div class="input-container">
        <div id="inputPinyinDisplay" style="font-size: 18px; color: green; margin-bottom: 5px;"></div>
        <input type="text" id="answerInput" class="answer-input" placeholder="Nh·∫≠p H√°n t·ª±">
        <button2 id="testButton" style="font-size: 20px; padding: 5px 10px; border-radius: 10px; border: none; background-color: rgba(255, 255, 255, 0.7); box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);">üÜó
            <label style="margin-left: 1px;">
                <input type="checkbox" id="autoCheck" checked>
            </label>
        </button2>
    </div>
    <div class="button-container">
	    <button2 id="homeButton">üèØ</button2> <!-- Th√™m n√∫t Home -->
        <button2 id="playButton">üîä</button2>
        <button2 id="hintButton">üí°</button2>
        <button2 id="writeButton" style="display: none;">üñå</button2>
        <button2 id="write-dialogue-button" style="display: none;">üñå</button2>
        <button2 id="diceButton" style="display: none;">üé≤</button2>
        <button2 id="infoButton" style="display: none;">üìã</button2>
        <button2 id="authorButton" style="display: none;">üë≤</button2>
        <button2 class="related-btn" onclick="toggleRelated()">üîó</button2>
        <button2 class="magnifier-btn" onclick="toggleMenu()">üîç</button2>
        <button2 class="book-btn" onclick="toggleSearch()">üìñ</button2>
        <button2 class="translate-btn" onclick="toggleTranslate()">üîÉ</button2>
    </div>
	 <!-- Th√†nh ph·∫ßn ph·ª• tr·ª£ -->
    <audio id="audio"></audio>
</div>
    </div>

<!-- Nh√≥m 4: Popup v√† panel ph·ª• -->
<div id="endgame-popup" class="popup" style="display: none;">
    <div id="endgame-popup-content" class="popup-content"></div>
</div>
<div id="hanzi-popup">
    <span class="close-btn" onclick="closeHanziPopup()">‚ùå</span>
    <div id="hanzi-popup-content"></div>
</div>
<div id="info-popup">
    <span class="close-btn" onclick="closeInfoPopup()">‚ùå</span>
    <div id="info-popup-content"></div>
</div>
<div id="author-popup">
    <span class="close-btn" onclick="closeAuthorPopup()">‚ùå</span>
    <div id="author-popup-content"></div>
</div>
<div id="nested-info-popup">
    <span class="close-btn" onclick="closeNestedInfoPopup()">‚ùå</span>
    <div id="nested-info-popup-content"></div>
</div>
<div id="info" style="display: none;">
    <div id="wrong-hanzi-display" style="font-size: 15px; color: red; text-align: left; margin: 10px;">
        <p>Danh s√°ch t·ª´ sai:</p>
        <ul id="wrong-hanzi-list"></ul>
    </div>
    <div id="review-hanzi-display" style="font-size: 15px; color: green; text-align: left; margin: 10px; display: none;">
        <p>Danh s√°ch t·ª´ s·∫Ω h·ªèi trong ch·∫ø ƒë·ªô √¥n t·∫≠p:</p>
        <ul id="review-hanzi-list"></ul>
    </div>
</div>

<!-- Nh√≥m 5: C√¥ng c·ª• h·ªó tr·ª£ -->
<div id="menuContainer" class="menu-container">
    <div id="volumeButtons" class="volume-buttons"></div>
    <div id="lessonButtons" class="lesson-buttons"></div>
    <div id="tableContainer" class="table-container"></div>
</div>
<div id="searchContainer" class="search-container">
    <input type="text" id="searchInput" class="search-input" placeholder="Nh·∫≠p H√°n t·ª±">
    <button2 class="search-btn" onclick="searchHanzi()">Tra</button2>
</div>
<div id="hanziiContainer" class="hanzii-container">
    <iframe id="hanziiIframe" src=""></iframe>
</div>
<div id="translateContainer" class="translate-container">
    <iframe id="translateIframe" src=""></iframe>
</div>
<div id="related-hanzi-list"></div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
<script>
let earnedEXP = 0;
    let questionWord = "hanzi";
    let currentQuestion = null;
    let allWords = [];
    let selectedHanzi = [];
    let wrongHanzi = [];
    let questionCount = 0;
    let isReviewMode = false;
    let audioStartTime = 0;
    let audioEndTime = 0;
    let maxWords = 10;
    let currentReviewList = [];
    let jsonData = [];
    let giatrihanzi = "";
    let selectedVolume = null;
    let selectedLesson = null;
    const relatedHanziList = document.getElementById('related-hanzi-list');
    let timeLimit = 20;
    let timeRemaining = timeLimit;
    let timerInterval = null;
    let showMeaning = true;
    let quizType = "vocabulary";
    let bangHanTuData = [];
    let pinyinTuDienData = [];
    let isScrambleMode = false;
    let currentScrambleAnswer = '';
    let dialogueData = [];
    let selectedDialogue = null;
    let hanzi3Data = [];
let selectedMode = 'taiwanese';
let isWritingMode = false;
let currentCharIndex = 0;
let writer = null;
let writingChars = [];
let showOutline = false; // M·∫∑c ƒë·ªãnh kh√¥ng hi·ªÉn th·ªã ƒë∆∞·ªùng vi·ªÅn
let isNewWordMode = false; // Bi·∫øn x√°c ƒë·ªãnh ch·∫ø ƒë·ªô H·ªçc T·ª´ M·ªõi
let accountData = null;
let randomMissionLesson = null; // L∆∞u b√†i c·ªßa nhi·ªám v·ª• ng·∫´u nhi√™n
// Bi·∫øn l∆∞u d·ªØ li·ªáu level
let levelData = [];

// H√†m t·∫£i d·ªØ li·ªáu level t·ª´ _level.json
async function loadLevelData() {
    try {
        const response = await fetch('/hoctiengtrung/json/level3.json', {
            cache: 'no-cache'
        });
        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ t·∫£i _level.json');
        }
        levelData = await response.json();
        console.log('Level data loaded:', levelData);
    } catch (error) {
        console.error('L·ªói khi t·∫£i _level.json:', error);
        alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu c·∫•p ƒë·ªô!');
    }
}

// H√†m x√°c ƒë·ªãnh c·∫•p ƒë·ªô v√† c·∫≠p nh·∫≠t giao di·ªán
function updateLevelInfo() {
    const currentEXP = parseInt(document.getElementById('account-exp').textContent) || 0;
    let currentLevel = null;

    // T√¨m c·∫•p ƒë·ªô d·ª±a tr√™n EXP
    for (const level of levelData) {
        if (currentEXP >= level.expStar && currentEXP <= level.expEnd) {
            currentLevel = level;
            break;
        }
    }

    // N·∫øu kh√¥ng t√¨m th·∫•y c·∫•p ƒë·ªô (EXP v∆∞·ª£t qu√° c·∫•p cu·ªëi), l·∫•y c·∫•p cu·ªëi c√πng
    if (!currentLevel && levelData.length > 0) {
        currentLevel = levelData[levelData.length - 1];
    }

    if (currentLevel) {
        // C·∫≠p nh·∫≠t giao di·ªán
        document.getElementById('account-level').textContent = currentLevel.Level;
        document.getElementById('account-danhHieu').textContent = currentLevel.danhHieu;
        document.getElementById('account-image').src = currentLevel.Anh;

        // T√≠nh ph·∫ßn trƒÉm ti·∫øn ƒë·ªô
        const progressPercent = ((currentEXP - currentLevel.expStar) / currentLevel.expUp) * 100;
        const roundedProgress = Math.min(Math.round(progressPercent * 10) / 10, 100); // L√†m tr√≤n 1 ch·ªØ s·ªë th·∫≠p ph√¢n
        document.getElementById('level-progress').style.width = `${roundedProgress}%`;
        document.getElementById('level-progress-text').textContent = `${roundedProgress}%`;
    } else {
        // Fallback n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu c·∫•p ƒë·ªô
        document.getElementById('account-level').textContent = '1';
        document.getElementById('account-danhHieu').textContent = 'A';
        document.getElementById('account-image').src = '_anhA.png';
        document.getElementById('level-progress').style.width = '0%';
        document.getElementById('level-progress-text').textContent = '0%';
    }
}

function generateRandomMission() {
    const currentLevel = parseInt(document.getElementById('account-level').textContent) || 1;
const unlockedLessons = lessonListData.filter(lesson => currentLevel >= lesson.level_unlock);
    
    if (unlockedLessons.length === 0) {
        randomMissionLesson = null;
        document.getElementById('random-mission-text').textContent = 'Ch∆∞a c√≥ b√†i n√†o m·ªü kh√≥a ƒë·ªÉ t·∫°o nhi·ªám v·ª•!';
        return;
    }
    
    const randomIndex = Math.floor(Math.random() * unlockedLessons.length);
    randomMissionLesson = unlockedLessons[randomIndex].bai;
    document.getElementById('random-mission-text').textContent = 
        `H√£y √¥n l·∫°i b√†i ${randomMissionLesson} ƒë·ªÉ nh·∫≠n x2 EXP`;
}

// ƒê·ªãnh nghƒ©a URL c·ªßa c√°c file danh s√°ch b√†i
const lessonListUrls = {
    taiwanese: '/hoctiengtrung/json/danhsachbai-tiengtrungdailoan9.json',
    samtukinh: '/hoctiengtrung/json/danhsachbai-tamtukinh.json',
    poetry: '/hoctiengtrung/json/danhsachbai-tiengtrungdailoan9.json',
    thientuvan: '/hoctiengtrung/json/danhsachbai-tiengtrungdailoan9.json',
    hongngam: '/hoctiengtrung/json/danhsachbai-tiengtrungdailoan9.json'
};

// Bi·∫øn ƒë·ªÉ l∆∞u d·ªØ li·ªáu danh s√°ch b√†i
let lessonListData = [];

// H√†m t·∫£i danh s√°ch b√†i
async function loadLessonList() {
    try {
        const response = await fetch(lessonListUrls[selectedMode], {
            cache: 'no-cache'
        });
        if (!response.ok) {
            throw new Error(`Kh√¥ng th·ªÉ t·∫£i ${lessonListUrls[selectedMode]}`);
        }
        lessonListData = await response.json();
        console.log('Lesson list loaded:', lessonListData);
    } catch (error) {
        console.error('L·ªói khi t·∫£i danh s√°ch b√†i:', error);
        alert(`Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√†i cho ${modeDisplayNames[selectedMode]}!`);
    }
}

// H√†m hi·ªÉn th·ªã b·∫£ng danh s√°ch b√†i
function showLessonList() {
    const lessonListContainer = document.getElementById('lesson-list-container');
    const lessonListBody = document.getElementById('lesson-list-body');
    lessonListBody.innerHTML = '';

    const currentLevel = parseInt(document.getElementById('account-level').textContent) || 1;

    lessonListData.forEach(lesson => {
        const row = document.createElement('tr');
        const status = currentLevel >= lesson.level_unlock ? '‚úÖ' : 'üîí';
        row.innerHTML = `
            <td>${lesson.bai}</td>
            <td>${lesson.name}</td>
            <td>${lesson.level_unlock}</td>
            <td>${status}</td>
        `;
        if (status === 'üîí') {
            row.classList.add('locked');
        } else {
            row.addEventListener('click', () => {
                document.getElementById('lesson-input').value = lesson.bai;
                lessonListContainer.style.display = 'none';
            });
        }
        lessonListBody.appendChild(row);
    });

    lessonListContainer.style.display = lessonListContainer.style.display === 'block' ? 'none' : 'block';
}

// G·ªçi loadLessonList khi ch·ªçn ch·∫ø ƒë·ªô
document.querySelectorAll('.mode-button').forEach(button => {
    button.addEventListener('click', () => {
        if (button.classList.contains('disabled') || button.hasAttribute('disabled')) {
            return;
        }

        document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        selectedMode = button.getAttribute('data-mode');
        console.log('Selected mode:', selectedMode);

        // Load d·ªØ li·ªáu ngay khi ch·ªçn ch·∫ø ƒë·ªô
        loadInitialData();
        loadLessonList(); // T·∫£i danh s√°ch b√†i khi ch·ªçn ch·∫ø ƒë·ªô
        // ... (ph·∫ßn c√≤n l·∫°i c·ªßa s·ª± ki·ªán click gi·ªØ nguy√™n)
    });
});

// Th√™m s·ª± ki·ªán cho n√∫t Danh s√°ch b√†i
document.getElementById('lesson-list-button').addEventListener('click', showLessonList);

// ƒê·ªãnh nghƒ©a token ·ªü ph·∫°m vi to√†n c·ª•c
const pass1 = 'ghp_sbgtwaf2';
const pass2 = 'jootc3dvd4eCkh';
const pass3 = 'Fi1CPIOo0H1Fz4';
const GITHUB_TOKEN = pass1 + pass2 + pass3;

let currentUser = null; // L∆∞u th√¥ng tin t√†i kho·∫£n ƒëang ƒëƒÉng nh·∫≠p

// H√†m loadAccountData s·ª≠a ƒë·ªïi ƒë·ªÉ x·ª≠ l√Ω m·∫£ng t√†i kho·∫£n
async function loadAccountData() {
    try {
        const url = 'https://api.github.com/repos/son502-mocnhien/hoctiengtrung/contents/taikhoan.json';
        const response = await fetch(url, {
            headers: {
                'Accept': 'application/vnd.github.v3+json',
                'Authorization': `Bearer ${GITHUB_TOKEN}`
            }
        });
        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ t·∫£i taikhoan.json t·ª´ GitHub API');
        }
        const data = await response.json();
        const binaryString = atob(data.content);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        const content = new TextDecoder('utf-8').decode(bytes);
        accountData = JSON.parse(content); // B√¢y gi·ªù l√† m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng t√†i kho·∫£n
    } catch (error) {
        console.error('L·ªói khi t·∫£i taikhoan.json:', error);
        document.getElementById('account-exp').textContent = '0';
        document.getElementById('account-name').textContent = 'Kh√°ch Nh√¢n';
        document.getElementById('account-level').textContent = '1';
        document.getElementById('account-danhHieu').textContent = 'A';
        document.getElementById('account-image').src = '_anhA.png';
        document.getElementById('level-progress').style.width = '0%';
        document.getElementById('level-progress-text').textContent = '0%';
        earnedEXP = 0;
        document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
    }
}

// Kh·ªüi t·∫°o m√†n h√¨nh ƒëƒÉng nh·∫≠p/ƒëƒÉng k√Ω
document.getElementById('mode-selection-screen').style.display = 'none'; // ·∫®n m√†n ch·ªçn ch·∫ø ƒë·ªô
document.getElementById('game-container').style.display = 'none';
document.getElementById('start-screen').style.display = 'none';
document.getElementById('auth-screen').style.display = 'block';

// X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
document.getElementById('login-button').addEventListener('click', async () => {
    const username = document.getElementById('login-user').value.trim();
    const password = document.getElementById('login-pass').value.trim();
    const errorElement = document.getElementById('login-error');

    if (!username || !password) {
        errorElement.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u!';
        errorElement.style.display = 'block';
        return;
    }

    await loadAccountData();
    const user = accountData.find(u => u.user === username && u.pass === password);
    if (user) {
        currentUser = user;
        document.getElementById('account-name').textContent = user.name;
        document.getElementById('account-exp').textContent = user.EXP;
        await loadLevelData();
        updateLevelInfo();
        earnedEXP = 0;
        document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('mode-selection-screen').style.display = 'block';
        document.querySelector('.header-container').style.display = 'block';
        document.getElementById('youtube-player').src = ''; // D·ª´ng video
        errorElement.style.display = 'none';
    } else {
        errorElement.textContent = 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!';
        errorElement.style.display = 'block';
    }
});

// X·ª≠ l√Ω ƒëƒÉng k√Ω
document.getElementById('register-button').addEventListener('click', async () => {
    const username = document.getElementById('register-user').value.trim();
    const password = document.getElementById('register-pass').value.trim();
    const name = document.getElementById('register-name').value.trim();
    const errorElement = document.getElementById('register-error');

    if (!username || !password || !name) {
        errorElement.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!';
        errorElement.style.display = 'block';
        return;
    }

    await loadAccountData();
    if (accountData.find(u => u.user === username)) {
        errorElement.textContent = 'T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i!';
        errorElement.style.display = 'block';
        return;
    }

    const newUser = { user: username, pass: password, name: name, EXP: 0 };
    accountData.push(newUser);

    try {
        const content = JSON.stringify(accountData, null, 2);
        const encodedContent = btoa(unescape(encodeURIComponent(content)));
        const getFileResponse = await fetch('https://api.github.com/repos/son502-mocnhien/hoctiengtrung/contents/taikhoan.json', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github+json'
            }
        });
        if (!getFileResponse.ok) {
            throw new Error('Kh√¥ng th·ªÉ l·∫•y SHA c·ªßa file');
        }
        const fileData = await getFileResponse.json();
        const sha = fileData.sha;

        const updateResponse = await fetch('https://api.github.com/repos/son502-mocnhien/hoctiengtrung/contents/taikhoan.json', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: 'ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi',
                content: encodedContent,
                sha: sha,
                branch: 'main'
            })
        });

        if (updateResponse.ok) {
            currentUser = newUser;
            document.getElementById('account-name').textContent = name;
            document.getElementById('account-exp').textContent = '0';
            await loadLevelData();
            updateLevelInfo();
            earnedEXP = 0;
            document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('mode-selection-screen').style.display = 'block';
            document.querySelector('.header-container').style.display = 'block';
            document.getElementById('youtube-player').src = ''; // D·ª´ng video
            errorElement.style.display = 'none';
        } else {
            errorElement.textContent = 'L·ªói khi ƒëƒÉng k√Ω t√†i kho·∫£n!';
            errorElement.style.display = 'block';
        }
    } catch (error) {
        console.error('L·ªói khi ƒëƒÉng k√Ω:', error);
        errorElement.textContent = 'L·ªói khi ƒëƒÉng k√Ω t√†i kho·∫£n!';
        errorElement.style.display = 'block';
    }
});

// Chuy·ªÉn ƒë·ªïi gi·ªØa ƒëƒÉng nh·∫≠p v√† ƒëƒÉng k√Ω
document.getElementById('show-register').addEventListener('click', () => {
    document.getElementById('login-container').style.display = 'none';
    document.getElementById('register-container').style.display = 'block';
    document.getElementById('login-error').style.display = 'none';
    document.getElementById('register-error').style.display = 'none';
});

document.getElementById('show-login').addEventListener('click', () => {
    document.getElementById('login-container').style.display = 'block';
    document.getElementById('register-container').style.display = 'none';
    document.getElementById('login-error').style.display = 'none';
    document.getElementById('register-error').style.display = 'none';
    playRandomYouTubeVideo(); // Ph√°t video ng·∫´u nhi√™n
});

// S·ª≠a h√†m claimExperience ƒë·ªÉ c·∫≠p nh·∫≠t EXP cho t√†i kho·∫£n hi·ªán t·∫°i
async function claimExperience(finalEXP) {
    try {
        if (!currentUser) {
            console.error('Kh√¥ng c√≥ t√†i kho·∫£n ƒëang ƒëƒÉng nh·∫≠p');
            alert('L·ªói: Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!');
            return;
        }

        await loadAccountData();
        const userIndex = accountData.findIndex(u => u.user === currentUser.user);
        if (userIndex === -1) {
            console.error('Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n trong accountData');
            alert('L·ªói: Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n!');
            return;
        }

        accountData[userIndex].EXP = (parseInt(accountData[userIndex].EXP) || 0) + finalEXP;

        const content = JSON.stringify(accountData, null, 2);
        const encodedContent = btoa(unescape(encodeURIComponent(content)));

        const getFileResponse = await fetch('https://api.github.com/repos/son502-mocnhien/hoctiengtrung/contents/taikhoan.json', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github+json',
                'Content-Type': 'application/json'
            }
        });

        if (!getFileResponse.ok) {
            const errorData = await getFileResponse.json();
            console.error('L·ªói l·∫•y SHA:', errorData);
            throw new Error(`Kh√¥ng th·ªÉ l·∫•y SHA c·ªßa file: ${errorData.message}`);
        }

        const fileData = await getFileResponse.json();
        const sha = fileData.sha;

        const updateResponse = await fetch('https://api.github.com/repos/son502-mocnhien/hoctiengtrung/contents/taikhoan.json', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: 'C·∫≠p nh·∫≠t ƒëi·ªÉm kinh nghi·ªám EXP',
                content: encodedContent,
                sha: sha,
                branch: 'main'
            })
        });

        if (updateResponse.ok) {
            currentUser.EXP = accountData[userIndex].EXP;
            document.getElementById('account-exp').textContent = currentUser.EXP;
            await updateLevelInfo();
            earnedEXP = 0;
            randomMissionLesson = null;
            document.getElementById('endgame-popup').style.display = 'none';
            returnToModeSelection();
        } else {
            const errorData = await updateResponse.json();
            console.error('L·ªói c·∫≠p nh·∫≠t EXP:', errorData);
            alert(`L·ªói khi c·∫≠p nh·∫≠t EXP: ${errorData.message}`);
        }
    } catch (error) {
        console.error('L·ªói khi c·∫≠p nh·∫≠t EXP:', error);
    }
}

function startWritingMode() {
    if (!currentQuestion || !currentQuestion.hanzi) {
        console.error('Kh√¥ng c√≥ c√¢u h·ªèi ho·∫∑c H√°n t·ª± ƒë·ªÉ t·∫≠p vi·∫øt');
        stopWritingMode();
        return;
    }

    isWritingMode = true;
    currentCharIndex = 0;
    currentScrambleAnswer = '';
    writingChars = currentQuestion.hanzi.replace(/\|/g, '').split('').filter(char => !/[.,!?Ôºå„ÄÇÔºÅÔºü]/.test(char));

    if (writingChars.length === 0) {
        console.warn('Kh√¥ng c√≥ k√Ω t·ª± h·ª£p l·ªá ƒë·ªÉ t·∫≠p vi·∫øt');
        handleWritingComplete();
        return;
    }

    document.getElementById('option-buttons').style.display = 'none';
    document.getElementById('word-scramble-game').style.display = 'none';
    document.getElementById('scrambled-buttons').style.display = 'none';
    document.getElementById('writing-container').style.display = 'block';
    document.getElementById('question').style.display = 'none';
    document.getElementById('pinyin-container').style.display = 'none';

    document.getElementById('meaning').innerText = currentQuestion.nghia ? currentQuestion.nghia.replace(/\|/g, '\n') : '';
    document.getElementById('meaning-container').style.display = showMeaning ? 'block' : 'none';

    if (quizType === 'dialogue') {
        document.getElementById('dialogue-display').style.display = 'block';
        updateDialogueContainer();
    }

    if (currentQuestion.linkmp3) {
        setupAudio(document.getElementById('audio'), currentQuestion.linkmp3, currentQuestion.time);
        playCurrentAudio(() => {});
    }

    updateWritingChar();
}

function updateWritingChar() {
    const canvas = document.getElementById('writing-canvas');
    canvas.innerHTML = '';
    document.getElementById('writing-progress').innerText = `Ch·ªØ ${currentCharIndex + 1}/${writingChars.length}`;

    // X√≥a n√∫t Hi·ªán/·∫®n c≈© (n·∫øu c√≥)
    const writingContainer = document.getElementById('writing-container');
    const existingToggleButton = writingContainer.querySelector('.toggle-outline-button');
    if (existingToggleButton) existingToggleButton.remove();

    // T·∫°o n√∫t Hi·ªán/·∫®n
    const toggleButton = document.createElement('button');
    toggleButton.className = 'toggle-outline-button';
    toggleButton.innerText = showOutline ? '·∫®n' : 'Hi·ªán';
    toggleButton.style.fontSize = '14px';
    toggleButton.style.padding = '5px 10px';
    toggleButton.style.borderRadius = '5px';
    toggleButton.style.backgroundColor = '#2196F3';
    toggleButton.style.color = 'white';
    toggleButton.style.border = 'none';
    toggleButton.style.cursor = 'pointer';
    toggleButton.style.marginRight = '10px'; // Kho·∫£ng c√°ch b√™n ph·∫£i (thay v√¨ margin-left)
	toggleButton.style.fontFamily = 'Noto Sans CJK SC, Arial, sans-serif';
    toggleButton.style.verticalAlign = 'middle';
    toggleButton.style.width = '70px'; // K√≠ch th∆∞·ªõc ngang c·ªë ƒë·ªãnh
    toggleButton.style.height = '30px'; // K√≠ch th∆∞·ªõc cao c·ªë ƒë·ªãnh

    // Th√™m n√∫t tr∆∞·ªõc writing-progress
    const progressSpan = document.getElementById('writing-progress');
    const inlineContainer = document.createElement('span');
    inlineContainer.style.display = 'inline';
    inlineContainer.appendChild(toggleButton);
    progressSpan.parentNode.insertBefore(inlineContainer, progressSpan);

    // H√†m kh·ªüi t·∫°o Hanzi Writer
    function initializeWriter() {
        try {
            writer = HanziWriter.create('writing-canvas', writingChars[currentCharIndex], {
                width: 200,
                height: 200,
                padding: 5,
                drawingWidth: 40,
                showHintAfterMisses: 1,
                radicalColor: '#337ab7', // blue
                showOutline: showOutline,
                showCharacter: false,
                highlightOnComplete: true,
                onCorrectStroke: function(strokeData) {
                    console.log('N√©t ƒë√∫ng:', strokeData);
                },
                onMistake: function(strokeData) {
                    console.log('N√©t sai:', strokeData);
                    document.getElementById('feedback').innerText = 'N√©t ch∆∞a ƒë√∫ng, ti·∫øp t·ª•c v·∫Ω!';
                    document.getElementById('feedback').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('feedback').style.display = 'none';
                    }, 1000);
                }
            });

            // B·∫Øt ƒë·∫ßu quiz
            writer.quiz({
                onComplete: function(summaryData) {
                    console.log('Ho√†n th√†nh k√Ω t·ª±:', summaryData);
                    document.getElementById('feedback').innerText = 'ƒê√£ ho√†n th√†nh k√Ω t·ª±!';
                    document.getElementById('feedback').style.display = 'block';

// Award 1 EXP for each completed character
                    earnedEXP += 2;
                    document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;

                    currentScrambleAnswer += writingChars[currentCharIndex];
                    setTimeout(() => {
                        document.getElementById('feedback').style.display = 'none';
                        currentCharIndex++;
                        if (currentCharIndex < writingChars.length) {
                            updateWritingChar();
                            if (quizType === 'dialogue') {
                                updateDialogueContainer();
                            }
                        } else {
                            handleWritingComplete();
                        }
                    }, 1000);
                }
            });
        } catch (error) {
            console.error('L·ªói khi kh·ªüi t·∫°o Hanzi Writer:', error);
            document.getElementById('feedback').innerText = 'Kh√¥ng th·ªÉ hi·ªÉn th·ªã k√Ω t·ª± n√†y ƒë·ªÉ t·∫≠p vi·∫øt!';
            document.getElementById('feedback').style.display = 'block';
            currentScrambleAnswer += writingChars[currentCharIndex];

// Award 1 EXP even if HanziWriter fails to initialize
            earnedEXP += 1;
            document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;

            setTimeout(() => {
                document.getElementById('feedback').style.display = 'none';
                currentCharIndex++;
                if (currentCharIndex < writingChars.length) {
                    updateWritingChar();
                    if (quizType === 'dialogue') {
                        updateDialogueContainer();
                    }
                } else {
                    handleWritingComplete();
                }
            }, 1000);
        }
    }

    // Kh·ªüi t·∫°o Hanzi Writer l·∫ßn ƒë·∫ßu
    initializeWriter();

    // X·ª≠ l√Ω s·ª± ki·ªán nh·∫•n n√∫t Hi·ªán/·∫®n
    toggleButton.onclick = function() {
        showOutline = !showOutline;
        console.log('showOutline:', showOutline);
        toggleButton.innerText = showOutline ? '·∫®n' : 'Hi·ªán';
        try {
            writer.setOutlineVisibility(showOutline);
        } catch (error) {
            console.warn('setOutlineVisibility kh√¥ng ho·∫°t ƒë·ªông, kh·ªüi t·∫°o l·∫°i Writer:', error);
            canvas.innerHTML = '';
            initializeWriter();
        }
    };
}

function handleWritingComplete() {
    if (quizType === 'dialogue') {
        updateDialogueContainer();
    }

    document.getElementById('feedback').innerText = 'T·ªët l·∫Øm, b·∫°n ƒë√£ ho√†n th√†nh c√¢u!';
    document.getElementById('feedback').style.display = 'block';
    document.getElementById('writing-container').style.display = 'none';
    if (timerInterval) clearInterval(timerInterval);

    const questionElement = document.getElementById('question');
    const pinyinElement = document.getElementById('pinyin');
    const kyhieuElement = document.getElementById('kyhieu');
    const pinyinContainer = document.getElementById('pinyin-container');
    const phanTichElement = document.getElementById('phanTich');
    const phanTichContainer = document.getElementById('phanTich-container');
    const meaningContainer = document.getElementById('meaning-container');
    const readCompleteContainer = document.getElementById('read-complete-container');

    questionElement.innerText = currentQuestion.hanzi.replace(/\|/g, '\n');
    pinyinElement.innerText = currentQuestion.pinyin ? currentQuestion.pinyin.replace(/\|/g, '\n') : hanziToPinyin(currentQuestion.hanzi);
    kyhieuElement.innerText = currentQuestion.kyhieu ? currentQuestion.kyhieu.replace(/\|/g, '\n') : '';
    questionElement.style.display = 'block';
    pinyinElement.style.display = 'block';
    kyhieuElement.style.display = currentQuestion.kyhieu ? 'block' : 'none';
    pinyinContainer.style.display = 'flex';
    meaningContainer.style.display = 'block';
    if (quizType === 'vocabulary') {
        showAnalysis();
        phanTichContainer.style.display = 'block';
        phanTichElement.style.display = 'block';
       earnedEXP += 0; // 3 ƒëi·ªÉm cho T·ª´ V·ª±ng
document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
    } else if (quizType === 'sentence') {
        earnedEXP += 0; // 10 ƒëi·ªÉm cho M·∫´u C√¢u
document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
    } else if (quizType === 'dialogue') {
        earnedEXP += 0; // 10 ƒëi·ªÉm cho m·ªói c√¢u H·ªôi Tho·∫°i
document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
    }

    const nextAction = () => {
        document.getElementById('feedback').style.display = 'none';
        pinyinElement.style.display = 'none';
        kyhieuElement.style.display = 'none';
        pinyinContainer.style.display = 'none';
        phanTichContainer.style.display = 'none';
        phanTichElement.style.display = 'none';
        questionElement.style.display = 'none';
        readCompleteContainer.style.display = 'none';
        meaningContainer.style.display = showMeaning ? 'block' : 'none';
        document.getElementById('answerInput').value = '';
        document.getElementById('answerInput').disabled = false;
        document.getElementById('inputPinyinDisplay').textContent = '';

        currentScrambleAnswer = '';
        currentCharIndex = 0;

        questionCount++;
        if (questionCount < selectedHanzi.length) {
            currentQuestion = selectedHanzi[questionCount];
            if (quizType === 'dialogue') {
                updateDialogueContainer();
            }
            if (isWritingMode) {
                startWritingMode();
            } else {
                loadNewQuestion();
            }
        } else {
            endGame();
        }
    };

    if (isNewWordMode) {
        readCompleteContainer.style.display = 'block';
        const readCompleteButton = document.getElementById('read-complete-button');
        readCompleteButton.onclick = () => {
            playCurrentAudio(nextAction);
        };
    } else {
        playCurrentAudio(nextAction);
    }
}

function stopWritingMode() {
    isWritingMode = false;
    document.getElementById('writing-container').style.display = 'none';
    
    if (quizType === 'sentence') {
        document.getElementById('dialogue-display').style.display = 'none';
        document.getElementById('option-buttons').style.display = 'grid';
        document.getElementById('meaning-container').style.display = showMeaning ? 'block' : 'none';
        document.getElementById('back-button').style.display = 'none';
        document.getElementById('next-button').style.display = 'none';
        loadNewQuestion();
    } else if (quizType === 'dialogue') {
        document.getElementById('dialogue-display').style.display = 'block';
        document.getElementById('option-buttons').style.display = 'none';
        document.getElementById('back-button').style.display = 'inline-block';
        document.getElementById('next-button').style.display = 'inline-block';
        updateDialogueContainer();
    } else {
        document.getElementById('option-buttons').style.display = 'grid';
        document.getElementById('meaning-container').style.display = showMeaning ? 'block' : 'none';
        loadNewQuestion();
    }
}

    const dataUrls = {
        taiwanese: {
            vocabulary: '/hoctiengtrung/json/hanzi4.json',
            sentence: '/hoctiengtrung/json/maucau21.json',
            dialogue: '/hoctiengtrung/json/hoithoai4-new14.json'
        },
        poetry: {
            vocabulary: '/hoctiengtrung/json/tamtukinh-tuvung5.json',
            sentence: '/hoctiengtrung/json/maucau21.json',
            dialogue: '/hoctiengtrung/json/tamtukinh7.json'
        },
        samtukinh: {
            vocabulary: '/hoctiengtrung/json/tamtukinh-tuvung5.json',
            sentence: '/hoctiengtrung/json/maucau21.json',
            dialogue: '/hoctiengtrung/json/tamtukinh7.json'
        },
        thientuvan: {
            vocabulary: '/hoctiengtrung/json/tamtukinh-tuvung5.json',
            sentence: '/hoctiengtrung/json/maucau21.json',
            dialogue: '/hoctiengtrung/json/tamtukinh7.json'
        },
        hongngam: {
            vocabulary: '/hoctiengtrung/json/tamtukinh-tuvung5.json',
            sentence: '/hoctiengtrung/json/maucau21.json',
            dialogue: '/hoctiengtrung/json/tamtukinh7.json'
        }
    };

const quizTypeDisplayNames = {
    vocabulary: 'T·ª´ V·ª±ng',
    sentence: 'M·∫´u C√¢u',
    dialogue: {
        taiwanese: 'H·ªôi Tho·∫°i',
        samtukinh: 'B√†i Th∆°',
        thoduong: 'B√†i Th∆°',
        hongngam: 'B√†i Th∆°'
    }
};

const modeDisplayNames = {
    taiwanese: 'Ti·∫øng Trung ƒê√†i Loan',
    poetry: '300 B√†i Th∆° ƒê∆∞·ªùng',
    samtukinh: 'Tam T·ª± Kinh',
    thientuvan: 'Thi√™n T·ª± VƒÉn',
    hongngam: 'H·ªìng Ng√¢m'
};


    function loadInitialData() {
    console.log('Loading data for mode:', selectedMode); // Debug
    fetch(dataUrls[selectedMode].dialogue)
        .then(response => {
            if (!response.ok) throw new Error(`Kh√¥ng th·ªÉ t·∫£i ${dataUrls[selectedMode].dialogue}`);
            return response.json();
        })
        .then(data => {
            dialogueData = data;
            console.log('Dialogue data loaded:', dialogueData); // Debug
        })
        .catch(error => {
            console.error(`L·ªói khi load ${dataUrls[selectedMode].dialogue}:`, error);
            alert(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu h·ªôi tho·∫°i/b√†i th∆° cho ${modeDisplayNames[selectedMode]}!`);
        });

    fetch(dataUrls[selectedMode].vocabulary)
        .then(response => {
            if (!response.ok) throw new Error(`Kh√¥ng th·ªÉ t·∫£i ${dataUrls[selectedMode].vocabulary}`);
            return response.json();
        })
        .then(data => {
            hanzi3Data = data;
            console.log('Vocabulary data loaded:', hanzi3Data); // Debug
        })
        .catch(error => {
            console.error(`L·ªói khi load ${dataUrls[selectedMode].vocabulary}:`, error);
            document.getElementById('start-screen').innerHTML += '<p style="color: red;">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ v·ª±ng!</p>';
        });

    fetch('/hoctiengtrung/json/banghanTu7.json')
        .then(response => response.json())
        .then(data => {
            bangHanTuData = data;
        })
        .catch(error => {
            console.error('L·ªói khi load _banghanTu.json:', error);
        });

    fetch('/hoctiengtrung/json/pinyintudien2.json')
        .then(response => response.json())
        .then(data => {
            pinyinTuDienData = data;
        })
        .catch(error => {
            console.error('L·ªói khi load _pinyin_tudien.json:', error);
        });
}

document.querySelectorAll('.mode-button').forEach(button => {
    button.addEventListener('click', () => {
        if (button.classList.contains('disabled') || button.hasAttribute('disabled')) {
            return;
        }

        document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        selectedMode = button.getAttribute('data-mode');
        console.log('Selected mode:', selectedMode); // Debug

        // Load d·ªØ li·ªáu ngay khi ch·ªçn ch·∫ø ƒë·ªô
        loadInitialData();

        const quizTypeButtonsContainer = document.getElementById('quiz-type-buttons');
        quizTypeButtonsContainer.innerHTML = '';
        quizTypeButtonsContainer.style.display = 'flex';

        function createQuizTypeButton(text, value) {
            const btn = document.createElement('button2');
            btn.className = 'quiz-type-button';
            btn.textContent = text;
            btn.setAttribute('data-quiz-type', value);
            btn.addEventListener('click', () => {
                quizType = value;

                // X√≥a class active kh·ªèi c√°c n√∫t quiz-type-button kh√°c
                document.querySelectorAll('.quiz-type-button').forEach(b => b.classList.remove('quiz-type-active'));
                // Th√™m class active cho n√∫t ƒë∆∞·ª£c ch·ªçn
                btn.classList.add('quiz-type-active');

                // X√≥a c√°c n√∫t ph·ª• tr∆∞·ªõc ƒë√≥ (n·∫øu c√≥)
                const existingSubModeContainer = document.getElementById('sub-mode-buttons');
                if (existingSubModeContainer) {
                    existingSubModeContainer.remove();
                }

                // N·∫øu l√† T·ª´ V·ª±ng ho·∫∑c M·∫´u C√¢u, hi·ªÉn th·ªã n√∫t ph·ª• b√™n d∆∞·ªõi tr√™n c√πng h√†ng ngang
                if (value === 'vocabulary' || value === 'sentence') {
    const subModeContainer = document.createElement('div');
    subModeContainer.id = 'sub-mode-buttons';
    subModeContainer.style.display = 'flex';
    subModeContainer.style.flexDirection = 'row'; // S·∫Øp x·∫øp ngang
    subModeContainer.style.justifyContent = 'center';
    subModeContainer.style.gap = '10px';
    subModeContainer.style.marginTop = '10px';
	
	const reviewBtn = document.createElement('button2');
    reviewBtn.className = 'quiz-type-button sub-mode-button'; // Th√™m class sub-mode-button
    reviewBtn.textContent = '√în T·∫≠p';
    reviewBtn.addEventListener('click', () => {
        isNewWordMode = false;
        startQuizMode();
    });

    const learnNewBtn = document.createElement('button2');
    learnNewBtn.className = 'quiz-type-button sub-mode-button'; // Th√™m class sub-mode-button
    learnNewBtn.textContent = 'H·ªçc';
    learnNewBtn.addEventListener('click', () => {
        isNewWordMode = true;
        startQuizMode();
    });
	
    subModeContainer.appendChild(reviewBtn);
    subModeContainer.appendChild(learnNewBtn);
    
    quizTypeButtonsContainer.appendChild(subModeContainer);
                } else {
                    startQuizMode();
                }
            });
            quizTypeButtonsContainer.appendChild(btn);
        }

        if (selectedMode === 'taiwanese') {
            createQuizTypeButton('1.H·ªôi Tho·∫°i', 'dialogue');
            createQuizTypeButton('2.T·ª´ V·ª±ng', 'vocabulary');
            createQuizTypeButton('3.M·∫´u C√¢u', 'sentence');
        } else if (selectedMode === 'samtukinh') {
            createQuizTypeButton('1.B√†i Th∆°', 'dialogue');
            createQuizTypeButton('2.T·ª´ V·ª±ng', 'vocabulary');
        } else if (selectedMode === 'poetry') {
            createQuizTypeButton('1.B√†i Th∆°', 'dialogue');
            createQuizTypeButton('2.T·ª´ V·ª±ng', 'vocabulary');
        } else if (selectedMode === 'hongngam') {
            createQuizTypeButton('1.B√†i Th∆°', 'dialogue');
            createQuizTypeButton('2.T·ª´ V·ª±ng', 'vocabulary');
        }
    });
});

// H√†m chuy·ªÉn sang m√†n h√¨nh kh·ªüi ƒë·ªông (gi·ªØ nguy√™n)
function startQuizMode() {
    document.getElementById('mode-selection-screen').style.display = 'none';
    document.getElementById('start-screen').style.display = 'block';

    const welcomeDiv = document.getElementById('start-screen').querySelector('.welcome-title');
    let quizTypeName = quizTypeDisplayNames[quizType];
    if (quizType === 'dialogue') {
        quizTypeName = quizTypeDisplayNames.dialogue[selectedMode] || 'H·ªôi Tho·∫°i';
    }
    welcomeDiv.textContent = `${quizTypeName} \n ${modeDisplayNames[selectedMode]} `;

    const dialogueContainer = document.getElementById('dialogue-select-container');
    const dialogueLabel = dialogueContainer.querySelector('label[for="dialogue-number"]');
    dialogueContainer.style.display = (quizType === 'dialogue' && selectedMode === 'taiwanese') ? 'block' : 'none';
    dialogueLabel.textContent = selectedMode === 'taiwanese' ? 'Ch·ªçn H·ªôi tho·∫°i:' : 'Ch·ªçn Ph·∫ßn Th∆°:';

    const wordCountContainer = document.getElementById('word-count-container');
    const timeLimitContainer = document.getElementById('time-limit-container');
    if (quizType === 'dialogue') {
        wordCountContainer.style.display = 'none';
        timeLimitContainer.style.display = 'none';
    } else {
        wordCountContainer.style.display = 'block';
        timeLimitContainer.style.display = 'block';
    }

// T·∫°o nhi·ªám v·ª• ng·∫´u nhi√™n
    generateRandomMission();
}

    document.getElementById('start-button').addEventListener('click', () => {
    const jsonFile = quizType === "vocabulary" ? dataUrls[selectedMode].vocabulary : dataUrls[selectedMode].sentence;

    if (quizType === 'dialogue') {
        jsonData = [];
        allWords = [];
        startGame();
    } else {
        fetch(jsonFile)
            .then(response => {
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu JSON');
                return response.json();
            })
            .then(data => {
                jsonData = data;
                allWords = data;
                startGame();
            })
            .catch(error => {
                console.error('L·ªói khi load JSON:', error);
                alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i!');
            });
    }
});

    
    function getAllPinyinCombinations(hanzi) {
        const cleanHanzi = hanzi.replace(/[.,!?Ôºå„ÄÇÔºÅÔºü]/g, '');
        const chars = cleanHanzi.split('');
        let pinyinArrays = [];
        
        chars.forEach(char => {
            const pinyinOptions = pinyinTuDienData[char];
            if (pinyinOptions) {
                pinyinArrays.push(pinyinOptions.split(','));
            } else {
                pinyinArrays.push(['']);
            }
        });
        
        let combinations = [''];
        pinyinArrays.forEach(options => {
            let newCombinations = [];
            combinations.forEach(combo => {
                options.forEach(option => {
                    newCombinations.push(combo ? `${combo} ${option}` : option);
                });
            });
            combinations = newCombinations;
        });
        
        return combinations;
    }

    function hanziToPinyin(hanzi) {
        const cleanHanzi = hanzi.replace(/[.,!?Ôºå„ÄÇÔºÅÔºü]/g, '');
        const chars = cleanHanzi.split('');
        let pinyinResult = [];
        
        chars.forEach(char => {
            const pinyinOptions = pinyinTuDienData[char];
            if (pinyinOptions) {
                const firstPinyin = pinyinOptions.split(',')[0];
                pinyinResult.push(firstPinyin);
            } else {
                pinyinResult.push('');
            }
        });
        
        return pinyinResult.join(' ').trim();
    }

    function isPinyinMatch(inputPinyin, questionPinyinOptions) {
        if (!inputPinyin) return false;
        return questionPinyinOptions.some(option => option === inputPinyin);
    }

    function showAnalysis() {
        let hanziAnalysis = '';
        let phanTichText = currentQuestion.phanTich ? currentQuestion.phanTich.replace(/\|/g, '\n') : '';
        const hanziChars = currentQuestion.hanzi.replace(/[.,!?Ôºå„ÄÇÔºÅÔºü]/g, '').split('');
        hanziChars.forEach(char => {
            const hanTuInfo = bangHanTuData.find(item => item.hanTu === char);
            if (hanTuInfo) {
                const cauTaoFormatted = hanTuInfo.cauTao.replace(/\|/g, '\n');
                hanziAnalysis += `<b>+ H√°n T·ª±:</b> ${hanTuInfo.hanTu}\n<span style="color: blue;">${cauTaoFormatted}</span>\n`;
            }
        });
        const phanTichElement = document.getElementById('phanTich');
        const phanTichContainer = document.getElementById('phanTich-container');
        let finalContent = '';
        if (hanziAnalysis) finalContent += hanziAnalysis;
        if (phanTichText) finalContent += `<span style="color: red;"><b>+ Ph√¢n T√≠ch Chung:</b></span>\n${phanTichText}`;
        phanTichElement.innerHTML = finalContent;
        if (finalContent.trim()) {
            phanTichContainer.style.display = 'block';
            phanTichElement.style.display = 'block';
        } else {
            phanTichContainer.style.display = 'none';
            phanTichElement.style.display = 'none';
        }
    }

    function hideAllPanels() {
        document.getElementById('menuContainer').style.display = 'none';
        document.getElementById('searchContainer').style.display = 'none';
        document.getElementById('hanziiContainer').style.display = 'none';
        document.getElementById('translateContainer').style.display = 'none';
        relatedHanziList.style.display = 'none';
    }

    function toggleRelated() {
        if (relatedHanziList.style.display === 'block') {
            relatedHanziList.style.display = 'none';
        } else {
            hideAllPanels();
            showRelatedHanzi();
            relatedHanziList.style.display = 'block';
        }
    }

    function toggleMenu() {
        const menu = document.getElementById('menuContainer');
        if (menu.style.display === 'block') {
            menu.style.display = 'none';
        } else {
            hideAllPanels();
            menu.style.display = 'block';
            if (!document.getElementById('volumeButtons').innerHTML) {
                createVolumeButtons();
            }
        }
    }

    function createVolumeButtons() {
        const volumeDiv = document.getElementById('volumeButtons');
        volumeDiv.innerHTML = '';
        for (let i = 1; i <= 6; i++) {
            const btn = document.createElement('button2');
            btn.textContent = `Quy·ªÉn ${i}`;
            btn.className = 'volume-btn';
            btn.onclick = () => {
                if (selectedVolume !== i) {
                    selectVolume(i);
                }
            };
            volumeDiv.appendChild(btn);
        }
    }

    function selectVolume(volume) {
        selectedVolume = volume;
        updateButtonStates();
        createLessonButtons(volume);
    }

    function createLessonButtons(volume) {
        const lessonDiv = document.getElementById('lessonButtons');
        lessonDiv.innerHTML = '';
        const lessonCounts = [15, 15, 12, 12, 10, 10];
        const lessonCount = lessonCounts[volume - 1];
        
        for (let i = 1; i <= lessonCount; i++) {
            const btn = document.createElement('button2');
            btn.textContent = `B√†i ${i}`;
            btn.className = 'lesson-btn';
            btn.onclick = () => {
                if (selectedLesson !== i) {
                    selectLesson(i);
                }
            };
            lessonDiv.appendChild(btn);
        }
        updateButtonStates();
    }

    function selectLesson(lesson) {
        selectedLesson = lesson;
        updateButtonStates();
        const baiValue = calculateBaiValue(selectedVolume, selectedLesson);
        loadLessonData(baiValue);
    }

    function calculateBaiValue(volume, lesson) {
        switch (volume) {
            case 1: return lesson;
            case 2: return 15 + lesson;
            case 3: return 15 + 15 + lesson;
            case 4: return 15 + 15 + 12 + lesson;
            case 5: return 15 + 15 + 12 + 12 + lesson;
            case 6: return 15 + 15 + 12 + 12 + 10 + lesson;
        }
    }

    function updateButtonStates() {
        const volumeButtons = document.querySelectorAll('.volume-btn');
        const lessonButtons = document.querySelectorAll('.lesson-btn');
        
        volumeButtons.forEach((btn, index) => {
            btn.classList.toggle('active', index + 1 === selectedVolume);
        });
        
        lessonButtons.forEach((btn, index) => {
            btn.classList.toggle('active', index + 1 === selectedLesson);
        });
    }

    function loadLessonData(baiValue) {
        const tableContainer = document.getElementById('tableContainer');
        const filteredData = hanzi3Data.filter(item => parseInt(item.bai) === baiValue);
        
        let tableHTML = `
            <table>
                <tr>
                    <th>ID</th>
                    <th>H√°n t·ª±</th>
                    <th>Pinyin</th>
                    <th>K√Ω hi·ªáu</th>
                    <th>Nghƒ©a</th>
                </tr>
        `;
        
        filteredData.forEach(item => {
            tableHTML += `
                <tr onclick="selectHanzi('${item.hanzi}')">
                    <td>${item.id}</td>
                    <td>${item.hanzi}</td>
                    <td>${item.pinyin}</td>
                    <td>${item.kyhieu}</td>
                    <td>${item.nghia}</td>
                </tr>
            `;
        });
        
        tableHTML += '</table>';
        tableContainer.innerHTML = tableHTML;
    }

    function updateHanzi(hanzi) {
        giatrihanzi = hanzi;
        console.log('Selected hanzi:', giatrihanzi);
        const hanziiContainer = document.getElementById('hanziiContainer');
        const hanziiIframe = document.getElementById('hanziiIframe');
        
        if (hanziiContainer.style.display === 'block' && giatrihanzi === hanzi) {
            hanziiContainer.style.display = 'none';
        } else {
            hideAllPanels();
            hanziiIframe.src = `https://hanzii.net/search/kanji/${encodeURIComponent(giatrihanzi)}?hl=vi`;
            hanziiContainer.style.display = 'block';
        }
    }

    function selectHanzi(hanzi) {
        updateHanzi(hanzi);
    }

   document.addEventListener('click', function(event) {
    const infoPopup = document.getElementById('info-popup');
    const nestedInfoPopup = document.getElementById('nested-info-popup');
    const authorPopup = document.getElementById('author-popup');
    
    // Ki·ªÉm tra n·∫øu info-popup ƒëang hi·ªÉn th·ªã v√† nh·∫•p chu·ªôt b√™n ngo√†i
    if (infoPopup.style.display === 'block' && !infoPopup.contains(event.target)) {
        closeInfoPopup();
    }
    
    // Ki·ªÉm tra n·∫øu nested-info-popup ƒëang hi·ªÉn th·ªã v√† nh·∫•p chu·ªôt b√™n ngo√†i
    if (nestedInfoPopup.style.display === 'block' && !nestedInfoPopup.contains(event.target)) {
        closeNestedInfoPopup();
    }
    
    // Ki·ªÉm tra n·∫øu author-popup ƒëang hi·ªÉn th·ªã v√† nh·∫•p chu·ªôt b√™n ngo√†i
    if (authorPopup.style.display === 'block' && !authorPopup.contains(event.target)) {
        closeAuthorPopup();
    }
});

    function toggleSearch() {
        const searchContainer = document.getElementById('searchContainer');
        const searchInput = document.getElementById('searchInput');
        if (searchContainer.style.display === 'block') {
            searchContainer.style.display = 'none';
        } else {
            hideAllPanels();
            searchContainer.style.display = 'block';
            searchInput.value = currentQuestion.hanzi;
        }
    }

    function searchHanzi() {
        const input = document.getElementById('searchInput').value.trim();
        if (input) {
            updateHanzi(input);
        }
    }

    function toggleTranslate() {
        const translateContainer = document.getElementById('translateContainer');
        const translateIframe = document.getElementById('translateIframe');
        if (translateContainer.style.display === 'block') {
            translateContainer.style.display = 'none';
        } else {
            hideAllPanels();
            translateIframe.src = 'https://vi.ilovetranslation.com/';
            translateContainer.style.display = 'block';
        }
    }

    function timeToSeconds(timeStr) {
    try {
        timeStr = timeStr.trim();
        if (!/^\d+:\d{2}:\d{2,3}$/.test(timeStr)) {
            throw new Error("ƒê·ªãnh d·∫°ng th·ªùi gian kh√¥ng ƒë√∫ng, y√™u c·∫ßu ph√∫t:gi√¢y:ph·∫ßn_trƒÉm_gi√¢y ho·∫∑c ph√∫t:gi√¢y:milliseconds");
        }
        const [minutes, seconds, subseconds] = timeStr.split(':').map(Number);
        if (isNaN(minutes) || isNaN(seconds) || isNaN(subseconds)) {
            throw new Error("Gi√° tr·ªã th·ªùi gian kh√¥ng h·ª£p l·ªá");
        }
        if (seconds >= 60) {
            throw new Error("Gi√° tr·ªã gi√¢y kh√¥ng h·ª£p l·ªá");
        }
        const divisor = subseconds >= 100 ? 1000 : 100; // Centiseconds ho·∫∑c milliseconds
        return minutes * 60 + seconds + subseconds / divisor;
    } catch (error) {
        console.error("L·ªói x·ª≠ l√Ω th·ªùi gian:", error.message, "Chu·ªói th·ªùi gian:", timeStr);
        return 0;
    }
}

function setupAudio(audioElement, link, timeRange) {
    audioElement.src = link;
    audioElement.preload = 'auto';
    if (timeRange && timeRange.includes(' - ')) {
        const [startTimeStr, endTimeStr] = timeRange.split(' - ');
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const startOffset = isSafari ? 0.15 : 0.1; // B√π t√πy tr√¨nh duy·ªát
        audioStartTime = Math.max(0, timeToSeconds(startTimeStr) - startOffset);
        audioEndTime = timeToSeconds(endTimeStr);
        audioElement.addEventListener('loadedmetadata', () => {
            audioElement.currentTime = audioStartTime;
            audioElement.play().catch(error => {
                console.error("L·ªói ph√°t audio:", error);
            });
        }, { once: true });
    }
}

function playCurrentAudio(callback) {
    const audio = document.getElementById('audio');
    audio.onended = () => {
        callback();
    };
    const checkEndTime = () => {
        if (audio.currentTime >= audioEndTime - 0.05) {
            audio.pause();
            audio.currentTime = audioStartTime;
            callback();
            return false;
        }
        return true;
    };
    audio.addEventListener('timeupdate', function handler() {
        if (!checkEndTime()) {
            audio.removeEventListener('timeupdate', handler);
        }
    });
    const interval = setInterval(() => {
        if (!checkEndTime()) {
            clearInterval(interval);
        }
    }, 10);
}

    const audio = document.getElementById('audio');
    const playButton = document.getElementById('playButton');
    let isHintVisible = false;
    const hintButton = document.getElementById('hintButton');

    hintButton.addEventListener('click', function() {
    const questionElement = document.getElementById('question');
    const pinyinElement = document.getElementById('pinyin');
    const kyhieuElement = document.getElementById('kyhieu');
    const pinyinContainer = document.getElementById('pinyin-container');
    const phanTichElement = document.getElementById('phanTich');
    const phanTichContainer = document.getElementById('phanTich-container');
    const meaningContainer = document.getElementById('meaning-container');
    const dialogueDisplay = document.getElementById('dialogue-display');

    if (isHintVisible) {
        pinyinElement.style.display = 'none';
        kyhieuElement.style.display = 'none';
        pinyinContainer.style.display = 'none';
        phanTichElement.style.display = 'none';
        phanTichContainer.style.display = 'none';
        questionElement.style.display = 'none';
        meaningContainer.style.display = showMeaning ? 'block' : 'none';
        if (quizType === 'dialogue' && !isScrambleMode) {
            dialogueDisplay.style.display = 'block';
        }
        isHintVisible = false;
    } else {
        questionElement.innerText = currentQuestion.hanzi.replace(/\|/g, '\n');
        pinyinElement.innerText = currentQuestion.pinyin ? currentQuestion.pinyin.replace(/\|/g, '\n') : '';
        kyhieuElement.innerText = currentQuestion.kyhieu ? currentQuestion.kyhieu.replace(/\|/g, '\n') : '';
        if (quizType === 'vocabulary') showAnalysis();
        
        // Hi·ªÉn th·ªã H√°n t·ª± trong m·ªçi ch·∫ø ƒë·ªô
        questionElement.style.display = 'block';
        
        // Hi·ªÉn th·ªã pinyin v√† k√Ω hi·ªáu n·∫øu c√≥
        pinyinElement.style.display = currentQuestion.pinyin ? 'block' : 'none';
        kyhieuElement.style.display = currentQuestion.kyhieu ? 'block' : 'none';
        
        // Hi·ªÉn th·ªã pinyinContainer n·∫øu c√≥ pinyin ho·∫∑c k√Ω hi·ªáu, ho·∫∑c trong H·ªôi Tho·∫°i ƒë·ªÉ ch·ª©a H√°n t·ª±
        pinyinContainer.style.display = (currentQuestion.pinyin || currentQuestion.kyhieu || quizType === 'dialogue') ? 'flex' : 'none';
        
        // X·ª≠ l√Ω ph√¢n t√≠ch cho T·ª´ V·ª±ng
        if (quizType === 'vocabulary') {
            phanTichContainer.style.display = 'block';
            phanTichElement.style.display = 'block';
        } else {
            phanTichContainer.style.display = 'none';
            phanTichElement.style.display = 'none';
        }
        
        meaningContainer.style.display = 'block';
        if (quizType === 'dialogue') {
            dialogueDisplay.style.display = 'block';
        }
        isHintVisible = true;
    }
});

    playButton.addEventListener('click', function() {
    if (currentQuestion.linkmp3) {
        setupAudio(audio, currentQuestion.linkmp3, currentQuestion.time);
        playCurrentAudio(() => {});
    } else {
        console.warn('Kh√¥ng c√≥ linkmp3 ƒë·ªÉ ph√°t:', currentQuestion);
    }
});

    function showRelatedHanzi() {
        const hanzi = currentQuestion.hanzi;
        const characters = hanzi.split('');
        const relatedWords = allWords.filter(word => 
            characters.some(char => word.hanzi.includes(char)) && word.hanzi !== hanzi
        );

        relatedHanziList.innerHTML = '';
        if (relatedWords.length === 0) {
            relatedHanziList.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y hanzi li√™n quan.</p>';
        } else {
            relatedWords.forEach(word => {
                const p = document.createElement('p');
                p.innerText = `${word.id}. ${word.hanzi} (${word.pinyin}): ${word.nghia} | B√†i: ${word.bai}`;
                relatedHanziList.appendChild(p);
            });
        }
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function updateStatus() {
        document.getElementById('wrong-count').innerText = `S·ªë t·ª´ b·ªã sai: ${wrongHanzi.length}`;
        document.getElementById('total-count').innerText = `T·ªïng s·ªë t·ª´: ${totalWords - questionCount}`;
        document.getElementById('review-mode').style.display = isReviewMode ? 'inline' : 'none';
    }

    function getUniqueWrongOptions(currentHanzi, sourceArray, count) {
        const filtered = sourceArray.filter(item => item.hanzi !== currentHanzi);
        const shuffled = shuffle([...filtered]);
        return shuffled.slice(0, Math.min(count, shuffled.length));
    }

    let totalWords = 0;

    function loadNewQuestion() {
	
	// ·∫®n h√¨nh ·∫£nh h·ªôi tho·∫°i n·∫øu kh√¥ng ph·∫£i ch·∫ø ƒë·ªô dialogue
const dialogueImage = document.getElementById('dialogue-image');
if (quizType !== 'dialogue') {
    dialogueImage.style.display = 'none';
}

    currentScrambleAnswer = '';
    document.getElementById('diceButton').disabled = false;
    relatedHanziList.style.display = 'none';
    document.getElementById('question').style.display = 'none';
    document.getElementById('pinyin-container').style.display = 'none';
    document.getElementById('pinyin').style.display = 'none';
    document.getElementById('kyhieu').style.display = 'none';

    const phanTichContainer = document.getElementById('phanTich-container');
    const relatedBtn = document.querySelector('.related-btn');
    const infoButton = document.getElementById('infoButton');
    const authorButton = document.getElementById('authorButton');

    infoButton.style.display = 'none';
    authorButton.style.display = 'none';
    // X√≥a d√≤ng n√†y: relatedBtn.style.display = 'inline-block';
    phanTichContainer.style.display = 'none';

    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã n√∫t üîç v√† üîó
    updateButtonVisibility();

    // ƒê·∫£m b·∫£o status-container hi·ªÉn th·ªã cho T·ª´ V·ª±ng v√† M·∫´u C√¢u
    const statusContainer = document.getElementById('status-container');
    if (quizType === 'vocabulary' || quizType === 'sentence') {
        statusContainer.style.display = 'flex';
    } else {
        statusContainer.style.display = 'none';
    }

    let currentList = isReviewMode ? currentReviewList.map(id => allWords.find(word => word.id === id)).filter(word => word) : selectedHanzi;

    if (quizType === 'dialogue') {
        if (questionCount >= currentList.length || questionCount < 0) {
            endGame();
            return;
        }
        currentQuestion = currentList[questionCount];
        if (!currentQuestion) {
            console.error(`Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi t·∫°i questionCount: ${questionCount}`);
            endGame();
            return;
        }

        // Hi·ªÉn th·ªã n√∫t üìã v√† üë≤ cho H·ªôi Tho·∫°i
        if (currentQuestion.thongTin) {
            infoButton.style.display = 'inline-block';
            infoButton.onclick = () => showInfoPopup(currentQuestion.thongTin);
        }
        if (currentQuestion.tacGia) {
            authorButton.style.display = 'inline-block';
            authorButton.onclick = () => showAuthorPopup(currentQuestion.tacGia);
        }

        relatedBtn.style.display = 'none';
        if (isWritingMode) {
            startWritingMode();
        } else if (isScrambleMode) {
            startScrambleGame();
        } else {
            updateDialogueContainer();
            document.getElementById('dialogue-display').style.display = 'block';
            document.getElementById('option-buttons').style.display = 'none';
            document.getElementById('meaning-container').style.display = showMeaning ? 'block' : 'none';
        }
    } else {
        // Ki·ªÉm tra ƒëi·ªÅu ki·ªán chuy·ªÉn sang ch·∫ø ƒë·ªô √¥n t·∫≠p
        if (questionCount >= maxWords || questionCount >= currentList.length) {
            if (wrongHanzi.length > 0 && !isReviewMode) {
                isReviewMode = true;
                questionCount = 0;
                currentReviewList = [...wrongHanzi];
                totalWords = currentReviewList.length;
                wrongHanzi = [];
                currentList = currentReviewList.map(id => allWords.find(word => word.id === id)).filter(word => word);
                const reviewHanziDisplay = document.getElementById('review-hanzi-display');
                const reviewHanziList = document.getElementById('review-hanzi-list');
                reviewHanziList.innerHTML = '';
                currentList.forEach(word => {
                    const li = document.createElement('li');
                    li.textContent = `ID: ${word.id}, Hanzi: ${word.hanzi}`;
                    reviewHanziList.appendChild(li);
                });
                reviewHanziDisplay.style.display = 'block';
            } else {
                endGame();
                return;
            }
        }

        currentQuestion = currentList[questionCount];
        if (!currentQuestion) {
            console.error(`Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi t·∫°i questionCount: ${questionCount}`);
            endGame();
            return;
        }

        // Hi·ªÉn th·ªã n√∫t üìã cho M·∫´u C√¢u
        if (quizType === 'sentence' && currentQuestion.thongTin) {
            infoButton.style.display = 'inline-block';
            infoButton.onclick = () => showInfoPopup(currentQuestion.thongTin);
        }

        if (quizType === 'sentence') {
            relatedBtn.style.display = 'none';
        }

        if (timerInterval) clearInterval(timerInterval);

        document.getElementById('searchInput').value = currentQuestion.hanzi;

        const meaningContainer = document.getElementById('meaning-container');
        const optionButtons = document.getElementById('option-buttons');
        const answerInput = document.getElementById('answerInput');

        document.getElementById('meaning').innerText = currentQuestion.nghia.replace(/\|/g, '\n');
        meaningContainer.style.display = showMeaning ? 'block' : 'none';
        document.getElementById('dialogue-display').style.display = 'none';

        if (isWritingMode) {
            startWritingMode();
        } else if (isScrambleMode) {
            startScrambleGame();
        } else {
            optionButtons.style.display = 'grid';
            isHintVisible = false;
            if (currentQuestion.linkmp3) {
                setupAudio(audio, currentQuestion.linkmp3, currentQuestion.time);
                if (!showMeaning) {
                    playCurrentAudio(() => {});
                }
            }

            const optionCount = quizType === "vocabulary" ? 9 : 5;
            const otherOptions = getUniqueWrongOptions(currentQuestion.hanzi, allWords, optionCount);
            const options = shuffle([currentQuestion, ...otherOptions]);

            optionButtons.innerHTML = '';
            options.forEach(option => {
                const button = document.createElement('button');
                button.innerText = option.hanzi.replace(/\|/g, '\n');
                button.style.justifyContent = quizType === "sentence" ? 'flex-start' : 'center';
                button.addEventListener('click', () => validateAnswer(button, option));
                optionButtons.appendChild(button);
            });

            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').disabled = false;
            document.getElementById('inputPinyinDisplay').textContent = '';

            timeRemaining = timeLimit;
            const timerElement = document.getElementById('timer');
            timerElement.innerText = `Th·ªùi gian: ${timeRemaining}`;
            timerInterval = setInterval(() => {
                timeRemaining--;
                timerElement.innerText = `Th·ªùi gian: ${timeRemaining}`;
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    const fakeOption = { hanzi: '' };
                    validateAnswer(null, fakeOption);
                }
            }, 1000);
        }
    }

    updateStatus();
	
}

    function validateAnswer(button, selectedOption) {
    const feedbackMessage = document.getElementById('feedback');
    const pinyinElement = document.getElementById('pinyin');
    const kyhieuElement = document.getElementById('kyhieu');
    const pinyinContainer = document.getElementById('pinyin-container');
    const phanTichElement = document.getElementById('phanTich');
    const phanTichContainer = document.getElementById('phanTich-container');
    const answerInput = document.getElementById('answerInput');
    const meaningContainer = document.getElementById('meaning-container');
    const questionElement = document.getElementById('question');
    const readCompleteContainer = document.getElementById('read-complete-container');

    if (selectedOption.hanzi === currentQuestion.hanzi) {
        if (button) button.classList.add('correct');
        feedbackMessage.innerText = 'T·ªët l·∫Øm, b·∫°n ƒë√£ ch·ªçn ƒë√∫ng!';
        feedbackMessage.style.display = 'block';
        document.querySelectorAll('#option-buttons button').forEach(btn => btn.disabled = true);
        answerInput.disabled = true;
        if (timerInterval) clearInterval(timerInterval);

        questionElement.innerText = currentQuestion.hanzi.replace(/\|/g, '\n');
        pinyinElement.innerText = currentQuestion.pinyin.replace(/\|/g, '\n');
        kyhieuElement.innerText = currentQuestion.kyhieu.replace(/\|/g, '\n');
        if (quizType === 'vocabulary') showAnalysis();

        questionElement.style.display = 'block';
        pinyinElement.style.display = 'block';
        kyhieuElement.style.display = 'block';
        pinyinContainer.style.display = 'flex';
        if (quizType === 'vocabulary') {
earnedEXP += 1; // 1 ƒëi·ªÉm cho T·ª´ V·ª±ng
document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
            phanTichContainer.style.display = 'block';
            phanTichElement.style.display = 'block';
        } else {
earnedEXP += 2; // 2 ƒëi·ªÉm cho M·∫´u C√¢u
document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
            phanTichContainer.style.display = 'none';
            phanTichElement.style.display = 'none';
        }
        meaningContainer.style.display = 'block';
        isHintVisible = true;

        const nextAction = () => {
            feedbackMessage.style.display = 'none';
            pinyinElement.style.display = 'none';
            kyhieuElement.style.display = 'none';
            pinyinContainer.style.display = 'none';
            phanTichContainer.style.display = 'none';
            phanTichElement.style.display = 'none';
            questionElement.style.display = 'none';
            readCompleteContainer.style.display = 'none';
            meaningContainer.style.display = showMeaning ? 'block' : 'none';
            isHintVisible = false;
            answerInput.value = '';
            answerInput.disabled = false;
            questionCount++;
            if (questionCount < selectedHanzi.length) {
                loadNewQuestion();
            } else {
                // Ki·ªÉm tra ch·∫ø ƒë·ªô √¥n t·∫≠p
                if ((quizType === 'vocabulary' || quizType === 'sentence') && wrongHanzi.length > 0 && !isReviewMode) {
                    isReviewMode = true;
                    questionCount = 0;
                    currentReviewList = [...wrongHanzi];
                    totalWords = currentReviewList.length;
                    wrongHanzi = [];
                    selectedHanzi = currentReviewList.map(id => allWords.find(word => word.id === id)).filter(word => word);
                    const reviewHanziDisplay = document.getElementById('review-hanzi-display');
                    const reviewHanziList = document.getElementById('review-hanzi-list');
                    reviewHanziList.innerHTML = '';
                    selectedHanzi.forEach(word => {
                        const li = document.createElement('li');
                        li.textContent = `ID: ${word.id}, Hanzi: ${word.hanzi}`;
                        reviewHanziList.appendChild(li);
                    });
                    reviewHanziDisplay.style.display = 'block';
                    loadNewQuestion();
                } else {
                    endGame();
                }
            }
        };

        if (isNewWordMode) {
            readCompleteContainer.style.display = 'block';
            const readCompleteButton = document.getElementById('read-complete-button');
            readCompleteButton.onclick = () => {
                playCurrentAudio(nextAction);
            };
        } else {
            playCurrentAudio(nextAction);
        }
    } else {
        if (button) button.classList.add('incorrect');
        feedbackMessage.innerText = 'Sai r·ªìi, vui l√≤ng ch·ªçn l·∫°i!';
        feedbackMessage.style.display = 'block';
        if (quizType === 'vocabulary' || quizType === 'sentence') {
    if (!wrongHanzi.includes(currentQuestion.id)) {
        wrongHanzi.push(currentQuestion.id);
        const wrongHanziList = document.getElementById('wrong-hanzi-list');
        const li = document.createElement('li');
        li.textContent = `ID: ${currentQuestion.id}, Hanzi: ${currentQuestion.hanzi}`;
        wrongHanziList.appendChild(li);
    }
    // Tr·ª´ ƒëi·ªÉm d·ª±a tr√™n lo·∫°i quiz
    if (quizType === 'vocabulary') {
        earnedEXP -= 3;
    } else if (quizType === 'sentence') {
        earnedEXP -=6;
    }
    document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
}
        setTimeout(() => {
            if (button) button.classList.remove('incorrect');
            feedbackMessage.innerText = '';
            feedbackMessage.style.display = 'none';
            answerInput.value = '';
            updateStatus();
        }, 200);
    }
}

    function endGame() {
    // D·ª´ng timer n·∫øu ƒëang ch·∫°y
    if (timerInterval) clearInterval(timerInterval);

    // V√¥ hi·ªáu h√≥a c√°c n√∫t v√† input
    document.getElementById('answerInput').disabled = true;
    document.getElementById('playButton').disabled = true;
    document.getElementById('hintButton').disabled = true;
    document.getElementById('diceButton').disabled = true;
    document.getElementById('writeButton').disabled = true;
    document.getElementById('write-dialogue-button').disabled = true;
    document.getElementById('back-button').disabled = true;
    document.getElementById('next-button').disabled = true;
    document.querySelectorAll('#option-buttons button').forEach(btn => btn.disabled = true);
    document.querySelectorAll('#scrambled-buttons button').forEach(btn => btn.disabled = true);

    // D·ª´ng audio
    const audio = document.getElementById('audio');
    audio.src = '';

    // Ki·ªÉm tra nhi·ªám v·ª• ng·∫´u nhi√™n
    let finalEXP = earnedEXP;
    let missionMessage = '';
    const lessonInput = document.getElementById('lesson-input').value.trim();
    const lessonFilter = parseLessonInput(lessonInput);
    if (randomMissionLesson && lessonFilter && lessonFilter.includes(randomMissionLesson.toString())) {
        finalEXP *= 2;
        missionMessage = `<div style="font-size: 18px; color: green; text-align: center; margin: 10px 0;">
            Ho√†n th√†nh nhi·ªám v·ª•! EXP ƒë∆∞·ª£c nh√¢n ƒë√¥i!
        </div>`;
    }

    // Ki·ªÉm tra n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô T·ª´ V·ª±ng ho·∫∑c M·∫´u C√¢u v√† c√≤n t·ª´ sai
    if ((quizType === 'vocabulary' || quizType === 'sentence') && wrongHanzi.length > 0) {
        // Chuy·ªÉn sang ch·∫ø ƒë·ªô √¥n t·∫≠p
        isReviewMode = true;
        questionCount = 0;
        currentReviewList = [...wrongHanzi];
        totalWords = currentReviewList.length;
        wrongHanzi = []; // X√≥a danh s√°ch t·ª´ sai ƒë·ªÉ b·∫Øt ƒë·∫ßu l∆∞·ª£t m·ªõi
        selectedHanzi = currentReviewList.map(id => allWords.find(word => word.id === id)).filter(word => word);

        // C·∫≠p nh·∫≠t danh s√°ch t·ª´ √¥n t·∫≠p
        const reviewHanziDisplay = document.getElementById('review-hanzi-display');
        const reviewHanziList = document.getElementById('review-hanzi-list');
        reviewHanziList.innerHTML = '';
        selectedHanzi.forEach(word => {
            const li = document.createElement('li');
            li.textContent = `ID: ${word.id}, Hanzi: ${word.hanzi}`;
            reviewHanziList.appendChild(li);
        });
        reviewHanziDisplay.style.display = 'block';

        // T·∫£i c√¢u h·ªèi m·ªõi
        document.getElementById('answerInput').disabled = false;
        document.getElementById('playButton').disabled = false;
        document.getElementById('hintButton').disabled = false;
        loadNewQuestion();
    } else {
        // Hi·ªÉn th·ªã popup th√¥ng b√°o ho√†n th√†nh
        const popup = document.getElementById('endgame-popup');
        const popupContent = document.getElementById('endgame-popup-content');
        popupContent.innerHTML = `
            <div style="font-size: 24px; color: green; text-align: center;">
                B√†i √¥n t·∫≠p ƒë√£ ho√†n th√†nh!
            </div>
            ${missionMessage}
            <div style="font-size: 18px; text-align: center; margin: 10px 0;">
                ƒêi·ªÉm kinh nghi·ªám ki·∫øm ƒë∆∞·ª£c: ${finalEXP}
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button2 id="claim-exp-button" class="quiz-type-button">NH·∫¨N ƒêI·ªÇM KINH NGHI·ªÜM</button2>
            </div>
        `;
        popup.style.display = 'block';

        // G·∫Øn s·ª± ki·ªán cho n√∫t Nh·∫≠n ƒëi·ªÉm kinh nghi·ªám
        document.getElementById('claim-exp-button').addEventListener('click', () => claimExperience(finalEXP));
    }
}

    function parseLessonInput(input) {
    // L·∫•y danh s√°ch b√†i h·ª£p l·ªá d·ª±a tr√™n c·∫•p ƒë·ªô hi·ªán t·∫°i
    const currentLevel = parseInt(document.getElementById('account-level').textContent) || 1;
    const validLessons = lessonListData
        .filter(item => currentLevel >= item.level_unlock)
        .map(item => item.bai.toString());

    if (!input) {
        // N·∫øu input tr·ªëng, ch·ªçn ng·∫´u nhi√™n m·ªôt b√†i t·ª´ danh s√°ch h·ª£p l·ªá
        if (validLessons.length === 0) {
            alert('Kh√¥ng c√≥ b√†i n√†o h·ª£p l·ªá ho·∫∑c ƒë√£ m·ªü kh√≥a!');
            return null;
        }
        const randomLesson = validLessons[Math.floor(Math.random() * validLessons.length)];
        return [randomLesson];
    }

    if (input.includes('-')) {
        const [start, end] = input.split('-').map(num => parseInt(num.trim()));
        if (isNaN(start) || isNaN(end) || start > end) {
            alert('ƒê·ªãnh d·∫°ng kho·∫£ng b√†i kh√¥ng h·ª£p l·ªá!');
            return null;
        }
        // L·ªçc ch·ªâ c√°c b√†i h·ª£p l·ªá v√† ƒë√£ m·ªü kh√≥a trong kho·∫£ng t·ª´ start ƒë·∫øn end
        const filteredLessons = [];
        for (let i = start; i <= end; i++) {
            if (validLessons.includes(i.toString())) {
                filteredLessons.push(i.toString());
            }
        }
        if (filteredLessons.length === 0) {
            alert('Kh√¥ng c√≥ b√†i n√†o h·ª£p l·ªá ho·∫∑c ƒë√£ m·ªü kh√≥a trong kho·∫£ng ƒë√£ ch·ªçn!');
            return null;
        }
        return filteredLessons;
    }

    if (input.includes(',')) {
        const lessons = input.split(',').map(num => num.trim());
        // L·ªçc ch·ªâ c√°c b√†i h·ª£p l·ªá v√† ƒë√£ m·ªü kh√≥a
        const filteredLessons = lessons.filter(num => !isNaN(parseInt(num)) && validLessons.includes(num));
        if (filteredLessons.length === 0) {
            alert('Kh√¥ng c√≥ b√†i n√†o h·ª£p l·ªá ho·∫∑c ƒë√£ m·ªü kh√≥a trong danh s√°ch ƒë√£ ch·ªçn!');
            return null;
        }
        return filteredLessons;
    }

    const singleLesson = input.trim();
    const lessonData = lessonListData.find(item => item.bai.toString() === singleLesson);
    if (!lessonData) {
        alert(`B√†i ${singleLesson} kh√¥ng c√≥ trong danh s√°ch b√†i h·ª£p l·ªá!`);
        return null;
    }
    if (currentLevel < lessonData.level_unlock) {
        alert(`B·∫°n ch∆∞a ƒë·∫°t c·∫•p ${lessonData.level_unlock} ƒë·ªÉ m·ªü kh√≥a b√†i ${singleLesson}!`);
        return null;
    }
    return [singleLesson];
}

    function startGame() {
    const diceButton = document.getElementById('diceButton');
    const writeButton = document.getElementById('writeButton');
    const diceDialogueButton = document.getElementById('dice-button');
    const writeDialogueButton = document.getElementById('write-dialogue-button');
    
    diceButton.style.display = (quizType === "sentence" || quizType === "dialogue") ? 'inline-block' : 'none';
    writeButton.style.display = (quizType === "vocabulary" || quizType === "sentence") ? 'inline-block' : 'none';
    diceDialogueButton.style.display = (quizType === "dialogue") ? 'inline-block' : 'none';
    writeDialogueButton.style.display = (quizType === "dialogue") ? 'inline-block' : 'none';

    const phanTichContainer = document.getElementById('phanTich-container');
    const relatedBtn = document.querySelector('.related-btn');
    if (quizType === 'dialogue' || quizType === 'sentence') {
        phanTichContainer.style.display = 'none';
        relatedBtn.style.display = 'none';
    } else {
        phanTichContainer.style.display = 'none';
        // X√≥a d√≤ng n√†y: relatedBtn.style.display = 'inline-block';
    }

    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã n√∫t üîç v√† üîó d·ª±a tr√™n selectedMode
    updateButtonVisibility();

    const wordCountInput = document.getElementById('word-count');
    const lessonInput = document.getElementById('lesson-input').value;
    const timeLimitInput = document.getElementById('time-limit');

    // Hi·ªÉn th·ªã status-container cho T·ª´ V·ª±ng v√† M·∫´u C√¢u
    const statusContainer = document.getElementById('status-container');
    if (quizType === 'vocabulary' || quizType === 'sentence') {
        statusContainer.style.display = 'flex';
    } else {
        statusContainer.style.display = 'none';
    }

    if (quizType !== 'dialogue') {
        // S·ª≠ d·ª•ng to√†n b·ªô s·ªë t·ª´ trong b√†i n·∫øu ƒë·ªÉ tr·ªëng
        maxWords = parseInt(wordCountInput.value) || Infinity;
        if (!maxWords || maxWords < 1) maxWords = Infinity;

        timeLimit = parseInt(timeLimitInput.value) || 20;
        timeRemaining = timeLimit;
    } else {
        maxWords = Infinity;
        timeLimit = 0;
        timeRemaining = 0;
    }

    let filteredWords = [];
    const lessonFilter = parseLessonInput(lessonInput);

// Ki·ªÉm tra n·∫øu lessonFilter l√† null (t·ª©c l√† kh√¥ng c√≥ b√†i h·ª£p l·ªá)
    if (!lessonFilter && lessonInput) {
        return; // D·ª´ng h√†m startGame, kh√¥ng ch·∫°y game
    }

// L·∫•y danh s√°ch c√°c b√†i h·ª£p l·ªá d·ª±a tr√™n c·∫•p ƒë·ªô hi·ªán t·∫°i
    const currentLevel = parseInt(document.getElementById('account-level').textContent) || 1;
    const validLessons = lessonListData
        .filter(item => currentLevel >= item.level_unlock)
        .map(item => item.bai.toString());

    if (quizType === 'dialogue') {
        selectedDialogue = document.getElementById('dialogue-number').value.trim();
        filteredWords = dialogueData.filter(item => lessonFilter ? lessonFilter.includes(item.bai) : true);
        if (filteredWords.length === 0) {
            alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ªôi tho·∫°i!');
            return;
        }

        if (!selectedDialogue) {
            let allDialogues = [];
            filteredWords.forEach(item => {
                const dialoguesInBai = Object.keys(item.hoiThoai)
                    .filter(key => item.hoiThoai[key].length > 0)
                    .map(key => item.hoiThoai[key]);
                allDialogues = allDialogues.concat(dialoguesInBai);
            });
            if (allDialogues.length === 0) {
                alert('Kh√¥ng t√¨m th·∫•y h·ªôi tho·∫°i n√†o trong b√†i n√†y!');
                return;
            }
            allWords = shuffle([...allDialogues]).flat();
        } else {
            const dialogueNum = parseInt(selectedDialogue);
            if (isNaN(dialogueNum) || dialogueNum < 1) {
                alert('Vui l√≤ng nh·∫≠p s·ªë h·ªôi tho·∫°i h·ª£p l·ªá!');
                return;
            }
            allWords = filteredWords[0].hoiThoai[dialogueNum] || [];
            if (allWords.length === 0) {
                alert(`Kh√¥ng t√¨m th·∫•y h·ªôi tho·∫°i s·ªë ${dialogueNum} trong b√†i n√†y!`);
                return;
            }
        }
        selectedHanzi = allWords;
        totalWords = selectedHanzi.length;
    } else {
        filteredWords = jsonData;
        if (lessonFilter) {
            filteredWords = jsonData.filter(word => lessonFilter.includes(word.bai));
        }
        allWords = filteredWords;
        if (filteredWords.length === 0) {
            alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho l·ª±a ch·ªçn n√†y!');
            return;
        }
        if (maxWords > filteredWords.length) maxWords = filteredWords.length;
        selectedHanzi = shuffle([...filteredWords]).slice(0, maxWords);
        totalWords = selectedHanzi.length;
    }

    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('game-container').style.display = 'block';

    const pinyinContainer = document.getElementById('pinyin-container');
    const pinyinKyhieuGroup = document.querySelector('.pinyin-kyhieu-group');
    const buttonGrid = document.getElementById('option-buttons');
    const meaningContainer = document.getElementById('meaning-container');
    const questionElement = document.getElementById('question');

    if (quizType === "dialogue" || quizType === "sentence") {
        pinyinContainer.style.textAlign = 'left';
        pinyinContainer.style.marginTop = '0';
        pinyinContainer.style.display = 'none';
        pinyinContainer.style.flexDirection = 'column';
        pinyinContainer.style.alignItems = 'flex-start';
        pinyinKyhieuGroup.style.flexDirection = 'column';
        pinyinKyhieuGroup.style.textAlign = 'left';
        pinyinKyhieuGroup.style.justifyContent = 'flex-start';
        buttonGrid.style.gridTemplateColumns = 'repeat(1, 1fr)';
        meaningContainer.style.textAlign = 'left';
        questionElement.style.textAlign = 'left';
    } else {
        pinyinContainer.style.textAlign = 'center';
        pinyinContainer.style.marginTop = '0';
        pinyinContainer.style.display = 'none';
        pinyinContainer.style.flexDirection = 'column';
        pinyinContainer.style.alignItems = 'center';
        pinyinKyhieuGroup.style.flexDirection = 'row';
        pinyinKyhieuGroup.style.textAlign = 'center';
        pinyinKyhieuGroup.style.justifyContent = 'center';
        buttonGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
        meaningContainer.style.textAlign = 'center';
        questionElement.style.textAlign = 'center';
    }

    questionCount = 0;
    wrongHanzi = [];
    isReviewMode = false;
    currentReviewList = [];
    loadNewQuestion();

    const answerInput = document.getElementById('answerInput');
    const inputPinyinDisplay = document.getElementById('inputPinyinDisplay');
    const testButton = document.getElementById('testButton');
    const autoCheck = document.getElementById('autoCheck');

    function displayPinyin() {
        const userInput = answerInput.value.trim();
        inputPinyinDisplay.textContent = '';
        if (userInput) {
            const inputPinyin = hanziToPinyin(userInput);
            inputPinyinDisplay.textContent = `Pinyin: ${inputPinyin}`;
        }
    }

    function checkPinyin() {
        const userInput = document.getElementById('answerInput').value.trim();
        const feedbackMessage = document.getElementById('feedback');
        const inputPinyinDisplay = document.getElementById('inputPinyinDisplay');
        const readCompleteContainer = document.getElementById('read-complete-container');

        if (!userInput) {
            feedbackMessage.innerText = 'Vui l√≤ng nh·∫≠p H√°n t·ª±!';
            feedbackMessage.style.display = 'block';
            setTimeout(() => {
                feedbackMessage.innerText = '';
                feedbackMessage.style.display = 'none';
            }, 1000);
            return;
        }

        const cleanUserInput = userInput.replace(/[.,!?Ôºå„ÄÇÔºÅÔºü]/g, '');
        const cleanQuestionHanzi = currentQuestion.hanzi.replace(/[.,!?Ôºå„ÄÇÔºÅÔºü]/g, '');
        const inputPinyin = hanziToPinyin(cleanUserInput);
        const questionPinyinOptions = getAllPinyinCombinations(cleanQuestionHanzi);
        const isCorrect = isPinyinMatch(inputPinyin, questionPinyinOptions);

        if (isCorrect) {
            feedbackMessage.innerText = 'T·ªët l·∫Øm, b·∫°n ƒë√£ ch·ªçn ƒë√∫ng!';
            feedbackMessage.style.display = 'block';
            document.getElementById('answerInput').disabled = true;
            if (timerInterval) clearInterval(timerInterval);

            const questionElement = document.getElementById('question');
            const pinyinElement = document.getElementById('pinyin');
            const kyhieuElement = document.getElementById('kyhieu');
            const pinyinContainer = document.getElementById('pinyin-container');
            const phanTichElement = document.getElementById('phanTich');
            const phanTichContainer = document.getElementById('phanTich-container');
            const meaningContainer = document.getElementById('meaning-container');

            questionElement.innerText = currentQuestion.hanzi.replace(/\|/g, '\n');
            pinyinElement.innerText = currentQuestion.pinyin ? currentQuestion.pinyin.replace(/\|/g, '\n') : hanziToPinyin(currentQuestion.hanzi);
            kyhieuElement.innerText = currentQuestion.kyhieu ? currentQuestion.kyhieu.replace(/\|/g, '\n') : '';
            questionElement.style.display = 'block';
            pinyinElement.style.display = 'block';
            kyhieuElement.style.display = currentQuestion.kyhieu ? 'block' : 'none';
            pinyinContainer.style.display = 'flex';
            meaningContainer.style.display = 'block';
            if (quizType === 'vocabulary') {
                showAnalysis();
                phanTichContainer.style.display = 'block';
                phanTichElement.style.display = 'block';
if (quizType === 'vocabulary') {
            earnedEXP += 2; // 2 ƒëi·ªÉm cho T·ª´ V·ª±ng
document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
        } else if (quizType === 'sentence') {
            earnedEXP += 4; // 4 ƒëi·ªÉm cho M·∫´u C√¢u
document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
        }
            }

            const nextAction = () => {
                feedbackMessage.style.display = 'none';
                questionCount++;
                currentScrambleAnswer = '';
                pinyinElement.style.display = 'none';
                kyhieuElement.style.display = 'none';
                pinyinContainer.style.display = 'none';
                phanTichContainer.style.display = 'none';
                phanTichElement.style.display = 'none';
                questionElement.style.display = 'none';
                readCompleteContainer.style.display = 'none';
                meaningContainer.style.display = showMeaning ? 'block' : 'none';
                document.getElementById('answerInput').value = '';
                document.getElementById('answerInput').disabled = false;
                inputPinyinDisplay.textContent = '';

                if (questionCount < selectedHanzi.length) {
                    if (quizType === 'sentence' && isScrambleMode) {
                        startScrambleGame();
                    } else {
                        if (quizType === 'dialogue') {
                            updateDialogueContainer();
                        }
                        loadNewQuestion();
                    }
                } else {
                    endGame();
                }
            };

            if (isNewWordMode) {
                readCompleteContainer.style.display = 'block';
                const readCompleteButton = document.getElementById('read-complete-button');
                readCompleteButton.onclick = () => {
                    playCurrentAudio(nextAction);
                };
            } else {
                playCurrentAudio(nextAction);
            }
        } else {
            feedbackMessage.innerText = 'Sai r·ªìi, vui l√≤ng nh·∫≠p l·∫°i!';
            feedbackMessage.style.display = 'block';
            // Ghi nh·∫≠n c√¢u sai cho T·ª´ V·ª±ng v√† M·∫´u C√¢u
            if ((quizType === 'vocabulary' || quizType === 'sentence') && !wrongHanzi.includes(currentQuestion.id)) {
                wrongHanzi.push(currentQuestion.id);
                const wrongHanziList = document.getElementById('wrong-hanzi-list');
                const li = document.createElement('li');
                li.textContent = `ID: ${currentQuestion.id}, Hanzi: ${currentQuestion.hanzi}`;
                wrongHanziList.appendChild(li);
                updateStatus();
            }
            setTimeout(() => {
                feedbackMessage.innerText = '';
                feedbackMessage.style.display = 'none';
                if (quizType !== 'dialogue') {
                    document.getElementById('answerInput').value = '';
                    inputPinyinDisplay.textContent = '';
                }
            }, 1000);
        }
    }

    answerInput.removeEventListener('input', answerInput._inputHandler);
    function inputHandler() {
        displayPinyin();
        if (autoCheck.checked) {
            checkPinyin();
        }
    }
    answerInput._inputHandler = inputHandler;
    answerInput.addEventListener('input', inputHandler);

    testButton.removeEventListener('click', testButton._clickHandler);
    function testHandler() {
        checkPinyin();
    }
    testButton._clickHandler = testHandler;
    testButton.addEventListener('click', testHandler);
	
	// ·∫®n h√¨nh ·∫£nh h·ªôi tho·∫°i n·∫øu kh√¥ng ph·∫£i ch·∫ø ƒë·ªô dialogue
const dialogueImage = document.getElementById('dialogue-image');
if (quizType !== 'dialogue') {
    dialogueImage.style.display = 'none';
}
}

    // S·ª± ki·ªán cho diceButton (d√πng trong M·∫´u C√¢u v√† H·ªôi Tho·∫°i)
document.getElementById('diceButton').addEventListener('click', function() {
    if (isWritingMode) {
        stopWritingMode(); // T·∫Øt ch·∫ø ƒë·ªô t·∫≠p vi·∫øt n·∫øu ƒëang b·∫≠t
    }
    if (!isScrambleMode) {
        startScrambleGame(); // B·∫≠t ch·∫ø ƒë·ªô x·∫øp ch·ªØ
    } else {
        stopScrambleGame(); // T·∫Øt ch·∫ø ƒë·ªô x·∫øp ch·ªØ
    }
});

 function displayScrambleQuestion() {
    const dialogueContainer = document.getElementById('dialogue-container');
    dialogueContainer.innerHTML = '';

    const hanzi = currentQuestion.hanzi.replace(/\|/g, '');
    const correctAnswer = hanzi;
    const validChars = correctAnswer.split('').filter(char => !/[.,!?Ôºå„ÄÇÔºÅÔºü]/.test(char));
    let hiddenHanzi = '';
    let answerIndex = 0; // Ch·ªâ s·ªë theo d√µi v·ªã tr√≠ trong currentScrambleAnswer

    for (let j = 0; j < correctAnswer.length; j++) {
        if (/[.,!?Ôºå„ÄÇÔºÅÔºü]/.test(correctAnswer[j])) {
            hiddenHanzi += correctAnswer[j]; // Gi·ªØ nguy√™n d·∫•u c√¢u
        } else {
            if (answerIndex < currentScrambleAnswer.length) {
                hiddenHanzi += currentScrambleAnswer[answerIndex];
                answerIndex++;
            } else {
                hiddenHanzi += '*';
                answerIndex++;
            }
        }
    }

    const dialogueBox = document.createElement('div');
    dialogueBox.className = 'dialogue-box';
    dialogueBox.innerText = hiddenHanzi;
    dialogueContainer.appendChild(dialogueBox);
}

function startScrambleGame() {
    isScrambleMode = true;
    document.getElementById('writing-container').style.display = 'none';
    document.getElementById('option-buttons').style.display = 'none';
    document.getElementById('word-scramble-game').style.display = 'none';
    document.getElementById('question').style.display = 'none';
    document.getElementById('pinyin-container').style.display = 'none';
    document.getElementById('dialogue-display').style.display = 'block';

    // ·∫®n n√∫t Back v√† Next trong M·∫´u C√¢u
    if (quizType === 'sentence') {
        document.getElementById('back-button').style.display = 'none';
        document.getElementById('next-button').style.display = 'none';
    } else {
        document.getElementById('back-button').style.display = 'inline-block';
        document.getElementById('next-button').style.display = 'inline-block';
    }

    // C·∫≠p nh·∫≠t currentQuestion d·ª±a tr√™n questionCount
    if (questionCount < selectedHanzi.length) {
        currentQuestion = selectedHanzi[questionCount];
    }

    currentScrambleAnswer = '';

    // C·∫≠p nh·∫≠t D·ªãch nghƒ©a
    document.getElementById('meaning').innerText = currentQuestion.nghia.replace(/\|/g, '\n');
    document.getElementById('meaning-container').style.display = showMeaning ? 'block' : 'none';

    // Ph√°t √¢m thanh khi b·∫Øt ƒë·∫ßu c√¢u h·ªèi
    if (currentQuestion.linkmp3) {
        setupAudio(audio, currentQuestion.linkmp3, currentQuestion.time);
        playCurrentAudio(() => {});
    }

    // Hi·ªÉn th·ªã c√¢u h·ªèi
    if (quizType === 'sentence') {
        displayScrambleQuestion();
    } else {
        updateDialogueContainer();
    }

    // L·ªçc b·ªè d·∫•u c√¢u kh·ªèi danh s√°ch k√Ω t·ª± cho n√∫t x·∫øp ch·ªØ
    const hanzi = currentQuestion.hanzi.replace(/\|/g, '');
    const characters = hanzi.split('').filter(char => !/[.,!?Ôºå„ÄÇÔºÅÔºü]/.test(char));
    const shuffledChars = shuffle([...characters]);

    const scrambleButtonsContainer = document.getElementById('scrambled-buttons');
    scrambleButtonsContainer.innerHTML = '';
    scrambleButtonsContainer.style.display = 'flex';
    shuffledChars.forEach(char => {
        const button = document.createElement('button');
        button.innerText = char;
        button.addEventListener('click', () => handleScrambleButtonClick(button, char));
        scrambleButtonsContainer.appendChild(button);
    });
}

function stopScrambleGame() {
    isScrambleMode = false;
    document.getElementById('word-scramble-game').style.display = 'none';
    document.getElementById('scrambled-buttons').style.display = 'none';
    document.getElementById('diceButton').disabled = false;

    if (quizType === 'sentence') {
        // Kh√¥i ph·ª•c giao di·ªán n√∫t b·∫•m cho M·∫´u C√¢u
        document.getElementById('dialogue-display').style.display = 'none';
        document.getElementById('option-buttons').style.display = 'grid';
        document.getElementById('meaning-container').style.display = showMeaning ? 'block' : 'none';
        document.getElementById('back-button').style.display = 'none';
        document.getElementById('next-button').style.display = 'none';
        loadNewQuestion(); // T·∫£i l·∫°i giao di·ªán n√∫t b·∫•m
    } else {
        // Gi·ªØ giao di·ªán H·ªôi Tho·∫°i
        document.getElementById('dialogue-display').style.display = 'block';
        document.getElementById('option-buttons').style.display = 'none';
        document.getElementById('back-button').style.display = 'inline-block';
        document.getElementById('next-button').style.display = 'inline-block';
        updateDialogueContainer();
    }
}

function handleScrambleButtonClick(button, char) {
    const correctAnswer = currentQuestion.hanzi.replace(/\|/g, '').replace(/[.,!?Ôºå„ÄÇÔºÅÔºü]/g, '');
    const nextChar = correctAnswer[currentScrambleAnswer.length];

    if (char === nextChar) {
        currentScrambleAnswer += char;
        button.style.display = 'none';

// Award 1 EXP for each correct character
        earnedEXP += 1;
        document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;

        if (quizType === 'sentence') {
            displayScrambleQuestion();
        } else {
            updateDialogueContainer();
        }

        if (currentScrambleAnswer === correctAnswer) {
            document.getElementById('feedback').innerText = 'T·ªët l·∫Øm, b·∫°n ƒë√£ ch·ªçn ƒë√∫ng!';
            document.getElementById('feedback').style.display = 'block';
            document.getElementById('answerInput').disabled = true;
            if (timerInterval) clearInterval(timerInterval);

            const questionElement = document.getElementById('question');
            const pinyinElement = document.getElementById('pinyin');
            const kyhieuElement = document.getElementById('kyhieu');
            const pinyinContainer = document.getElementById('pinyin-container');
            const phanTichElement = document.getElementById('phanTich');
            const phanTichContainer = document.getElementById('phanTich-container');
            const meaningContainer = document.getElementById('meaning-container');
            const readCompleteContainer = document.getElementById('read-complete-container');

            questionElement.innerText = currentQuestion.hanzi.replace(/\|/g, '\n');
            pinyinElement.innerText = currentQuestion.pinyin ? currentQuestion.pinyin.replace(/\|/g, '\n') : hanziToPinyin(currentQuestion.hanzi);
            kyhieuElement.innerText = currentQuestion.kyhieu ? currentQuestion.kyhieu.replace(/\|/g, '\n') : '';
            questionElement.style.display = 'block';
            pinyinElement.style.display = 'block';
            kyhieuElement.style.display = currentQuestion.kyhieu ? 'block' : 'none';
            pinyinContainer.style.display = 'flex';
            meaningContainer.style.display = 'block';
            if (quizType === 'vocabulary') {
                showAnalysis();
                phanTichContainer.style.display = 'block';
                phanTichElement.style.display = 'block';
                earnedEXP += 0; // 1 ƒëi·ªÉm cho T·ª´ V·ª±ng
document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
            } else if (quizType === 'sentence') {
               earnedEXP += 0; // 5 ƒëi·ªÉm cho M·∫´u C√¢u
document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
            }

            const nextAction = () => {
                document.getElementById('feedback').style.display = 'none';
                currentScrambleAnswer = '';
                pinyinElement.style.display = 'none';
                kyhieuElement.style.display = 'none';
                pinyinContainer.style.display = 'none';
                phanTichContainer.style.display = 'none';
                phanTichElement.style.display = 'none';
                questionElement.style.display = 'none';
                readCompleteContainer.style.display = 'none';
                meaningContainer.style.display = showMeaning ? 'block' : 'none';
                document.getElementById('answerInput').value = '';
                document.getElementById('answerInput').disabled = false;
                document.getElementById('inputPinyinDisplay').textContent = '';

                questionCount++;
                if (questionCount < selectedHanzi.length) {
                    if (quizType === 'sentence' && isScrambleMode) {
                        startScrambleGame();
                    } else {
                        if (quizType === 'dialogue') {
                            updateDialogueContainer();
                        }
                        loadNewQuestion();
                    }
                } else {
                    endGame();
                }
            };

            if (isNewWordMode) {
                readCompleteContainer.style.display = 'block';
                const readCompleteButton = document.getElementById('read-complete-button');
                readCompleteButton.onclick = () => {
                    playCurrentAudio(nextAction);
                };
            } else {
                playCurrentAudio(nextAction);
            }
        }
    } else {
        button.classList.add('incorrect');
// Tr·ª´ 2 ƒëi·ªÉm khi ch·ªçn sai k√Ω t·ª± trong ch·∫ø ƒë·ªô M·∫´u c√¢u ho·∫∑c H·ªôi tho·∫°i
        if (quizType === 'sentence' || quizType === 'dialogue') {
            earnedEXP -=2;
            document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
        }
        setTimeout(() => {
            button.classList.remove('incorrect');
        }, 200);
    }
}

    document.getElementById('back-button').addEventListener('click', function() {
        if (quizType === 'dialogue' && questionCount > 0) {
earnedEXP -=2;
            document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
            questionCount--;
            currentScrambleAnswer = '';
            loadNewQuestion();
        }
    });

    document.getElementById('next-button').addEventListener('click', function() {
    if (quizType === 'dialogue' && showMeaning && currentQuestion.linkmp3) {
        // Ph√°t audio tr∆∞·ªõc khi x·ª≠ l√Ω logic Next
        const audio = document.getElementById('audio');
        setupAudio(audio, currentQuestion.linkmp3, currentQuestion.time);
        playCurrentAudio(() => {
            // Callback: Th·ª±c hi·ªán logic Next sau khi audio ph√°t xong
            if (questionCount < selectedHanzi.length - 1) {
                earnedEXP += 2; // 2 ƒëi·ªÉm cho m·ªói c√¢u H·ªôi Tho·∫°i
                document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
                questionCount++;
                currentScrambleAnswer = '';
                loadNewQuestion();
            } else {
                earnedEXP += 2; // Th√™m 2 ƒëi·ªÉm cho c√¢u cu·ªëi
                document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
                endGame();
            }
        });
    } else if (quizType === 'dialogue') {
        // H√†nh vi b√¨nh th∆∞·ªùng cho H·ªôi Tho·∫°i (khi showMeaning = false ho·∫∑c kh√¥ng c√≥ linkmp3)
        if (questionCount < selectedHanzi.length - 1) {
            earnedEXP += 2; // 2 ƒëi·ªÉm cho m·ªói c√¢u H·ªôi Tho·∫°i
            document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
            questionCount++;
            currentScrambleAnswer = '';
            loadNewQuestion();
        } else {
            earnedEXP += 2; // Th√™m 2 ƒëi·ªÉm cho c√¢u cu·ªëi
            document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;
            endGame();
        }
    }
});

    function showHanziPopup(char) {
    const popup = document.getElementById('hanzi-popup');
    const popupContent = document.getElementById('hanzi-popup-content');
    let content = '';

    // Ki·ªÉm tra xem char c√≥ ph·∫£i l√† t·ª´/c·ª•m t·ª´ m·ªõi trong hanzi3Data kh√¥ng
    const lessonInput = document.getElementById('lesson-input').value.trim();
    const lessonFilter = parseLessonInput(lessonInput) || [];
    const wordInfo = hanzi3Data.find(item => item.hanzi === char && lessonFilter.includes(item.bai));
    if (wordInfo) {
        content += '<strong style="color: darkblue; text-align: center; display: block;">Th√¥ng tin t·ª´ m·ªõi:</strong>';
        content += `<p><strong>T·ª´ m·ªõi: </strong><span style="color: red">${char}</span> <span class="pinyin-clickable" onclick="playPinyinAudio('${wordInfo.linkmp3}', '${wordInfo.time}')" style="color: blue; cursor: pointer; text-decoration: underline;">(${wordInfo.pinyin})</span></p>`;
        content += `<p><strong>H√°n vi·ªát: </strong><span style="color: green">${wordInfo.kyhieu.replace(/\|/g, '\n')}</span></p>`;
        content += `<p><strong>Nghƒ©a: </strong><span style="color: green">${wordInfo.nghia.replace(/\|/g, '\n')}</span></p>`;
        if (wordInfo.phanTich) {
            content += `<p><strong>Ph√¢n t√≠ch:</strong></p>`;
            content += `<p><span style="color: blue">${wordInfo.phanTich.replace(/\|/g, '\n')}</span></p>`;
        }
        content += '<hr>'; // Th√™m ƒë∆∞·ªùng ph√¢n c√°ch sau th√¥ng tin t·ª´/c·ª•m t·ª´ m·ªõi
    }

    // T√°ch c·ª•m t·ª´ th√†nh t·ª´ng k√Ω t·ª± v√† l·∫•y th√¥ng tin t·ª´ bangHanTuData
    const characters = char.split('');
    content += '<strong style="color: darkblue; text-align: center; display: block;">Ph√¢n t√≠ch H√°n T·ª±:</strong>';

    // T·∫£i pinyinmp3.json
    fetch('/hoctiengtrung/json/pinyinmp3.json') // Thay b·∫±ng ƒë∆∞·ªùng d·∫´n th·ª±c t·∫ø
        .then(response => response.json())
        .then(pinyinMp3Map => {
            characters.forEach(c => {
                const hanTuInfo = bangHanTuData.find(item => item.hanTu === c);
                const pinyinInfo = pinyinTuDienData[c];
                content += `<p><strong>H√°n T·ª±:</strong> <span style="color: red">${c}</span></p>`;
                if (pinyinInfo) {
                    const pinyinArray = pinyinInfo.split(',').map(p => p.trim());
                    let pinyinHtml = '';
                    pinyinArray.forEach(pinyin => {
                        const mp3File = pinyinMp3Map[pinyin] || '';
                        const mp3Url = mp3File ? `${mp3File}` : ''; // Thay b·∫±ng ƒë∆∞·ªùng d·∫´n th∆∞ m·ª•c MP3
                        pinyinHtml += `<span class="pinyin" onclick="playPinyin('${mp3Url}')" style="cursor: ${mp3Url ? 'pointer' : 'default'}; color: ${mp3Url ? 'blue' : 'gray'}; text-decoration: ${mp3Url ? 'underline' : 'none'};">${pinyin}</span>, `;
                    });
                    // X√≥a d·∫•u ph·∫©y cu·ªëi
                    pinyinHtml = pinyinHtml.slice(0, -2);
                    content += `<p><strong>Pinyin:</strong> <span style="color: blue">${pinyinHtml}</span></p>`;
                } else {
                    content += `<p>Kh√¥ng t√¨m th·∫•y pinyin cho H√°n t·ª±: <span style="color: purple">${c}</span></p>`;
                }
                if (hanTuInfo) {
                    content += `<p><span style="color: purple">${hanTuInfo.cauTao.replace(/\|/g, '\n')}</span></p>`;
                } else {
                    content += `<p>Kh√¥ng t√¨m th·∫•y c·∫•u t·∫°o cho H√°n t·ª±: <span style="color: purple">${c}</span></p>`;
                }
                content += '<hr class="dashed-divider">'; // Th√™m ƒë∆∞·ªùng n√©t ƒë·ª©t gi·ªØa c√°c k√Ω t·ª±
            });

            popupContent.innerHTML = content;
            popup.style.display = 'block';
        })
        .catch(error => {
            console.error('L·ªói t·∫£i pinyinmp3.json:', error);
            // Hi·ªÉn th·ªã n·ªôi dung m·∫∑c ƒë·ªãnh n·∫øu l·ªói
            characters.forEach(c => {
                const hanTuInfo = bangHanTuData.find(item => item.hanTu === c);
                const pinyinInfo = pinyinTuDienData[c];
                content += `<p><strong>H√°n T·ª±:</strong> <span style="color: red">${c}</span></p>`;
                if (pinyinInfo) {
                    content += `<p><strong>Pinyin:</strong> <span style="color: blue">${pinyinInfo}</span></p>`;
                } else {
                    content += `<p>Kh√¥ng t√¨m th·∫•y pinyin cho H√°n t·ª±: <span style="color: purple">${c}</span></p>`;
                }
                if (hanTuInfo) {
                    content += `<p><span style="color: purple">${hanTuInfo.cauTao.replace(/\|/g, '\n')}</span></p>`;
                } else {
                    content += `<p>Kh√¥ng t√¨m th·∫•y c·∫•u t·∫°o cho H√°n t·ª±: <span style="color: purple">${c}</span></p>`;
                }
                content += '<hr class="dashed-divider">';
            });

            popupContent.innerHTML = content;
            popup.style.display = 'block';
        });
}

// H√†m ph√°t MP3
function playPinyin(mp3Url) {
    if (mp3Url) {
        const audio = new Audio(mp3Url);
        audio.play().catch(error => console.error('L·ªói ph√°t MP3:', error));
    }
}

// H√†m m·ªõi ƒë·ªÉ ph√°t √¢m thanh cho pinyin c·ªßa wordInfo
function playPinyinAudio(linkmp3, time) {
    if (linkmp3 && time) {
        const audioElement = new Audio();
        const timeRange = `${time} - ${time}`; // T·∫°o timeRange gi·∫£ v√¨ ch·ªâ c√≥ m·ªôt th·ªùi gian
        setupAudio(audioElement, linkmp3, timeRange);
        audioElement.play().catch(error => console.error('L·ªói ph√°t MP3:', error));
        audioElement.addEventListener('timeupdate', function checkTime() {
            if (audioElement.currentTime >= audioEndTime) {
                audioElement.pause();
                audioElement.currentTime = audioStartTime;
                audioElement.removeEventListener('timeupdate', checkTime);
            }
        });
    }
}

    function closeHanziPopup() {
        document.getElementById('hanzi-popup').style.display = 'none';
    }

    function updateDialogueContainer() {
    const dialogueContainer = document.getElementById('dialogue-container');
    const dialogueDisplay = document.getElementById('dialogue-display');
    const dialogueImage = document.getElementById('dialogue-image');
    const meaningContainer = document.getElementById('meaning-container');
    const optionButtons = document.getElementById('option-buttons');
    const answerInput = document.getElementById('answerInput');

    dialogueContainer.innerHTML = '';

    // L·∫•y danh s√°ch t·ª´ m·ªõi t·ª´ hanzi3Data t∆∞∆°ng ·ª©ng v·ªõi b√†i hi·ªán t·∫°i
    const lessonInput = document.getElementById('lesson-input').value.trim();
    const lessonFilter = parseLessonInput(lessonInput) || [];
    const newWords = hanzi3Data.filter(word => lessonFilter.includes(word.bai)).map(word => word.hanzi);

    for (let i = 0; i <= questionCount; i++) {
        const question = selectedHanzi[i];
        if (!question) continue;

        const dialogueBox = document.createElement('div');
        dialogueBox.className = 'dialogue-box';
        if (question.kieu === 'A') {
            dialogueBox.classList.add('kieu-A');
        } else if (question.kieu === 'B') {
            dialogueBox.classList.add('kieu-B');
        } else if (question.kieu === 'C') {
            dialogueBox.classList.add('kieu-C');
        } else if (question.kieu === 'D') {
            dialogueBox.classList.add('kieu-D');
        } else if (question.kieu === 'K') {
            dialogueBox.classList.add('kieu-K');
        } else if (question.kieu === 'E') {
            dialogueBox.classList.add('kieu-E');
        } else if (question.kieu === 'F') {
            dialogueBox.classList.add('kieu-F');
        } else if (question.kieu === 'G') {
            dialogueBox.classList.add('kieu-G');
        }

        const nhanVatSpan = document.createElement('span');
        nhanVatSpan.className = 'nhanvat';
        nhanVatSpan.innerText = question.nhanVat ? `${question.nhanVat} ` : '';
        dialogueBox.appendChild(nhanVatSpan);

        const hanziContainer = document.createElement('span');
        const hanzi = question.hanzi.replace(/\|/g, '');

        if (i === questionCount && (isScrambleMode || isWritingMode)) {
            const validChars = hanzi.split('').filter(char => !/[.,!?Ôºå„ÄÇÔºÅÔºü]/.test(char));
            let hiddenHanzi = '';
            let answerIndex = 0;

            hanzi.split('').forEach(char => {
                if (/[.,!?Ôºå„ÄÇÔºÅÔºü]/.test(char)) {
                    hiddenHanzi += char;
                } else {
                    if (answerIndex < currentScrambleAnswer.length) {
                        hiddenHanzi += currentScrambleAnswer[answerIndex];
                        answerIndex++;
                    } else {
                        hiddenHanzi += '*';
                        answerIndex++;
                    }
                }
            });

            hanziContainer.innerText = hiddenHanzi;
        } else {
            let currentText = '';
            let j = 0;
            while (j < hanzi.length) {
                let matched = false;
                // Ki·ªÉm tra c√°c c·ª•m t·ª´ m·ªõi c√≥ ƒë·ªô d√†i t·ª´ d√†i ƒë·∫øn ng·∫Øn
                for (let len = Math.min(4, hanzi.length - j); len >= 1; len--) {
                    const substring = hanzi.substr(j, len);
                    if (newWords.includes(substring)) {
                        const wordSpan = document.createElement('span');
                        wordSpan.style.color = 'red';
                        wordSpan.className = 'hanzi-clickable';
                        wordSpan.innerText = substring;
                        wordSpan.addEventListener('click', () => showHanziPopup(substring));
                        hanziContainer.appendChild(wordSpan);
                        j += len;
                        matched = true;
                        break;
                    }
                }
                if (!matched) {
                    const char = hanzi[j];
                    const charSpan = document.createElement('span');
                    if (char.trim() && !/[.,!?Ôºå„ÄÇÔºÅÔºü]/.test(char)) {
                        charSpan.className = 'hanzi-clickable';
                        charSpan.addEventListener('click', () => showHanziPopup(char));
                    }
                    charSpan.innerText = char;
                    hanziContainer.appendChild(charSpan);
                    j++;
                }
            }
        }
        dialogueBox.appendChild(hanziContainer);
        dialogueContainer.appendChild(dialogueBox);
    }

    currentQuestion = selectedHanzi[questionCount];
    if (!currentQuestion) return;

    dialogueDisplay.style.display = 'block';
    dialogueImage.src = currentQuestion.anh || '';
    dialogueImage.style.display = !currentQuestion.anh ? 'none' : 'block';
    document.getElementById('meaning').innerText = currentQuestion.nghia ? currentQuestion.nghia.replace(/\|/g, '\n') : '';
    meaningContainer.style.display = showMeaning ? 'block' : 'none';
    optionButtons.style.display = 'none';
    document.getElementById('timer').innerText = '';

    dialogueContainer.scrollTop = dialogueContainer.scrollHeight;
    dialogueDisplay.scrollTop = dialogueDisplay.scrollHeight;

    isHintVisible = false;
    document.getElementById('question').style.display = 'none';
    document.getElementById('pinyin-container').style.display = 'none';
    document.getElementById('pinyin').style.display = 'none';
    document.getElementById('kyhieu').style.display = 'none';
    document.getElementById('phanTich-container').style.display = 'none';
    document.getElementById('phanTich').style.display = 'none';

    if (!isScrambleMode && !isWritingMode && currentQuestion.linkmp3 && !showMeaning) {
        setupAudio(audio, currentQuestion.linkmp3, currentQuestion.time);
        playCurrentAudio(() => {});
    }

    answerInput.value = '';
    answerInput.disabled = false;
    document.getElementById('inputPinyinDisplay').textContent = '';

    updateStatus();
}

marked.setOptions({
    gfm: true,
    tables: true
});

function showInfoPopup(txtLink) {
    const popup = document.getElementById('info-popup');
    const popupContent = document.getElementById('info-popup-content');

    fetch(txtLink)
        .then(response => {
            if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i file th√¥ng tin');
            return response.text();
        })
        .then(data => {
            // Chuy·ªÉn ƒë·ªïi n·ªôi dung Markdown th√†nh HTML
            let htmlContent = DOMPurify.sanitize(marked.parse(data));

            // G√°n n·ªôi dung v√†o popup
            popupContent.innerHTML = htmlContent;

            // X·ª≠ l√Ω c√°c th·∫ª <a>, nh∆∞ng b·ªè qua <img>
            const links = popupContent.querySelectorAll('a');
            links.forEach(link => {
                const href = link.getAttribute('href');
                if (href) {
                    // Ch·ªâ x·ª≠ l√Ω li√™n k·∫øt kh√¥ng ph·∫£i ·∫£nh
                    if (!href.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)) {
                        link.setAttribute('onclick', `showNestedInfoPopup('${href}'); return false;`);
                        link.removeAttribute('href');
                    }
                }
            });

            popup.style.display = 'block';
        })
        .catch(error => {
            console.error('L·ªói khi t·∫£i file th√¥ng tin:', error);
            popupContent.innerText = 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin.';
            popup.style.display = 'block';
        });
}

function showNestedInfoPopup(txtLink) {
    // N·∫øu l√† URL b√™n ngo√†i, m·ªü trong tab m·ªõi
    if (txtLink.startsWith('http')) {
        window.open(txtLink, '_blank');
        return;
    }

    const popup = document.getElementById('nested-info-popup');
    const popupContent = document.getElementById('nested-info-popup-content');

    fetch(txtLink)
        .then(response => {
            if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i file th√¥ng tin li√™n k·∫øt');
            return response.text();
        })
        .then(data => {
            let htmlContent = DOMPurify.sanitize(marked.parse(data));

            popupContent.innerHTML = htmlContent;

            const links = popupContent.querySelectorAll('a');
            links.forEach(link => {
                const href = link.getAttribute('href');
                if (href) {
                    if (!href.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)) {
                        link.setAttribute('onclick', `showNestedInfoPopup('${href}'); return false;`);
                        link.removeAttribute('href');
                    }
                }
            });

            popup.style.display = 'block';
        })
        .catch(error => {
            console.error('L·ªói khi t·∫£i file th√¥ng tin li√™n k·∫øt:', error);
            popupContent.innerText = 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin li√™n k·∫øt.';
            popup.style.display = 'block';
        });
}

function closeNestedInfoPopup() {
    document.getElementById('nested-info-popup').style.display = 'none';
}

function showAuthorPopup(txtLink) {
    const popup = document.getElementById('author-popup');
    const popupContent = document.getElementById('author-popup-content');

     fetch(txtLink)
        .then(response => {
            if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i file th√¥ng tin');
            return response.text();
        })
        .then(data => {
            // Chuy·ªÉn ƒë·ªïi n·ªôi dung Markdown th√†nh HTML
            let htmlContent = DOMPurify.sanitize(marked.parse(data));

            // G√°n n·ªôi dung v√†o popup
            popupContent.innerHTML = htmlContent;

            // X·ª≠ l√Ω c√°c th·∫ª <a>, nh∆∞ng b·ªè qua <img>
            const links = popupContent.querySelectorAll('a');
            links.forEach(link => {
                const href = link.getAttribute('href');
                if (href) {
                    // Ch·ªâ x·ª≠ l√Ω li√™n k·∫øt kh√¥ng ph·∫£i ·∫£nh
                    if (!href.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)) {
                        link.setAttribute('onclick', `showNestedInfoPopup('${href}'); return false;`);
                        link.removeAttribute('href');
                    }
                }
            });

            popup.style.display = 'block';
        })
        .catch(error => {
            console.error('L·ªói khi t·∫£i file th√¥ng tin:', error);
            popupContent.innerText = 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin.';
            popup.style.display = 'block';
        });
}

document.querySelectorAll('.meaning-button').forEach(button => {
    button.addEventListener('click', () => {
        console.log('Meaning button clicked:', button.getAttribute('data-value')); // Debug
        // X√≥a l·ªõp active t·ª´ t·∫•t c·∫£ c√°c n√∫t
        document.querySelectorAll('.meaning-button').forEach(btn => btn.classList.remove('active'));
        // Th√™m l·ªõp active cho n√∫t ƒë∆∞·ª£c nh·∫•n
        button.classList.add('active');
        // C·∫≠p nh·∫≠t showMeaning d·ª±a tr√™n data-value
        showMeaning = button.getAttribute('data-value') === 'show';
        console.log('showMeaning updated to:', showMeaning); // Debug
    });
});

function updateButtonVisibility() {
    const relatedBtn = document.querySelector('.related-btn');
    const magnifierBtn = document.querySelector('.magnifier-btn');
    
    if (selectedMode === 'taiwanese') {
        relatedBtn.style.display = 'inline-block';
        magnifierBtn.style.display = 'inline-block';
    } else {
        relatedBtn.style.display = 'none';
        magnifierBtn.style.display = 'none';
    }
}

function closeInfoPopup() {
    document.getElementById('info-popup').style.display = 'none';
}

function closeAuthorPopup() {
    document.getElementById('author-popup').style.display = 'none';
}

// S·ª± ki·ªán cho writeButton (d√πng trong T·ª´ V·ª±ng v√† M·∫´u C√¢u)
document.getElementById('writeButton').addEventListener('click', function() {
    if (isScrambleMode) {
        stopScrambleGame(); // T·∫Øt ch·∫ø ƒë·ªô x·∫øp ch·ªØ n·∫øu ƒëang b·∫≠t
    }
    if (!isWritingMode) {
        startWritingMode(); // B·∫≠t ch·∫ø ƒë·ªô t·∫≠p vi·∫øt
    } else {
        stopWritingMode(); // T·∫Øt ch·∫ø ƒë·ªô t·∫≠p vi·∫øt
    }
});

// S·ª± ki·ªán cho write-dialogue-button (d√πng trong H·ªôi Tho·∫°i)
document.getElementById('write-dialogue-button').addEventListener('click', function() {
    if (isScrambleMode) {
        stopScrambleGame(); // T·∫Øt ch·∫ø ƒë·ªô x·∫øp ch·ªØ n·∫øu ƒëang b·∫≠t
    }
    if (!isWritingMode) {
        startWritingMode(); // B·∫≠t ch·∫ø ƒë·ªô t·∫≠p vi·∫øt
    } else {
        stopWritingMode(); // T·∫Øt ch·∫ø ƒë·ªô t·∫≠p vi·∫øt
    }
});

document.getElementById('back-to-mode-button').addEventListener('click', () => {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('mode-selection-screen').style.display = 'block';
    // Reset c√°c tr·∫°ng th√°i n·∫øu c·∫ßn
    document.getElementById('quiz-type-buttons').style.display = 'none';
    document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
});

document.getElementById('homeButton').addEventListener('click', () => {
    if (confirm('B·∫°n c√≥ mu·ªën quay v·ªÅ m√†n h√¨nh ch·ªçn ch·∫ø ƒë·ªô? Ti·∫øn ƒë·ªô hi·ªán t·∫°i s·∫Ω b·ªã m·∫•t.')) {
        // ·∫®n c√°c container kh√¥ng c·∫ßn thi·∫øt
        document.getElementById('game-container').style.display = 'none';
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('endgame-popup').style.display = 'none';
        
        // ·∫®n c√°c b·∫£ng ch·ª©c nƒÉng
        document.getElementById('related-hanzi-list').style.display = 'none';
        document.getElementById('menuContainer').style.display = 'none';
        document.getElementById('searchContainer').style.display = 'none';
        document.getElementById('translateContainer').style.display = 'none';
        document.getElementById('hanziiContainer').style.display = 'none';
        document.getElementById('hanzi-popup').style.display = 'none';
        document.getElementById('info-popup').style.display = 'none';
        document.getElementById('author-popup').style.display = 'none';
        document.getElementById('nested-info-popup').style.display = 'none';

        // Hi·ªÉn th·ªã m√†n h√¨nh ch·ªçn ch·∫ø ƒë·ªô
        const modeSelectionScreen = document.getElementById('mode-selection-screen');
        modeSelectionScreen.style.display = 'block';
        
        // ƒê·∫£m b·∫£o c√°c th√†nh ph·∫ßn b√™n trong mode-selection-screen hi·ªÉn th·ªã
        const quizTypeButtons = document.getElementById('quiz-type-buttons');
        quizTypeButtons.style.display = 'none'; // ·∫®n n√∫t lo·∫°i √¥n t·∫≠p
        const accountInfo = document.getElementById('account-info');
        accountInfo.style.display = 'block';
        
        // ƒê·∫£m b·∫£o c√°c n√∫t ch·∫ø ƒë·ªô hi·ªÉn th·ªã
        document.querySelectorAll('.mode-button').forEach(btn => {
            btn.style.display = 'block';
            btn.classList.remove('active');
        });

        // Reset tr·∫°ng th√°i tr√≤ ch∆°i
        questionCount = 0;
        wrongHanzi = [];
        selectedHanzi = [];
        isReviewMode = false;
        isScrambleMode = false;
        isWritingMode = false;
        isNewWordMode = false;
        currentScrambleAnswer = '';
        currentCharIndex = 0;
        randomMissionLesson = null; // Reset nhi·ªám v·ª• ng·∫´u nhi√™n
        earnedEXP = 0; // Reset EXP ki·∫øm ƒë∆∞·ª£c
document.getElementById('earned-exp').textContent = `ƒêi·ªÉm: ${earnedEXP}`;

        // Reset giao di·ªán tr√≤ ch∆°i
        document.getElementById('answerInput').value = '';
        document.getElementById('answerInput').disabled = false;
        document.getElementById('playButton').disabled = false;
        document.getElementById('hintButton').disabled = false;
        document.getElementById('wrong-hanzi-list').innerHTML = '';
        document.getElementById('review-hanzi-list').innerHTML = '';
        document.getElementById('review-hanzi-display').style.display = 'none';
        document.getElementById('option-buttons').innerHTML = '';
        document.getElementById('scrambled-buttons').innerHTML = '';
        document.getElementById('dialogue-container').innerHTML = '';
        document.getElementById('writing-container').style.display = 'none';
        document.getElementById('pinyin-container').style.display = 'none';
        document.getElementById('phanTich-container').style.display = 'none';
        document.getElementById('meaning-container').style.display = 'none';
        document.getElementById('dialogue-display').style.display = 'none';

        // Reset c√°c tr∆∞·ªùng input
        document.getElementById('lesson-input').value = '';
        document.getElementById('word-count').value = '30';
        document.getElementById('time-limit').value = '20';
        document.getElementById('dialogue-number').value = '';

        // Reset audio
        const audio = document.getElementById('audio');
        audio.src = '';
        audio.pause();

        // D·ª´ng timer n·∫øu ƒëang ch·∫°y
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        // ƒê·∫£m b·∫£o header-container hi·ªÉn th·ªã
        document.querySelector('.header-container').style.display = 'block';

        // T·∫£i l·∫°i d·ªØ li·ªáu t√†i kho·∫£n ƒë·ªÉ ƒë·∫£m b·∫£o th√¥ng tin m·ªõi nh·∫•t
        loadAccountData();
    }
});

function returnToModeSelection() {
    // ·∫®n popup
    document.getElementById('hanzi-popup').style.display = 'none';

    // ·∫®n game-container
    document.getElementById('game-container').style.display = 'none';

    // Hi·ªÉn th·ªã mode-selection-screen
    document.getElementById('mode-selection-screen').style.display = 'block';

    // Reset tr·∫°ng th√°i tr√≤ ch∆°i
    document.getElementById('quiz-type-buttons').style.display = 'none';
    document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
    questionCount = 0;
    wrongHanzi = [];
    selectedHanzi = [];
    isReviewMode = false;
    isScrambleMode = false;
    isWritingMode = false;
    isNewWordMode = false;
    currentScrambleAnswer = '';
    currentCharIndex = 0;
    document.getElementById('answerInput').value = '';
    document.getElementById('answerInput').disabled = false;
    document.getElementById('playButton').disabled = false;
    document.getElementById('hintButton').disabled = false;
    document.getElementById('wrong-hanzi-list').innerHTML = '';
    document.getElementById('review-hanzi-list').innerHTML = '';
    document.getElementById('review-hanzi-display').style.display = 'none';

    // Reset c√°c tr∆∞·ªùng input
    document.getElementById('lesson-input').value = '';
    document.getElementById('word-count').value = '30';
    document.getElementById('time-limit').value = '20';
    document.getElementById('dialogue-number').value = '';

// ƒê√≥ng endgame-popup
    const popup = document.getElementById('endgame-popup');
    if (popup) {
        popup.style.display = 'none';
    }

    // Reset c√°c bi·∫øn v√† tr·∫°ng th√°i tr√≤ ch∆°i (n·∫øu c·∫ßn)
    isReviewMode = false;
    questionCount = 0;
    wrongHanzi = [];
    currentReviewList = [];
    selectedHanzi = [];
    totalWords = 0;

    // Chuy·ªÉn v·ªÅ m√†n h√¨nh ch·ªçn ch·∫ø ƒë·ªô
    document.getElementById('mode-selection').style.display = 'block';
    document.getElementById('quiz-container').style.display = 'none';
    document.getElementById('review-hanzi-display').style.display = 'none';

    // B·∫≠t l·∫°i c√°c n√∫t v√† input n·∫øu c·∫ßn
    document.getElementById('answerInput').disabled = false;
    document.getElementById('playButton').disabled = false;
    document.getElementById('hintButton').disabled = false;
}

// X·ª≠ l√Ω checkbox hi·ªán m·∫≠t kh·∫©u cho ƒëƒÉng nh·∫≠p
document.getElementById('show-login-pass').addEventListener('change', function() {
    const passwordInput = document.getElementById('login-pass');
    passwordInput.type = this.checked ? 'text' : 'password';
});

// X·ª≠ l√Ω checkbox hi·ªán m·∫≠t kh·∫©u cho ƒëƒÉng k√Ω
document.getElementById('show-register-pass').addEventListener('change', function() {
    const passwordInput = document.getElementById('register-pass');
    passwordInput.type = this.checked ? 'text' : 'password';
});
// Danh s√°ch link YouTube
const youtubeLinks = [
    'https://www.youtube.com/watch?v=YtJmoUiMmhY',
    'https://www.youtube.com/watch?v=4F6ssqaefdg',
    'https://www.youtube.com/watch?v=0fNAnbo3LAs'
];

// H√†m ch·ªçn v√† ph√°t video ng·∫´u nhi√™n v·ªõi loop
function playRandomYouTubeVideo() {
    const randomIndex = Math.floor(Math.random() * youtubeLinks.length);
    const videoUrl = youtubeLinks[randomIndex];
    const videoId = videoUrl.split('v=')[1].split('&')[0]; // L·∫•y ID video
    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1&playlist=${videoId}`;
    document.getElementById('youtube-player').src = embedUrl;
}

// Ph√°t video khi t·∫£i m√†n h√¨nh ƒëƒÉng nh·∫≠p
playRandomYouTubeVideo();

// Ph√°t video m·ªõi khi chuy·ªÉn t·ª´ ƒëƒÉng k√Ω v·ªÅ ƒëƒÉng nh·∫≠p
document.getElementById('show-login').addEventListener('click', () => {
    document.getElementById('login-container').style.display = 'block';
    document.getElementById('register-container').style.display = 'none';
    document.getElementById('auth-error').style.display = 'none';
    playRandomYouTubeVideo(); // Ph√°t video ng·∫´u nhi√™n
});
</script>
</body>
</html>
