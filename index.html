<html lang="en">
<head>
    <script src="/hoctiengtrung/hanzi-writer.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Quiz</title>
 <style>
/* NhÃ³m 1: CSS chung (Global Styles) */
body {
            font-family: arial;
            font-size: 20px;
            text-align: center;
            color: black;
            background-color: white;
            background-image: url("/hoctiengtrung/anhnen3.jpg");
            background-size: 480px auto;
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed; /* Add this line to fix the background image */
            margin: 0 auto;
            padding: 0;
            max-width: 480px;
            min-height: 100vh;
            position: relative;
        }
@font-face {
            font-family: hz;
            src: url("/hoctiengtrung/KaiTi-1.ttf");
        }
.header-container {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
    width: 100%;
}
.correct {
    background-color: green !important;
}
.incorrect {
    background-color: red;
}
button {
    font-size: 30px;
    padding: 5px;
    font-family: hz;
    border-radius: 10px;
    border: none;
    background-color: rgba(255, 255, 255, 0.7);
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    width: 100%;
    justify-content: center;
    text-align: left;
}
button2 {
    font-size: 20px;
    padding: 5px;
    border-radius: 20px;
    border: none;
    background-color: rgba(255, 255, 255, 0.7);
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    margin-right: 0;
}

/* NhÃ³m 2: MÃ n hÃ¬nh chá»n cháº¿ Ä‘á»™ vÃ  khá»Ÿi Ä‘á»™ng */
#mode-selection-screen {
    text-align: center;
    margin-top: 50px;
}
#mode-selection-screen button2.mode-button {
    font-size: 18px;
    padding: 8px 16px;
    width: 200px;
    background-color: #4CAF50 !important;
    color: white;
    font-family: Arial;
    cursor: pointer;
    border-radius: 10px;
    border: none;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    margin: 5px;
}
#mode-selection-screen button2.mode-button.active {
    background-color: #55edbd !important;
}
#mode-selection-screen button2.mode-button:hover:not(.active) {
    background-color: #f2921d !important;
}
#mode-selection-screen button2.mode-button:disabled,
#mode-selection-screen button2.mode-button.disabled {
    background-color: #e0e0e0 !important;
    cursor: not-allowed;
    opacity: 0.6;
}
.mode-button {
    font-size: 24px;
    padding: 10px 20px;
    width: 300px;
    background-color: #4CAF50;
    color: white;
    font-family: Arial;
    cursor: pointer;
}
.mode-button:hover {
    background-color: #45a049;
}
.mode-button.disabled {
    pointer-events: none;
    opacity: 0.5;
    cursor: not-allowed;
    background-color: #cccccc;
}
.quiz-type-button {
    font-size: 18px;
    padding: 8px 10px;
    width: 95px;
    background-color: #2196F3;
    color: white;
    font-family: Arial;
    cursor: pointer;
    border-radius: 10px;
    border: none;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
	cursor: pointer;
}
.quiz-type-button.quiz-type-active {
    background-color: #2451f2; /* MÃ u xanh khi Ä‘Æ°á»£c chá»n */
    color: white; /* Chá»¯ tráº¯ng Ä‘á»ƒ dá»… Ä‘á»c */
}
.quiz-type-button:hover {
    background-color: #55edbd;
}
.quiz-type-button:disabled {
    pointer-events: none;
    opacity: 0.5;
    background-color: #cccccc;
}
#quiz-type-buttons {
    display: flex;
    margin-top: 10px;
    justify-content: center;
    gap: 5px;
    flex-wrap: wrap
}
#start-screen {
    text-align: center;
    margin-top: 50px;
}
#start-screen input {
    font-size: 20px;
    padding: 5px;
    width: 100px;
    margin-right: 10px;
    margin-bottom: 10px;
}
#start-screen button2 {
    font-size: 20px;
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    font-family: arial;
}
#start-screen input[type="number"],
#start-screen input[type="text"] {
    width: 250px;
    padding: 8px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
}
#start-screen input[type="number"]::-webkit-inner-spin-button,
#start-screen input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
#start-screen input[type="number"] {
    -moz-appearance: textfield;
}
.welcome-title {
    font-family: Arial;
    font-size: 30px;
    font-weight: bold;
    color: blue;
    white-space: pre-line;
    text-align: center;
}

/* NhÃ³m 3: Giao diá»‡n trÃ² chÆ¡i chÃ­nh */
#game-container {
    display: none;
}
#status-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 0 10px 10px 10px;
    margin-top: 0px;
    padding: 0px;
}
#timer {
    font-size: 18px;
    color: orange;
}
#total-count {
    font-size: 15px;
    color: blue;
}
#wrong-count {
    font-size: 15px;
    color: red;
}
#review-mode {
    font-size: 15px;
    color: green;
    display: none;
}
#meaning-container {
    text-align: left;
    margin-bottom: 5px;
    margin-top: -10px;
}
#meaning-container p {
    margin-bottom: 0;
}
#pinyin-container {
    text-align: center;
    margin-top: 0;
    display: flex;
    justify-content: center;
    gap: 5px;
    background-color: rgba(255, 255, 255, 0.7);
    padding: 10px;
    border-radius: 10px;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    width: 100%;
    box-sizing: border-box;
    display: none;
}
.pinyin-kyhieu-group {
    text-align: center;
    margin-top: 0;
    display: flex;
    justify-content: center;
    gap: 5px;
}
#pinyin {
    font-size: 20px;
    color: blue;
    display: none;
}
#kyhieu {
    font-size: 20px;
    color: red;
    display: none;
}
#question {
    font-size: 35px;
    font-family: hz;
    color: #000000;
    margin-bottom: 0px;
    text-align: center;
}
#meaning, #pinyin, #kyhieu, #phanTich, #question {
    white-space: pre-wrap;
}
#phanTich-container {
    text-align: left;
    margin-top: 10px;
    background-color: rgba(255, 255, 255, 0.7);
    padding: 10px;
    border-radius: 10px;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    width: 100%;
    box-sizing: border-box;
    display: none;
}
#phanTich {
    font-size: 20px;
    color: purple;
    display: none;
    white-space: pre-wrap;
}
#dialogue-container {
    padding: 0px;
    width: 100%;
    box-sizing: border-box;
    margin-top: 10px;
}
.dialogue-box {
    font-size: 30px;
    margin: 0px;
    padding: 5px;
    border-radius: 10px;
    background-color: rgba(255, 255, 255, 0.7);
    display: inline-block;
    font-family: hz;
    width: 100%;
    box-sizing: border-box;
    white-space: pre-wrap;
}
.dialogue-box .nhanvat {
    margin-right: 0px;
    display: inline;
}
.dialogue-box span {
    display: inline;
}
.dialogue-box.kieu-A {
    background-color: rgba(255, 182, 193, 0.8);
    text-align: left;
    width: 100%;
    box-sizing: border-box;
}
.dialogue-box.kieu-B {
    background-color: rgba(173, 216, 230, 0.8);
    text-align: left;
    width: 100%;
    box-sizing: border-box;
}
.dialogue-box.kieu-C {
    background-color: rgba(173, 255, 47, 0.8);
    text-align: left;
    width: 100%;
    box-sizing: border-box;
}
.dialogue-box.kieu-D {
    background-color: rgba(173, 255, 47, 0.8);
    text-align: left;
    width: 100%;
    box-sizing: border-box;
}
.dialogue-box.kieu-E {
    background-color: rgba(255, 255, 255, 0.5);
    text-align: center;
    box-sizing: border-box;
    font-size: 40px;
    font-weight: bold;
}
.dialogue-box.kieu-F {
    background-color: rgba(255, 255, 255, 0.5);
    text-align: center;
    box-sizing: border-box;
    font-size: 25px;
}
.dialogue-box.kieu-G {
    background-color: rgba(255, 255, 255, 0.5);
    text-align: center;
    box-sizing: border-box;
    font-size: 35px;
}
.nhanvat {
    color: blue;
    font-weight: bold;
}
#word-scramble-game {
    display: none;
    text-align: left;
    margin-top: 0px;
    position: relative;
    width: 100%;
}
#scrambled-input {
    font-size: 20px;
    padding: 5px 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
    background-color: rgba(255, 255, 255, 0.7);
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    text-align: left;
    min-height: 30px;
    width: 100%;
    margin: 0 auto 10px auto;
    display: block;
    box-sizing: border-box;
    display: none;
}
#scrambled-buttons {
    display: flex;
    flex-wrap: wrap;
    justify-content: left;
    max-width: 100%;
    margin-top: 5px;
}
#scrambled-buttons button {
    font-size: 30px;
    padding: 5px;
    border-radius: 10px;
    border: none;
    background-color: rgba(255, 255, 255, 0.7);
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 35px;
    height: 35px;
    gap: 1px;
    margin: 1px;
}
#scrambled-buttons button.incorrect {
    background-color: red !important;
    color: white;
}
#writing-container {
    display: none;
    text-align: center;
    margin: 20px auto;
    background-color: rgba(255, 255, 255, 0.7);
    padding: 10px;
    border-radius: 10px;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}
#writing-canvas {
    width: 200px;
    height: 200px;
    margin: 0 auto;
    border: 2px solid rgba(255, 105, 180, 0.5);
    border-radius: 5px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    position: relative;
    overflow: hidden;
    background: linear-gradient(to right, rgba(255, 105, 180, 0.3) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 105, 180, 0.3) 1px, transparent 1px);
    background-size: 33.33% 33.33%;
}
#current-char {
    font-size: 40px;
    font-family: hz;
    margin: 10px 0;
}
#writing-progress {
    font-size: 20px;
    color: blue;
    margin-top: 10px;
    display: inline;
    vertical-align: middle;
}
.toggle-outline-button {
    font-size: 14px;
    padding: 5px 10px;
    border-radius: 5px;
    background-color: #2196F3;
    color: white;
    border: none;
    cursor: pointer;
    margin-right: 10px;
    vertical-align: middle;
    width: 80px;
    height: 30px;
    box-sizing: border-box;
}
.toggle-outline-button:hover {
    opacity: 0.9;
}
#writing-container > div {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: nowrap;
}
.button-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
	margin-top: 10px;
}
.input-container {
    text-align: center;
    margin-top: -10px;
    padding: 20px;
}
.answer-input {
    font-size: 20px;
    padding: 5px 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
    background-color: rgba(255, 255, 255, 0.7);
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    width: 200px;
    text-align: center;
}
.button-container {
    text-align: center;
    padding: 5px;
    margin-top: 0px;
    margin-bottom: 0px;
}
#meaning-display-buttons button2.meaning-button {
    font-size: 16px;
    padding: 6px 12px;
    width: 80px;
    background-color: #cccccc !important;
    color: white;
    font-family: Arial;
    cursor: pointer;
    border-radius: 5px;
    border: none;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}
#meaning-display-buttons button2.meaning-button.active {
    background-color: #2196F3 !important;
}
#meaning-display-buttons button2.meaning-button:hover:not(.active) {
    background-color: #b0b0b0 !important;
}
#feedback {
    font-size: 24px;
    text-align: center;
    margin-top: 20px;
    display: none;
}
#dice-button {
    display: none !important;
}

/* NhÃ³m 4: Popup vÃ  panel phá»¥ */
#completion-message {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 35px;
    color: green;
    background-color: rgba(255, 255, 255, 0.9);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
	width: 90%;
}
#hanzi-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    z-index: 1000;
    max-width: 400px;
    width: 90%;
    max-height: 80vh; /* Giá»›i háº¡n chiá»u cao tá»‘i Ä‘a */
    overflow-y: auto; /* ThÃªm thanh cuá»™n dá»c khi ná»™i dung dÃ i */
    text-align: left;
    font-size: 18px;
    font-family: Arial, sans-serif;
}
#hanzi-popup p {
    margin: 5px 0;
    white-space: pre-wrap; /* Äáº£m báº£o xuá»‘ng dÃ²ng theo \n */
}
#hanzi-popup hr {
    margin: 10px 0;
    border: 0;
    border-top: 1px solid #ccc;
}
#hanzi-popup .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 20px;
    cursor: pointer;
    color: #333;
}
#hanzi-popup .close-btn:hover {
    color: #FF0000;
}
#hanzi-popup-content {
    line-height: 1.5;
    text-align: left; /* Äáº£m báº£o ná»™i dung cÄƒn trÃ¡i */
}
#info-popup, #author-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    z-index: 1000;
    max-width: 500px;
    width: 90%;
    text-align: left;
    font-size: 16px;
    font-family: Arial;
    max-height: 80vh;
    overflow-y: auto;
}
#info-popup .close-btn, #author-popup .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 20px;
    cursor: pointer;
    color: #333;
}
#info-popup .close-btn:hover, #author-popup .close-btn:hover {
    color: #FF0000;
}
#author-popup img {
    max-width: 100%;
    height: auto;
    display: block;
    margin-bottom: 10px;
    max-height: 250px;
    margin: 0 auto;
}
#info-popup-content, #author-popup-content {
    white-space: pre-wrap;
}
#nested-info-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    z-index: 1001;
    max-width: 500px;
    width: 90%;
    text-align: left;
    font-size: 16px;
    font-family: Arial;
    max-height: 80vh;
    overflow-y: auto;
}
#nested-info-popup .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 20px;
    cursor: pointer;
    color: #333;
}
#nested-info-popup .close-btn:hover {
    color: #FF0000;
}
#nested-info-popup-content {
    white-space: pre-wrap;
}
#nested-info-popup-content a {
    display: inline-block;
    font-size: 16px;
    padding: 5px 10px;
    margin: 2px;
    border-radius: 5px;
    border: none;
    background-color: #4CAF50;
    color: white;
    text-decoration: none;
    cursor: pointer;
    font-family: Arial;
}
#nested-info-popup-content a:hover {
    background-color: #45a049;
}
.hanzi-clickable {
    cursor: pointer;
    color: #000000;
}
.hanzi-clickable:hover {
    color: #FF0000;
}

/* NhÃ³m 5: CÃ´ng cá»¥ há»— trá»£ */
.menu-container {
    display: none;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 1000;
    width: 96%;
    max-width: 1200px;
    margin: 20px auto;
    position: static;
    border-radius: 10px;
    background-color: rgba(255, 255, 255, 0.8);
}
.volume-buttons {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-gap: 5px;
    margin-bottom: 10px;
}
.volume-btn {
    font-size: 16px;
    padding: 5px 5px;
    cursor: pointer;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 5px;
    text-align: center;
    font-family: Arial;
    width: 100%;
    box-sizing: border-box;
}
.volume-btn.active {
    background-color: #4CAF50;
    color: white;
}
.lesson-buttons {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    grid-gap: 5px;
    margin-bottom: 10px;
}
.lesson-btn {
    font-size: 14px;
    padding: 1px 5px;
    cursor: pointer;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 5px;
    text-align: center;
    font-family: arial;
    width: 100%;
    box-sizing: border-box;
}
.lesson-btn.active {
    background-color: #4CAF50;
    color: white;
}
.table-container {
    margin: 0px auto;
    width: 100%;
    max-width: 1200px;
    font-size: 12px;
}
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
}
tr:hover {
    background-color: #f5f5f5;
    cursor: pointer;
}
.search-container {
    text-align: center;
    margin: 20px auto;
    display: none;
}
.search-input {
    padding: 5px;
    font-size: 16px;
    width: 200px;
}
.search-btn {
    padding: 5px 10px;
    font-size: 16px;
    cursor: pointer;
    margin-left: 10px;
    border-radius: 5px;
    border: none;
    background-color: rgba(255, 255, 255, 0.7);
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    margin-right: 5px;
    cursor: pointer;
    font-family: arial;
}
.hanzii-container {
    width: 100%;
    height: 2000px;
    overflow: hidden;
    position: relative;
    margin-top: 20px;
    display: none;
}
.hanzii-container iframe {
    position: absolute;
    top: -250px;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}
.translate-container {
    width: 100%;
    height: 300px;
    overflow: hidden;
    position: relative;
    margin-top: 20px;
    display: none;
}
.translate-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}
.iframe-container {
    width: 100%;
    height: 3000px;
    overflow: hidden;
    position: relative;
    margin-top: 20px;
    display: none;
}
.iframe-container iframe {
    position: absolute;
    top: -300px;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}
#related-hanzi-list {
    display: none;
    margin-top: 20px;
    text-align: left;
    font-size: 18px;
    overflow-y: auto;
    border: none;
    padding: 10px;
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 20px;
    width: 100%;
    max-width: 100%;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    height: auto;
    box-sizing: border-box;
}
#related-hanzi-list p {
    margin: 5px 0;
}
#sub-mode-buttons {
    flex-wrap: wrap;
    width: 100%;
    justify-content: center;
	display: flex;
    flex-direction: row;
    gap: 10px;
    margin-top: 10px;
}
.sub-mode-button {
    background-color: #f77219;
    font-size: 18px; /* Nhá» hÆ¡n nÃºt gá»‘c */
    padding: 4px 8px; /* Nhá» hÆ¡n nÃºt gá»‘c */
    color: white; /* Chá»¯ tá»‘i Ä‘á»ƒ dá»… Ä‘á»c */
}
button3 {
    font-size: 16px;
    padding: 5px 10px;
    border-radius: 5px; /* Bo gÃ³c */
    border: 0px;
    background-color: #2196F3;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
	color: white; /* Chá»¯ tráº¯ng */
    margin-right: 0;
	cursor: pointer;
}

button3.read-complete-button:hover {
    background-color: #1976D2; /* Äáº­m hÆ¡n khi hover */
}
#read-complete-container {
    display: flex;
    align-items: center; /* CÄƒn giá»¯a theo chiá»u dá»c */
    justify-content: center; /* CÄƒn giá»¯a theo chiá»u ngang */
    gap: 10px; /* Khoáº£ng cÃ¡ch giá»¯a nÃºt vÃ  chá»¯ */
    margin-top: 10px;
}

.read-complete-text {
    font-size: 14px;
    color: #333; /* MÃ u chá»¯ tá»‘i */
}
#learn-another-button {
    width: 200px;
    background-color: #4CAF50;
}
#learn-another-button:hover {
    background-color: #45a049;
}
.popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
.popup-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.8);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    margin: 0;
}
#lesson-list-button {
    font-size: 16px;
    padding: 5px 10px;
    border-radius: 5px;
    border: none;
    background-color: #2196F3;
    color: white;
    cursor: pointer;
    margin-bottom: 10px;
}

#lesson-list-container {
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 5px;
    padding: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

#lesson-list-table {
    font-family: 'Noto Sans CJK SC', Arial, sans-serif;
    font-size: 14px;
}

#lesson-list-table th, #lesson-list-table td {
    padding: 8px;
    text-align: center;
    border: 1px solid #ccc;
}

#lesson-list-table tbody tr {
    cursor: pointer;
}

#lesson-list-table tbody tr:hover {
    background-color: #f0f0f0;
}
#lesson-list-table tbody tr.locked {
    color: #888;
    cursor: not-allowed;
}

#lesson-list-table tbody tr.locked:hover {
    background-color: transparent;
}

#random-mission-container {
    background-color: rgba(255, 255, 255, 0.9);
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}
#account-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
    font-size: 20px;
    gap: 10px;
}

#account-image {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
}

#account-info > div {
    text-align: center;
}

#account-info .progress-container {
    width: 200px;
    height: 20px;
    background-color: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
}

#level-progress {
    width: 0%;
    height: 100%;
    background-color: #4CAF50;
    border-radius: 10px;
    transition: width 0.5s ease-in-out;
    display: flex;
    align-items: center;
    justify-content: center;
}

#level-progress-text {
    color: white;
    font-size: 14px;
    text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
    position: absolute;
    width: 100%;
    text-align: center;
}
#earned-exp {
    font-size: 20px;
    color: green;
}
.auth-screen {
    display: block;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 1);
    background-size: cover;
    background-position: center;
    z-index: 1000;
    font-family: 'Noto Sans CJK SC', Arial, sans-serif;
    overflow-y: auto; /* Cho phÃ©p cuá»™n náº¿u ná»™i dung quÃ¡ dÃ i */
}

.auth-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start; /* Báº¯t Ä‘áº§u tá»« trÃªn Ä‘á»ƒ trÃ¡nh cÄƒn giá»¯a gÃ¢y lá»‡ch */
    min-height: 100vh; /* Chiá»u cao tá»‘i thiá»ƒu báº±ng mÃ n hÃ¬nh */
    background-image: url('/hoctiengtrung/nen.jpg'); /* Thay báº±ng link áº£nh ná»n cá»§a báº¡n */
    background-size: cover; /* Äáº£m báº£o áº£nh phá»§ toÃ n bá»™ container */
    background-position: center bottom; /* CÄƒn áº£nh vá» phÃ­a dÆ°á»›i */
    padding: 30px;
    max-width: 400px;
    margin: 20px auto; /* CÄƒn giá»¯a vá»›i lá» trÃªn/dÆ°á»›i */
    box-sizing: border-box;
    overflow-y: auto; /* Cho phÃ©p cuá»™n bÃªn trong náº¿u ná»™i dung dÃ i */
}

.auth-container h2 {
    color: #333;
    margin-bottom: 20px;
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
    max-width: 300px;
}

.input-group input {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
    width: 100%;
    box-sizing: border-box;
}

.show-password {
    padding: 0px;
    display: flex;
    align-items: center;
    font-size: 14px;
    color: white;
    cursor: pointer;
    white-space: nowrap;
}

.show-password input[type="checkbox"] {
    margin: 10px; /* XÃ³a margin máº·c Ä‘á»‹nh cá»§a checkbox */
    padding: 0; /* XÃ³a padding máº·c Ä‘á»‹nh */
    width: 16px; /* KÃ­ch thÆ°á»›c checkbox */
    height: 16px;
margin-left: 50px; /* Dá»‹ch sang pháº£i 10px */
}

.auth-button {
    padding: 10px 20px;
    background-color: #2196F3;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 25px !important; /* Báº¯t buá»™c Ã¡p dá»¥ng */
    font-family: 'Arial', sans-serif;
    margin: 5px;
    transition: background-color 0.3s;
    display: flex; /* CÄƒn giá»¯a theo cáº£ hai chiá»u */
    justify-content: center; /* CÄƒn giá»¯a ngang */
    align-items: center; /* CÄƒn giá»¯a dá»c */
    text-align: center; /* Äáº£m báº£o cÄƒn giá»¯a ngang */
    line-height: 1; /* Äiá»u chá»‰nh chiá»u cao dÃ²ng */
    width: auto; /* NÃºt má»Ÿ rá»™ng theo ná»™i dung */
}

.auth-button:hover {
    background-color: #1976D2;
}

.toggle-link {
    margin-top: 5px;
    font-size: 14px;
    color: white;
}

.toggle-link a {
    color: #2196F3;
    text-decoration: none;
}

.toggle-link a:hover {
    text-decoration: underline;
}

.auth-error {
    color: red;
    font-size: 14px;
    margin-top: 3px;
    display: none;
}

/* áº¨n header-container khi auth-screen hiá»ƒn thá»‹ */
.auth-screen ~ .header-container {
    display: none;
}
#login-logo {
    display: block;
    margin-top: 20px;
    margin-bottom: 0px;
    width: 300px;
    height: auto;
}

.youtube-container {
    margin-top: 20px;
    display: flex;
    justify-content: center;
}

#youtube-player {
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}
.promo-title {
    color: white;
    font-size: 25px;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5), 
                 0 0 10px rgba(255, 255, 255, 0.8), 
                 0 0 20px rgba(255, 255, 255, 0.6);
    margin: 0; /* Giá»¯ margin máº·c Ä‘á»‹nh */
    margin-bottom: 10px; /* ThÃªm 10px bÃªn dÆ°á»›i */
    text-align: center;
}

.button-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    margin-top: 0px;
}

.promo-button {
    padding: 8px 15px;
    background-color: #f39821;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    font-size: 14px;
    transition: background-color 0.3s;
    width: 200px; /* Äáº·t chiá»u rá»™ng cá»‘ Ä‘á»‹nh cho nÃºt */
    text-align: center; /* CÄƒn giá»¯a chá»¯ trong nÃºt */
}

.promo-button:hover {
    background-color: #1976D2;
}
.divider {
    width: 100%;
    height: 1px;
    background-color: white;
    margin-bottom: 10px; /* ThÃªm 10px bÃªn dÆ°á»›i */
}
.content-wrapper {
    padding: 0 10px; /* ThÃªm padding trÃ¡i vÃ  pháº£i */
    box-sizing: border-box;
    max-width: 480px; /* Háº¹p hÆ¡n 480px cá»§a body Ä‘á»ƒ táº¡o khoáº£ng cÃ¡ch */
    margin: 0 auto; /* CÄƒn giá»¯a div */
}
</style>
</head>
<body>
   <!-- NhÃ³m 1: Header -->
<div class="header-container">
    <img src="/hoctiengtrung/anhnenmoi.png" style="width: 100%; height: auto;">
</div>
<div id="auth-screen" class="auth-screen">
    <div class="auth-container">
<img id="login-logo" src="/hoctiengtrung/logo.jpg" alt="Login Banner" width="300" height="auto">
<div class="welcome-text" style="color: white; text-align: center; font-size: 14px; margin-bottom: 10px; margin: 5px 0;">
    <p style="margin: 5px 0;">ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i â€œHá»c Tiáº¿ng Trung Phá»“n Thá»ƒâ€!</p>
    <p style="margin: 5px 0;">Tráº£i nghiá»‡m cÃ¡ch há»c chá»¯ HÃ¡n truyá»n thá»‘ng káº¿t há»£p phÆ°Æ¡ng phÃ¡p há»c thÃ´ng minh, trá»±c quan.</p>
    <p style="margin: 5px 0;">HÃ£y ÄÄƒng Nháº­p Ä‘á»ƒ báº¯t Ä‘áº§u hÃ nh trÃ¬nh há»c sÃ¢u, nhá»› lÃ¢u, hiá»ƒu rá»™ng chá»¯ HÃ¡n truyá»n thá»‘ng!</p>
</div>
<div class="divider"></div>
        <div id="login-container">
            <div class="input-group">
                <input type="text" id="login-user" placeholder="TÃªn Ä‘Äƒng nháº­p" required>
                <input type="password" id="login-pass" placeholder="Máº­t kháº©u" required>
                <label class="show-password">
                    <input type="checkbox" id="show-login-pass"> Hiá»‡n máº­t kháº©u
                </label>
                <button id="login-button" class="auth-button">ÄÄƒng Nháº­p</button>
                <p id="login-error" class="auth-error"></p>
                <p class="toggle-link">ChÆ°a cÃ³ tÃ i khoáº£n? <a href="#" id="show-register">ÄÄƒng kÃ½ ngay</a></p>
            </div>
        </div>
        <div id="register-container" style="display: none;">
            <div class="input-group">
                <input type="text" id="register-name" placeholder="TÃªn hiá»ƒn thá»‹" required>
                <input type="text" id="register-user" placeholder="TÃªn Ä‘Äƒng nháº­p" required>
                <input type="password" id="register-pass" placeholder="Máº­t kháº©u" required>
                <label class="show-password">
                    <input type="checkbox" id="show-register-pass"> Hiá»‡n máº­t kháº©u
                </label>
                <button id="register-button" class="auth-button">ÄÄƒng KÃ½</button>
                <p id="register-error" class="auth-error"></p>
                <p class="toggle-link">ÄÃ£ cÃ³ tÃ i khoáº£n? <a href="#" id="show-login">ÄÄƒng nháº­p</a></p>
            </div>
        </div>
<div class="divider"></div>
        <div class="promo-section">
            <h3 class="promo-title">Ná»€N VÄ‚N MINH 5.000 NÄ‚M Há»’I SINH</h3>
            <div id="youtube-container">
                <iframe id="youtube-player" width="300" height="169" src="" frameborder="0" allowfullscreen></iframe>
            </div>
<h5 style="color: white; text-align: justify; margin: 5px 0;">Shen Yun lÃ  Ä‘oÃ n nghá»‡ thuáº­t mÃºa cá»• Ä‘iá»ƒn Trung Quá»‘c hÃ ng Ä‘áº§u tháº¿ giá»›i, thÃ´ng qua loáº¡i hÃ¬nh nghá»‡ thuáº­t cá»• Ä‘iá»ƒn Ä‘á»ƒ phá»¥c hÆ°ng vÃ  há»“ng dÆ°Æ¡ng vÄƒn hÃ³a truyá»n thá»‘ng Trung Hoa chÃ¢n chÃ­nh gáº§n nhÆ° Ä‘Ã£ bá»‹ tháº¥t láº¡c.</h5>
            <div class="button-group">
                <a href="https://vi.shenyunperformingarts.org/" target="_blank" class="promo-button">TÃ¬m hiá»ƒu SHENYUN</a>
                <a href="https://www.shenyuncreations.com/vi-VN" target="_blank" class="promo-button">Xem SHENYUN online</a>
            </div>
      <br>
<br>
<br>
<br>
<br>
        </div>
    </div>
</div>

<!-- NhÃ³m 2: MÃ n hÃ¬nh chá»n cháº¿ Ä‘á»™ vÃ  khá»Ÿi Ä‘á»™ng -->
<!-- MÃ n hÃ¬nh chá»n cháº¿ Ä‘á»™ -->
<div id="mode-selection-screen" style="text-align: center; margin-top: 30px;">
<div id="account-info" style="display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; font-size: 20px; gap: 10px;">
    <img id="account-image" src="" alt="Avatar" style="width: 200px; height: 200px; border-radius: 10%; object-fit: cover;">
    <div style="text-align: center;">
        <span id="account-name"></span>
    </div>
 <div style="text-align: center;">
        <span id="account-danhHieu">A</span>
    </div>
    <div style="text-align: center;">
        Há»c lá»±c: <span id="account-exp">0</span> Ä‘iá»ƒm
    </div>
    <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
        <div style="text-align: center;">
            Cáº¥p: <span id="account-level">1</span>
        </div>
        <div style="width: 200px; height: 20px; background-color: #e0e0e0; border-radius: 10px; overflow: hidden; position: relative;">
            <div id="level-progress" style="width: 0%; height: 100%; background-color: #4CAF50; border-radius: 10px; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center;">
                <span id="level-progress-text" style="color: white; font-size: 14px; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); position: absolute; width: 100%; text-align: center;">0%</span>
            </div>
        </div>
    </div>
</div>
    <div style='font-family: "Arial"; font-size: 30px; font-weight: bold; color: blue;'>
        Chá»n cháº¿ Ä‘á»™ há»c
    </div>
<!-- Container cho cÃ¡c nÃºt loáº¡i Ã´n táº­p -->
    <div id="quiz-type-buttons" style="display: none; margin-top: 10px; justify-content: center; gap: 5px;"></div>
 <br>
    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
        <button2 class="mode-button" data-mode="taiwanese">Tiáº¿ng Trung ÄÃ i Loan</button2>
        <button2 class="mode-button" data-mode="samtukinh">Tam Tá»± Kinh</button2>
        <button2 class="mode-button disabled" data-mode="thientuvan" disabled>ThiÃªn Tá»± VÄƒn</button2>
        <button2 class="mode-button" data-mode="poetry">300 BÃ i ThÆ¡ ÄÆ°á»ng</button2>
        <button2 class="mode-button disabled" data-mode="hongngam" disabled>Há»“ng NgÃ¢m</button2>
    </div>
    
</div>

<!-- MÃ n hÃ¬nh khá»Ÿi Ä‘á»™ng -->
<div id="start-screen" style="display: none;">
    <div class="welcome-title"></div>
    <br>
    <div>
        <label>Dá»‹ch nghÄ©a:</label>
        <div id="meaning-display-buttons" style="display: flex; justify-content: center; gap: 5px; margin-top: 5px;">
            <button2 class="meaning-button active" data-value="show">Hiá»‡n</button2>
            <button2 class="meaning-button" data-value="hide">áº¨n</button2>
        </div>
    </div>
    <br>
<!-- ThÃªm nÃºt Danh sÃ¡ch bÃ i vÃ  container cho báº£ng -->
    <div>
        <button2 id="lesson-list-button" class="quiz-type-button">Danh sÃ¡ch bÃ i</button2>
        <div id="lesson-list-container" style="display: none; margin-top: 10px; max-height: 300px; overflow-y: auto;">
            <table id="lesson-list-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ccc; padding: 8px;">BÃ i</th>
                        <th style="border: 1px solid #ccc; padding: 8px;">TÃªn</th>
                        <th style="border: 1px solid #ccc; padding: 8px;">Level cáº§n</th>
                        <th style="border: 1px solid #ccc; padding: 8px;">Tráº¡ng thÃ¡i</th>
                    </tr>
                </thead>
                <tbody id="lesson-list-body"></tbody>
            </table>
        </div>
    </div>
<br>
	 <div>
        <label for="lesson-input">Chá»n bÃ i <em>(vÃ­ dá»¥: 16, 1-5, 1,5):</em></label><br>
        <input type="text" id="lesson-input" placeholder="Äá»ƒ trá»‘ng Ä‘á»ƒ chá»n ngáº«u nhiÃªn">
    </div>
    <div id="dialogue-select-container" style="display: none;">
        <label for="dialogue-number">Chá»n há»™i thoáº¡i <em>(Nháº­p sá»‘):</em></label><br>
        <input type="number" id="dialogue-number" min="1" placeholder="Äá»ƒ trá»‘ng Ä‘á»ƒ chá»n ngáº«u nhiÃªn">
    </div>
    <div id="word-count-container">
        <label for="word-count">Sá»‘ tá»« cáº§n Ã´n táº­p:</label><br>
        <input type="number" id="word-count" value="30" min="1">
    </div>
    <div id="time-limit-container">
        <label for="time-limit">Thá»i gian má»—i cÃ¢u (giÃ¢y):</label><br>
        <input type="number" id="time-limit" value="20" min="1">
    </div>
<!-- ThÃªm div cho nhiá»‡m vá»¥ ngáº«u nhiÃªn -->
    <div id="random-mission-container" style="text-align: center; margin-bottom: 10px; font-size: 18px; color: #2196F3; font-weight: bold;">
        <span id="random-mission-text"></span>
    </div>
    <!-- ThÃªm nÃºt Quay Láº¡i -->
    <div style="display: flex; justify-content: center; gap: 10px;">
        <button2 id="back-to-mode-button" class="quiz-type-button">QUAY Láº I</button2>
        <button2 id="start-button" class="quiz-type-button">Báº®T Äáº¦U</button2>
    </div>
</div>
<!-- Bao quanh -->
 <div class="content-wrapper">
        <!-- NhÃ³m 3: Giao diá»‡n trÃ² chÆ¡i chÃ­nh -->
<div id="game-container">
   
    <!-- Tráº¡ng thÃ¡i trÃ² chÆ¡i -->
    <div id="status-container">
        <span id="wrong-count">Sá»‘ cÃ¢u bá»‹ sai: 0</span>
        <span id="timer">Thá»i gian: 20</span>   
        <span id="total-count">Tá»•ng sá»‘ cÃ¢u: 0</span>
        <span id="review-mode">Ã”n táº­p cÃ¢u sai</span>
    </div>
<div style="text-align: center;">
        <span id="earned-exp">Äiá»ƒm: 0</span>
    </div>

    <!-- Hiá»ƒn thá»‹ cÃ¢u há»i -->
    <div id="meaning-container">
        <p>
            <span style="font-size:20px; color: blue; font-weight: bold;">
                <em>Dá»‹ch nghÄ©a: </em>
            </span>
            <span id="meaning" style="font-size:20px;"></span>
        </p>
    </div>
    <div id="pinyin-container">
        <div id="question"></div>
        <div class="pinyin-kyhieu-group">
            <span id="pinyin"></span>
            <span id="kyhieu"></span>
        </div>
		<div id="read-complete-container" style="display: none; text-align: center; margin-top: 10px;">
        <button3 id="read-complete-button" style="font-size: 16px; padding: 5px 10px;">ÄÃ£ Ä‘á»c xong</button3>
		<span id="read-complete-text" class="read-complete-text"> << Báº¥m Ä‘á»ƒ chuyá»ƒn cÃ¢u tiáº¿p theo</span>
    </div>
    </div>
    <div id="phanTich-container">
        <span id="phanTich"></span>
    </div>

    <!-- Cháº¿ Ä‘á»™ chÆ¡i -->
    <div id="word-scramble-game"></div>
    <img id="dialogue-image" src="" alt="Dialogue Image" style="max-width: 100%; max-height: 200px; height: auto; display: none; margin: 5px auto 0 auto;">
    <div id="dialogue-display" style="display: none; text-align: center; max-height: 350px; overflow-y: auto;">
        <div id="dialogue-container" style="display: flex; flex-direction: column; gap: 0px;"></div>
        <div id="scrambled-buttons" class="button-grid"></div>
        <div class="button-container">
            <button2 id="dice-button" style="display: none;">ğŸ²</button2>
            <button2 id="back-button">ğŸ”™</button2>
            <button2 id="next-button">ğŸ”œ</button2>
        </div>
    </div>
    <div id="writing-container" style="display: none;">
        <div id="writing-canvas"></div>
        <div style="text-align: center;">
            <span id="writing-progress"></span>
        </div>
    </div>

    <!-- Äiá»u khiá»ƒn trÃ² chÆ¡i -->
    <div class="button-grid" id="option-buttons"></div>
    <div id="feedback"></div>
    <div class="input-container">
        <div id="inputPinyinDisplay" style="font-size: 18px; color: green; margin-bottom: 5px;"></div>
        <input type="text" id="answerInput" class="answer-input" placeholder="Nháº­p HÃ¡n tá»±">
        <button2 id="testButton" style="font-size: 20px; padding: 5px 10px; border-radius: 10px; border: none; background-color: rgba(255, 255, 255, 0.7); box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);">ğŸ†—
            <label style="margin-left: 1px;">
                <input type="checkbox" id="autoCheck" checked>
            </label>
        </button2>
    </div>
    <div class="button-container">
	    <button2 id="homeButton">ğŸ¯</button2> <!-- ThÃªm nÃºt Home -->
        <button2 id="playButton">ğŸ”Š</button2>
        <button2 id="hintButton">ğŸ’¡</button2>
        <button2 id="writeButton" style="display: none;">ğŸ–Œ</button2>
        <button2 id="write-dialogue-button" style="display: none;">ğŸ–Œ</button2>
        <button2 id="diceButton" style="display: none;">ğŸ²</button2>
        <button2 id="infoButton" style="display: none;">ğŸ“‹</button2>
        <button2 id="authorButton" style="display: none;">ğŸ‘²</button2>
        <button2 class="related-btn" onclick="toggleRelated()">ğŸ”—</button2>
        <button2 class="magnifier-btn" onclick="toggleMenu()">ğŸ”</button2>
        <button2 class="book-btn" onclick="toggleSearch()">ğŸ“–</button2>
        <button2 class="translate-btn" onclick="toggleTranslate()">ğŸ”ƒ</button2>
    </div>
	 <!-- ThÃ nh pháº§n phá»¥ trá»£ -->
    <audio id="audio"></audio>
</div>
    </div>

<!-- NhÃ³m 4: Popup vÃ  panel phá»¥ -->
<div id="endgame-popup" class="popup" style="display: none;">
    <div id="endgame-popup-content" class="popup-content"></div>
</div>
<div id="hanzi-popup">
    <span class="close-btn" onclick="closeHanziPopup()">âŒ</span>
    <div id="hanzi-popup-content"></div>
</div>
<div id="info-popup">
    <span class="close-btn" onclick="closeInfoPopup()">âŒ</span>
    <div id="info-popup-content"></div>
</div>
<div id="author-popup">
    <span class="close-btn" onclick="closeAuthorPopup()">âŒ</span>
    <div id="author-popup-content"></div>
</div>
<div id="nested-info-popup">
    <span class="close-btn" onclick="closeNestedInfoPopup()">âŒ</span>
    <div id="nested-info-popup-content"></div>
</div>
<div id="info" style="display: none;">
    <div id="wrong-hanzi-display" style="font-size: 15px; color: red; text-align: left; margin: 10px;">
        <p>Danh sÃ¡ch tá»« sai:</p>
        <ul id="wrong-hanzi-list"></ul>
    </div>
    <div id="review-hanzi-display" style="font-size: 15px; color: green; text-align: left; margin: 10px; display: none;">
        <p>Danh sÃ¡ch tá»« sáº½ há»i trong cháº¿ Ä‘á»™ Ã´n táº­p:</p>
        <ul id="review-hanzi-list"></ul>
    </div>
</div>

<!-- NhÃ³m 5: CÃ´ng cá»¥ há»— trá»£ -->
<div id="menuContainer" class="menu-container">
    <div id="volumeButtons" class="volume-buttons"></div>
    <div id="lessonButtons" class="lesson-buttons"></div>
    <div id="tableContainer" class="table-container"></div>
</div>
<div id="searchContainer" class="search-container">
    <input type="text" id="searchInput" class="search-input" placeholder="Nháº­p HÃ¡n tá»±">
    <button2 class="search-btn" onclick="searchHanzi()">Tra</button2>
</div>
<div id="hanziiContainer" class="hanzii-container">
    <iframe id="hanziiIframe" src=""></iframe>
</div>
<div id="translateContainer" class="translate-container">
    <iframe id="translateIframe" src=""></iframe>
</div>
<div id="related-hanzi-list"></div>

<script>
let earnedEXP = 0;
    let questionWord = "hanzi";
    let currentQuestion = null;
    let allWords = [];
    let selectedHanzi = [];
    let wrongHanzi = [];
    let questionCount = 0;
    let isReviewMode = false;
    let audioStartTime = 0;
    let audioEndTime = 0;
    let maxWords = 10;
    let currentReviewList = [];
    let jsonData = [];
    let giatrihanzi = "";
    let selectedVolume = null;
    let selectedLesson = null;
    const relatedHanziList = document.getElementById('related-hanzi-list');
    let timeLimit = 20;
    let timeRemaining = timeLimit;
    let timerInterval = null;
    let showMeaning = true;
    let quizType = "vocabulary";
    let bangHanTuData = [];
    let pinyinTuDienData = [];
    let isScrambleMode = false;
    let currentScrambleAnswer = '';
    let dialogueData = [];
    let selectedDialogue = null;
    let hanzi3Data = [];
let selectedMode = 'taiwanese';
let isWritingMode = false;
let currentCharIndex = 0;
let writer = null;
let writingChars = [];
let showOutline = false; // Máº·c Ä‘á»‹nh khÃ´ng hiá»ƒn thá»‹ Ä‘Æ°á»ng viá»n
let isNewWordMode = false; // Biáº¿n xÃ¡c Ä‘á»‹nh cháº¿ Ä‘á»™ Há»c Tá»« Má»›i
let accountData = null;
let randomMissionLesson = null; // LÆ°u bÃ i cá»§a nhiá»‡m vá»¥ ngáº«u nhiÃªn
// Biáº¿n lÆ°u dá»¯ liá»‡u level
let levelData = [];

// HÃ m táº£i dá»¯ liá»‡u level tá»« _level.json
async function loadLevelData() {
    try {
        const response = await fetch('/hoctiengtrung/json/level3.json', {
            cache: 'no-cache'
        });
        if (!response.ok) {
            throw new Error('KhÃ´ng thá»ƒ táº£i _level.json');
        }
        levelData = await response.json();
        console.log('Level data loaded:', levelData);
    } catch (error) {
        console.error('Lá»—i khi táº£i _level.json:', error);
        alert('KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u cáº¥p Ä‘á»™!');
    }
}

// HÃ m xÃ¡c Ä‘á»‹nh cáº¥p Ä‘á»™ vÃ  cáº­p nháº­t giao diá»‡n
function updateLevelInfo() {
    const currentEXP = parseInt(document.getElementById('account-exp').textContent) || 0;
    let currentLevel = null;

    // TÃ¬m cáº¥p Ä‘á»™ dá»±a trÃªn EXP
    for (const level of levelData) {
        if (currentEXP >= level.expStar && currentEXP <= level.expEnd) {
            currentLevel = level;
            break;
        }
    }

    // Náº¿u khÃ´ng tÃ¬m tháº¥y cáº¥p Ä‘á»™ (EXP vÆ°á»£t quÃ¡ cáº¥p cuá»‘i), láº¥y cáº¥p cuá»‘i cÃ¹ng
    if (!currentLevel && levelData.length > 0) {
        currentLevel = levelData[levelData.length - 1];
    }

    if (currentLevel) {
        // Cáº­p nháº­t giao diá»‡n
        document.getElementById('account-level').textContent = currentLevel.Level;
        document.getElementById('account-danhHieu').textContent = currentLevel.danhHieu;
        document.getElementById('account-image').src = currentLevel.Anh;

        // TÃ­nh pháº§n trÄƒm tiáº¿n Ä‘á»™
        const progressPercent = ((currentEXP - currentLevel.expStar) / currentLevel.expUp) * 100;
        const roundedProgress = Math.min(Math.round(progressPercent * 10) / 10, 100); // LÃ m trÃ²n 1 chá»¯ sá»‘ tháº­p phÃ¢n
        document.getElementById('level-progress').style.width = `${roundedProgress}%`;
        document.getElementById('level-progress-text').textContent = `${roundedProgress}%`;
    } else {
        // Fallback náº¿u khÃ´ng cÃ³ dá»¯ liá»‡u cáº¥p Ä‘á»™
        document.getElementById('account-level').textContent = '1';
        document.getElementById('account-danhHieu').textContent = 'A';
        document.getElementById('account-image').src = '_anhA.png';
        document.getElementById('level-progress').style.width = '0%';
        document.getElementById('level-progress-text').textContent = '0%';
    }
}

function generateRandomMission() {
    const currentLevel = parseInt(document.getElementById('account-level').textContent) || 1;
const unlockedLessons = lessonListData.filter(lesson => currentLevel >= lesson.level_unlock);
    
    if (unlockedLessons.length === 0) {
        randomMissionLesson = null;
        document.getElementById('random-mission-text').textContent = 'ChÆ°a cÃ³ bÃ i nÃ o má»Ÿ khÃ³a Ä‘á»ƒ táº¡o nhiá»‡m vá»¥!';
        return;
    }
    
    const randomIndex = Math.floor(Math.random() * unlockedLessons.length);
    randomMissionLesson = unlockedLessons[randomIndex].bai;
    document.getElementById('random-mission-text').textContent = 
        `HÃ£y Ã´n láº¡i bÃ i ${randomMissionLesson} Ä‘á»ƒ nháº­n x2 EXP`;
}

// Äá»‹nh nghÄ©a URL cá»§a cÃ¡c file danh sÃ¡ch bÃ i
const lessonListUrls = {
    taiwanese: '/hoctiengtrung/json/danhsachbai-tiengtrungdailoan9.json',
    samtukinh: '/hoctiengtrung/json/danhsachbai-tamtukinh.json',
    poetry: '/hoctiengtrung/json/danhsachbai-tiengtrungdailoan9.json',
    thientuvan: '/hoctiengtrung/json/danhsachbai-tiengtrungdailoan9.json',
    hongngam: '/hoctiengtrung/json/danhsachbai-tiengtrungdailoan9.json'
};

// Biáº¿n Ä‘á»ƒ lÆ°u dá»¯ liá»‡u danh sÃ¡ch bÃ i
let lessonListData = [];

// HÃ m táº£i danh sÃ¡ch bÃ i
async function loadLessonList() {
    try {
        const response = await fetch(lessonListUrls[selectedMode], {
            cache: 'no-cache'
        });
        if (!response.ok) {
            throw new Error(`KhÃ´ng thá»ƒ táº£i ${lessonListUrls[selectedMode]}`);
        }
        lessonListData = await response.json();
        console.log('Lesson list loaded:', lessonListData);
    } catch (error) {
        console.error('Lá»—i khi táº£i danh sÃ¡ch bÃ i:', error);
        alert(`KhÃ´ng thá»ƒ táº£i danh sÃ¡ch bÃ i cho ${modeDisplayNames[selectedMode]}!`);
    }
}

// HÃ m hiá»ƒn thá»‹ báº£ng danh sÃ¡ch bÃ i
function showLessonList() {
    const lessonListContainer = document.getElementById('lesson-list-container');
    const lessonListBody = document.getElementById('lesson-list-body');
    lessonListBody.innerHTML = '';

    const currentLevel = parseInt(document.getElementById('account-level').textContent) || 1;

    lessonListData.forEach(lesson => {
        const row = document.createElement('tr');
        const status = currentLevel >= lesson.level_unlock ? 'âœ…' : 'ğŸ”’';
        row.innerHTML = `
            <td>${lesson.bai}</td>
            <td>${lesson.name}</td>
            <td>${lesson.level_unlock}</td>
            <td>${status}</td>
        `;
        if (status === 'ğŸ”’') {
            row.classList.add('locked');
        } else {
            row.addEventListener('click', () => {
                document.getElementById('lesson-input').value = lesson.bai;
                lessonListContainer.style.display = 'none';
            });
        }
        lessonListBody.appendChild(row);
    });

    lessonListContainer.style.display = lessonListContainer.style.display === 'block' ? 'none' : 'block';
}

// Gá»i loadLessonList khi chá»n cháº¿ Ä‘á»™
document.querySelectorAll('.mode-button').forEach(button => {
    button.addEventListener('click', () => {
        if (button.classList.contains('disabled') || button.hasAttribute('disabled')) {
            return;
        }

        document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        selectedMode = button.getAttribute('data-mode');
        console.log('Selected mode:', selectedMode);

        // Load dá»¯ liá»‡u ngay khi chá»n cháº¿ Ä‘á»™
        loadInitialData();
        loadLessonList(); // Táº£i danh sÃ¡ch bÃ i khi chá»n cháº¿ Ä‘á»™
        // ... (pháº§n cÃ²n láº¡i cá»§a sá»± kiá»‡n click giá»¯ nguyÃªn)
    });
});

// ThÃªm sá»± kiá»‡n cho nÃºt Danh sÃ¡ch bÃ i
document.getElementById('lesson-list-button').addEventListener('click', showLessonList);

// Äá»‹nh nghÄ©a token á»Ÿ pháº¡m vi toÃ n cá»¥c
const pass1 = 'ghp_sbgtwaf2';
const pass2 = 'jootc3dvd4eCkh';
const pass3 = 'Fi1CPIOo0H1Fz4';
const GITHUB_TOKEN = pass1 + pass2 + pass3;

let currentUser = null; // LÆ°u thÃ´ng tin tÃ i khoáº£n Ä‘ang Ä‘Äƒng nháº­p

// HÃ m loadAccountData sá»­a Ä‘á»•i Ä‘á»ƒ xá»­ lÃ½ máº£ng tÃ i khoáº£n
async function loadAccountData() {
    try {
        const url = 'https://api.github.com/repos/son502-mocnhien/hoctiengtrung/contents/taikhoan.json';
        const response = await fetch(url, {
            headers: {
                'Accept': 'application/vnd.github.v3+json',
                'Authorization': `Bearer ${GITHUB_TOKEN}`
            }
        });
        if (!response.ok) {
            throw new Error('KhÃ´ng thá»ƒ táº£i taikhoan.json tá»« GitHub API');
        }
        const data = await response.json();
        const binaryString = atob(data.content);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        const content = new TextDecoder('utf-8').decode(bytes);
        accountData = JSON.parse(content); // BÃ¢y giá» lÃ  máº£ng cÃ¡c Ä‘á»‘i tÆ°á»£ng tÃ i khoáº£n
    } catch (error) {
        console.error('Lá»—i khi táº£i taikhoan.json:', error);
        document.getElementById('account-exp').textContent = '0';
        document.getElementById('account-name').textContent = 'KhÃ¡ch NhÃ¢n';
        document.getElementById('account-level').textContent = '1';
        document.getElementById('account-danhHieu').textContent = 'A';
        document.getElementById('account-image').src = '_anhA.png';
        document.getElementById('level-progress').style.width = '0%';
        document.getElementById('level-progress-text').textContent = '0%';
        earnedEXP = 0;
        document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
    }
}

// Khá»Ÿi táº¡o mÃ n hÃ¬nh Ä‘Äƒng nháº­p/Ä‘Äƒng kÃ½
document.getElementById('mode-selection-screen').style.display = 'none'; // áº¨n mÃ n chá»n cháº¿ Ä‘á»™
document.getElementById('game-container').style.display = 'none';
document.getElementById('start-screen').style.display = 'none';
document.getElementById('auth-screen').style.display = 'block';

// Xá»­ lÃ½ Ä‘Äƒng nháº­p
document.getElementById('login-button').addEventListener('click', async () => {
    const username = document.getElementById('login-user').value.trim();
    const password = document.getElementById('login-pass').value.trim();
    const errorElement = document.getElementById('login-error');

    if (!username || !password) {
        errorElement.textContent = 'Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ tÃªn Ä‘Äƒng nháº­p vÃ  máº­t kháº©u!';
        errorElement.style.display = 'block';
        return;
    }

    await loadAccountData();
    const user = accountData.find(u => u.user === username && u.pass === password);
    if (user) {
        currentUser = user;
        document.getElementById('account-name').textContent = user.name;
        document.getElementById('account-exp').textContent = user.EXP;
        await loadLevelData();
        updateLevelInfo();
        earnedEXP = 0;
        document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('mode-selection-screen').style.display = 'block';
        document.querySelector('.header-container').style.display = 'block';
        document.getElementById('youtube-player').src = ''; // Dá»«ng video
        errorElement.style.display = 'none';
    } else {
        errorElement.textContent = 'TÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng!';
        errorElement.style.display = 'block';
    }
});

// Xá»­ lÃ½ Ä‘Äƒng kÃ½
document.getElementById('register-button').addEventListener('click', async () => {
    const username = document.getElementById('register-user').value.trim();
    const password = document.getElementById('register-pass').value.trim();
    const name = document.getElementById('register-name').value.trim();
    const errorElement = document.getElementById('register-error');

    if (!username || !password || !name) {
        errorElement.textContent = 'Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!';
        errorElement.style.display = 'block';
        return;
    }

    await loadAccountData();
    if (accountData.find(u => u.user === username)) {
        errorElement.textContent = 'TÃªn Ä‘Äƒng nháº­p Ä‘Ã£ tá»“n táº¡i!';
        errorElement.style.display = 'block';
        return;
    }

    const newUser = { user: username, pass: password, name: name, EXP: 0 };
    accountData.push(newUser);

    try {
        const content = JSON.stringify(accountData, null, 2);
        const encodedContent = btoa(unescape(encodeURIComponent(content)));
        const getFileResponse = await fetch('https://api.github.com/repos/son502-mocnhien/hoctiengtrung/contents/taikhoan.json', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github+json'
            }
        });
        if (!getFileResponse.ok) {
            throw new Error('KhÃ´ng thá»ƒ láº¥y SHA cá»§a file');
        }
        const fileData = await getFileResponse.json();
        const sha = fileData.sha;

        const updateResponse = await fetch('https://api.github.com/repos/son502-mocnhien/hoctiengtrung/contents/taikhoan.json', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: 'ÄÄƒng kÃ½ tÃ i khoáº£n má»›i',
                content: encodedContent,
                sha: sha,
                branch: 'main'
            })
        });

        if (updateResponse.ok) {
            currentUser = newUser;
            document.getElementById('account-name').textContent = name;
            document.getElementById('account-exp').textContent = '0';
            await loadLevelData();
            updateLevelInfo();
            earnedEXP = 0;
            document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('mode-selection-screen').style.display = 'block';
            document.querySelector('.header-container').style.display = 'block';
            document.getElementById('youtube-player').src = ''; // Dá»«ng video
            errorElement.style.display = 'none';
        } else {
            errorElement.textContent = 'Lá»—i khi Ä‘Äƒng kÃ½ tÃ i khoáº£n!';
            errorElement.style.display = 'block';
        }
    } catch (error) {
        console.error('Lá»—i khi Ä‘Äƒng kÃ½:', error);
        errorElement.textContent = 'Lá»—i khi Ä‘Äƒng kÃ½ tÃ i khoáº£n!';
        errorElement.style.display = 'block';
    }
});

// Chuyá»ƒn Ä‘á»•i giá»¯a Ä‘Äƒng nháº­p vÃ  Ä‘Äƒng kÃ½
document.getElementById('show-register').addEventListener('click', () => {
    document.getElementById('login-container').style.display = 'none';
    document.getElementById('register-container').style.display = 'block';
    document.getElementById('login-error').style.display = 'none';
    document.getElementById('register-error').style.display = 'none';
});

document.getElementById('show-login').addEventListener('click', () => {
    document.getElementById('login-container').style.display = 'block';
    document.getElementById('register-container').style.display = 'none';
    document.getElementById('login-error').style.display = 'none';
    document.getElementById('register-error').style.display = 'none';
    playRandomYouTubeVideo(); // PhÃ¡t video ngáº«u nhiÃªn
});

// Sá»­a hÃ m claimExperience Ä‘á»ƒ cáº­p nháº­t EXP cho tÃ i khoáº£n hiá»‡n táº¡i
async function claimExperience(finalEXP) {
    try {
        if (!currentUser) {
            console.error('KhÃ´ng cÃ³ tÃ i khoáº£n Ä‘ang Ä‘Äƒng nháº­p');
            alert('Lá»—i: Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i!');
            return;
        }

        await loadAccountData();
        const userIndex = accountData.findIndex(u => u.user === currentUser.user);
        if (userIndex === -1) {
            console.error('KhÃ´ng tÃ¬m tháº¥y tÃ i khoáº£n trong accountData');
            alert('Lá»—i: KhÃ´ng tÃ¬m tháº¥y tÃ i khoáº£n!');
            return;
        }

        accountData[userIndex].EXP = (parseInt(accountData[userIndex].EXP) || 0) + finalEXP;

        const content = JSON.stringify(accountData, null, 2);
        const encodedContent = btoa(unescape(encodeURIComponent(content)));

        const getFileResponse = await fetch('https://api.github.com/repos/son502-mocnhien/hoctiengtrung/contents/taikhoan.json', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github+json',
                'Content-Type': 'application/json'
            }
        });

        if (!getFileResponse.ok) {
            const errorData = await getFileResponse.json();
            console.error('Lá»—i láº¥y SHA:', errorData);
            throw new Error(`KhÃ´ng thá»ƒ láº¥y SHA cá»§a file: ${errorData.message}`);
        }

        const fileData = await getFileResponse.json();
        const sha = fileData.sha;

        const updateResponse = await fetch('https://api.github.com/repos/son502-mocnhien/hoctiengtrung/contents/taikhoan.json', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: 'Cáº­p nháº­t Ä‘iá»ƒm kinh nghiá»‡m EXP',
                content: encodedContent,
                sha: sha,
                branch: 'main'
            })
        });

        if (updateResponse.ok) {
            currentUser.EXP = accountData[userIndex].EXP;
            document.getElementById('account-exp').textContent = currentUser.EXP;
            await updateLevelInfo();
            earnedEXP = 0;
            randomMissionLesson = null;
            document.getElementById('endgame-popup').style.display = 'none';
            returnToModeSelection();
        } else {
            const errorData = await updateResponse.json();
            console.error('Lá»—i cáº­p nháº­t EXP:', errorData);
            alert(`Lá»—i khi cáº­p nháº­t EXP: ${errorData.message}`);
        }
    } catch (error) {
        console.error('Lá»—i khi cáº­p nháº­t EXP:', error);
    }
}

function startWritingMode() {
    if (!currentQuestion || !currentQuestion.hanzi) {
        console.error('KhÃ´ng cÃ³ cÃ¢u há»i hoáº·c HÃ¡n tá»± Ä‘á»ƒ táº­p viáº¿t');
        stopWritingMode();
        return;
    }

    isWritingMode = true;
    currentCharIndex = 0;
    currentScrambleAnswer = '';
    writingChars = currentQuestion.hanzi.replace(/\|/g, '').split('').filter(char => !/[.,!?ï¼Œã€‚ï¼ï¼Ÿ]/.test(char));

    if (writingChars.length === 0) {
        console.warn('KhÃ´ng cÃ³ kÃ½ tá»± há»£p lá»‡ Ä‘á»ƒ táº­p viáº¿t');
        handleWritingComplete();
        return;
    }

    document.getElementById('option-buttons').style.display = 'none';
    document.getElementById('word-scramble-game').style.display = 'none';
    document.getElementById('scrambled-buttons').style.display = 'none';
    document.getElementById('writing-container').style.display = 'block';
    document.getElementById('question').style.display = 'none';
    document.getElementById('pinyin-container').style.display = 'none';

    document.getElementById('meaning').innerText = currentQuestion.nghia ? currentQuestion.nghia.replace(/\|/g, '\n') : '';
    document.getElementById('meaning-container').style.display = showMeaning ? 'block' : 'none';

    if (quizType === 'dialogue') {
        document.getElementById('dialogue-display').style.display = 'block';
        updateDialogueContainer();
    }

    if (currentQuestion.linkmp3) {
        setupAudio(document.getElementById('audio'), currentQuestion.linkmp3, currentQuestion.time);
        playCurrentAudio(() => {});
    }

    updateWritingChar();
}

function updateWritingChar() {
    const canvas = document.getElementById('writing-canvas');
    canvas.innerHTML = '';
    document.getElementById('writing-progress').innerText = `Chá»¯ ${currentCharIndex + 1}/${writingChars.length}`;

    // XÃ³a nÃºt Hiá»‡n/áº¨n cÅ© (náº¿u cÃ³)
    const writingContainer = document.getElementById('writing-container');
    const existingToggleButton = writingContainer.querySelector('.toggle-outline-button');
    if (existingToggleButton) existingToggleButton.remove();

    // Táº¡o nÃºt Hiá»‡n/áº¨n
    const toggleButton = document.createElement('button');
    toggleButton.className = 'toggle-outline-button';
    toggleButton.innerText = showOutline ? 'áº¨n' : 'Hiá»‡n';
    toggleButton.style.fontSize = '14px';
    toggleButton.style.padding = '5px 10px';
    toggleButton.style.borderRadius = '5px';
    toggleButton.style.backgroundColor = '#2196F3';
    toggleButton.style.color = 'white';
    toggleButton.style.border = 'none';
    toggleButton.style.cursor = 'pointer';
    toggleButton.style.marginRight = '10px'; // Khoáº£ng cÃ¡ch bÃªn pháº£i (thay vÃ¬ margin-left)
	toggleButton.style.fontFamily = 'Noto Sans CJK SC, Arial, sans-serif';
    toggleButton.style.verticalAlign = 'middle';
    toggleButton.style.width = '70px'; // KÃ­ch thÆ°á»›c ngang cá»‘ Ä‘á»‹nh
    toggleButton.style.height = '30px'; // KÃ­ch thÆ°á»›c cao cá»‘ Ä‘á»‹nh

    // ThÃªm nÃºt trÆ°á»›c writing-progress
    const progressSpan = document.getElementById('writing-progress');
    const inlineContainer = document.createElement('span');
    inlineContainer.style.display = 'inline';
    inlineContainer.appendChild(toggleButton);
    progressSpan.parentNode.insertBefore(inlineContainer, progressSpan);

    // HÃ m khá»Ÿi táº¡o Hanzi Writer
    function initializeWriter() {
        try {
            writer = HanziWriter.create('writing-canvas', writingChars[currentCharIndex], {
                width: 200,
                height: 200,
                padding: 5,
                drawingWidth: 40,
                showHintAfterMisses: 1,
                radicalColor: '#337ab7', // blue
                showOutline: showOutline,
                showCharacter: false,
                highlightOnComplete: true,
                onCorrectStroke: function(strokeData) {
                    console.log('NÃ©t Ä‘Ãºng:', strokeData);
                },
                onMistake: function(strokeData) {
                    console.log('NÃ©t sai:', strokeData);
                    document.getElementById('feedback').innerText = 'NÃ©t chÆ°a Ä‘Ãºng, tiáº¿p tá»¥c váº½!';
                    document.getElementById('feedback').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('feedback').style.display = 'none';
                    }, 1000);
                }
            });

            // Báº¯t Ä‘áº§u quiz
            writer.quiz({
                onComplete: function(summaryData) {
                    console.log('HoÃ n thÃ nh kÃ½ tá»±:', summaryData);
                    document.getElementById('feedback').innerText = 'ÄÃ£ hoÃ n thÃ nh kÃ½ tá»±!';
                    document.getElementById('feedback').style.display = 'block';

// Award 1 EXP for each completed character
                    earnedEXP += 2;
                    document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;

                    currentScrambleAnswer += writingChars[currentCharIndex];
                    setTimeout(() => {
                        document.getElementById('feedback').style.display = 'none';
                        currentCharIndex++;
                        if (currentCharIndex < writingChars.length) {
                            updateWritingChar();
                            if (quizType === 'dialogue') {
                                updateDialogueContainer();
                            }
                        } else {
                            handleWritingComplete();
                        }
                    }, 1000);
                }
            });
        } catch (error) {
            console.error('Lá»—i khi khá»Ÿi táº¡o Hanzi Writer:', error);
            document.getElementById('feedback').innerText = 'KhÃ´ng thá»ƒ hiá»ƒn thá»‹ kÃ½ tá»± nÃ y Ä‘á»ƒ táº­p viáº¿t!';
            document.getElementById('feedback').style.display = 'block';
            currentScrambleAnswer += writingChars[currentCharIndex];

// Award 1 EXP even if HanziWriter fails to initialize
            earnedEXP += 1;
            document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;

            setTimeout(() => {
                document.getElementById('feedback').style.display = 'none';
                currentCharIndex++;
                if (currentCharIndex < writingChars.length) {
                    updateWritingChar();
                    if (quizType === 'dialogue') {
                        updateDialogueContainer();
                    }
                } else {
                    handleWritingComplete();
                }
            }, 1000);
        }
    }

    // Khá»Ÿi táº¡o Hanzi Writer láº§n Ä‘áº§u
    initializeWriter();

    // Xá»­ lÃ½ sá»± kiá»‡n nháº¥n nÃºt Hiá»‡n/áº¨n
    toggleButton.onclick = function() {
        showOutline = !showOutline;
        console.log('showOutline:', showOutline);
        toggleButton.innerText = showOutline ? 'áº¨n' : 'Hiá»‡n';
        try {
            writer.setOutlineVisibility(showOutline);
        } catch (error) {
            console.warn('setOutlineVisibility khÃ´ng hoáº¡t Ä‘á»™ng, khá»Ÿi táº¡o láº¡i Writer:', error);
            canvas.innerHTML = '';
            initializeWriter();
        }
    };
}

function handleWritingComplete() {
    if (quizType === 'dialogue') {
        updateDialogueContainer();
    }

    document.getElementById('feedback').innerText = 'Tá»‘t láº¯m, báº¡n Ä‘Ã£ hoÃ n thÃ nh cÃ¢u!';
    document.getElementById('feedback').style.display = 'block';
    document.getElementById('writing-container').style.display = 'none';
    if (timerInterval) clearInterval(timerInterval);

    const questionElement = document.getElementById('question');
    const pinyinElement = document.getElementById('pinyin');
    const kyhieuElement = document.getElementById('kyhieu');
    const pinyinContainer = document.getElementById('pinyin-container');
    const phanTichElement = document.getElementById('phanTich');
    const phanTichContainer = document.getElementById('phanTich-container');
    const meaningContainer = document.getElementById('meaning-container');
    const readCompleteContainer = document.getElementById('read-complete-container');

    questionElement.innerText = currentQuestion.hanzi.replace(/\|/g, '\n');
    pinyinElement.innerText = currentQuestion.pinyin ? currentQuestion.pinyin.replace(/\|/g, '\n') : hanziToPinyin(currentQuestion.hanzi);
    kyhieuElement.innerText = currentQuestion.kyhieu ? currentQuestion.kyhieu.replace(/\|/g, '\n') : '';
    questionElement.style.display = 'block';
    pinyinElement.style.display = 'block';
    kyhieuElement.style.display = currentQuestion.kyhieu ? 'block' : 'none';
    pinyinContainer.style.display = 'flex';
    meaningContainer.style.display = 'block';
    if (quizType === 'vocabulary') {
        showAnalysis();
        phanTichContainer.style.display = 'block';
        phanTichElement.style.display = 'block';
       earnedEXP += 0; // 3 Ä‘iá»ƒm cho Tá»« Vá»±ng
document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
    } else if (quizType === 'sentence') {
        earnedEXP += 0; // 10 Ä‘iá»ƒm cho Máº«u CÃ¢u
document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
    } else if (quizType === 'dialogue') {
        earnedEXP += 0; // 10 Ä‘iá»ƒm cho má»—i cÃ¢u Há»™i Thoáº¡i
document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
    }

    const nextAction = () => {
        document.getElementById('feedback').style.display = 'none';
        pinyinElement.style.display = 'none';
        kyhieuElement.style.display = 'none';
        pinyinContainer.style.display = 'none';
        phanTichContainer.style.display = 'none';
        phanTichElement.style.display = 'none';
        questionElement.style.display = 'none';
        readCompleteContainer.style.display = 'none';
        meaningContainer.style.display = showMeaning ? 'block' : 'none';
        document.getElementById('answerInput').value = '';
        document.getElementById('answerInput').disabled = false;
        document.getElementById('inputPinyinDisplay').textContent = '';

        currentScrambleAnswer = '';
        currentCharIndex = 0;

        questionCount++;
        if (questionCount < selectedHanzi.length) {
            currentQuestion = selectedHanzi[questionCount];
            if (quizType === 'dialogue') {
                updateDialogueContainer();
            }
            if (isWritingMode) {
                startWritingMode();
            } else {
                loadNewQuestion();
            }
        } else {
            endGame();
        }
    };

    if (isNewWordMode) {
        readCompleteContainer.style.display = 'block';
        const readCompleteButton = document.getElementById('read-complete-button');
        readCompleteButton.onclick = () => {
            playCurrentAudio(nextAction);
        };
    } else {
        playCurrentAudio(nextAction);
    }
}

function stopWritingMode() {
    isWritingMode = false;
    document.getElementById('writing-container').style.display = 'none';
    
    if (quizType === 'sentence') {
        document.getElementById('dialogue-display').style.display = 'none';
        document.getElementById('option-buttons').style.display = 'grid';
        document.getElementById('meaning-container').style.display = showMeaning ? 'block' : 'none';
        document.getElementById('back-button').style.display = 'none';
        document.getElementById('next-button').style.display = 'none';
        loadNewQuestion();
    } else if (quizType === 'dialogue') {
        document.getElementById('dialogue-display').style.display = 'block';
        document.getElementById('option-buttons').style.display = 'none';
        document.getElementById('back-button').style.display = 'inline-block';
        document.getElementById('next-button').style.display = 'inline-block';
        updateDialogueContainer();
    } else {
        document.getElementById('option-buttons').style.display = 'grid';
        document.getElementById('meaning-container').style.display = showMeaning ? 'block' : 'none';
        loadNewQuestion();
    }
}

    const dataUrls = {
        taiwanese: {
            vocabulary: '/hoctiengtrung/json/hanzi4.json',
            sentence: '/hoctiengtrung/json/maucau21.json',
            dialogue: '/hoctiengtrung/json/hoithoai4-new14.json'
        },
        poetry: {
            vocabulary: '/hoctiengtrung/json/tamtukinh-tuvung5.json',
            sentence: '/hoctiengtrung/json/maucau21.json',
            dialogue: '/hoctiengtrung/json/tamtukinh7.json'
        },
        samtukinh: {
            vocabulary: '/hoctiengtrung/json/tamtukinh-tuvung5.json',
            sentence: '/hoctiengtrung/json/maucau21.json',
            dialogue: '/hoctiengtrung/json/tamtukinh7.json'
        },
        thientuvan: {
            vocabulary: '/hoctiengtrung/json/tamtukinh-tuvung5.json',
            sentence: '/hoctiengtrung/json/maucau21.json',
            dialogue: '/hoctiengtrung/json/tamtukinh7.json'
        },
        hongngam: {
            vocabulary: '/hoctiengtrung/json/tamtukinh-tuvung5.json',
            sentence: '/hoctiengtrung/json/maucau21.json',
            dialogue: '/hoctiengtrung/json/tamtukinh7.json'
        }
    };

const quizTypeDisplayNames = {
    vocabulary: 'Tá»« Vá»±ng',
    sentence: 'Máº«u CÃ¢u',
    dialogue: {
        taiwanese: 'Há»™i Thoáº¡i',
        samtukinh: 'BÃ i ThÆ¡',
        thoduong: 'BÃ i ThÆ¡',
        hongngam: 'BÃ i ThÆ¡'
    }
};

const modeDisplayNames = {
    taiwanese: 'Tiáº¿ng Trung ÄÃ i Loan',
    poetry: '300 BÃ i ThÆ¡ ÄÆ°á»ng',
    samtukinh: 'Tam Tá»± Kinh',
    thientuvan: 'ThiÃªn Tá»± VÄƒn',
    hongngam: 'Há»“ng NgÃ¢m'
};


    function loadInitialData() {
    console.log('Loading data for mode:', selectedMode); // Debug
    fetch(dataUrls[selectedMode].dialogue)
        .then(response => {
            if (!response.ok) throw new Error(`KhÃ´ng thá»ƒ táº£i ${dataUrls[selectedMode].dialogue}`);
            return response.json();
        })
        .then(data => {
            dialogueData = data;
            console.log('Dialogue data loaded:', dialogueData); // Debug
        })
        .catch(error => {
            console.error(`Lá»—i khi load ${dataUrls[selectedMode].dialogue}:`, error);
            alert(`KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u há»™i thoáº¡i/bÃ i thÆ¡ cho ${modeDisplayNames[selectedMode]}!`);
        });

    fetch(dataUrls[selectedMode].vocabulary)
        .then(response => {
            if (!response.ok) throw new Error(`KhÃ´ng thá»ƒ táº£i ${dataUrls[selectedMode].vocabulary}`);
            return response.json();
        })
        .then(data => {
            hanzi3Data = data;
            console.log('Vocabulary data loaded:', hanzi3Data); // Debug
        })
        .catch(error => {
            console.error(`Lá»—i khi load ${dataUrls[selectedMode].vocabulary}:`, error);
            document.getElementById('start-screen').innerHTML += '<p style="color: red;">KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u tá»« vá»±ng!</p>';
        });

    fetch('/hoctiengtrung/json/banghanTu7.json')
        .then(response => response.json())
        .then(data => {
            bangHanTuData = data;
        })
        .catch(error => {
            console.error('Lá»—i khi load _banghanTu.json:', error);
        });

    fetch('/hoctiengtrung/json/pinyintudien2.json')
        .then(response => response.json())
        .then(data => {
            pinyinTuDienData = data;
        })
        .catch(error => {
            console.error('Lá»—i khi load _pinyin_tudien.json:', error);
        });
}

document.querySelectorAll('.mode-button').forEach(button => {
    button.addEventListener('click', () => {
        if (button.classList.contains('disabled') || button.hasAttribute('disabled')) {
            return;
        }

        document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        selectedMode = button.getAttribute('data-mode');
        console.log('Selected mode:', selectedMode); // Debug

        // Load dá»¯ liá»‡u ngay khi chá»n cháº¿ Ä‘á»™
        loadInitialData();

        const quizTypeButtonsContainer = document.getElementById('quiz-type-buttons');
        quizTypeButtonsContainer.innerHTML = '';
        quizTypeButtonsContainer.style.display = 'flex';

        function createQuizTypeButton(text, value) {
            const btn = document.createElement('button2');
            btn.className = 'quiz-type-button';
            btn.textContent = text;
            btn.setAttribute('data-quiz-type', value);
            btn.addEventListener('click', () => {
                quizType = value;

                // XÃ³a class active khá»i cÃ¡c nÃºt quiz-type-button khÃ¡c
                document.querySelectorAll('.quiz-type-button').forEach(b => b.classList.remove('quiz-type-active'));
                // ThÃªm class active cho nÃºt Ä‘Æ°á»£c chá»n
                btn.classList.add('quiz-type-active');

                // XÃ³a cÃ¡c nÃºt phá»¥ trÆ°á»›c Ä‘Ã³ (náº¿u cÃ³)
                const existingSubModeContainer = document.getElementById('sub-mode-buttons');
                if (existingSubModeContainer) {
                    existingSubModeContainer.remove();
                }

                // Náº¿u lÃ  Tá»« Vá»±ng hoáº·c Máº«u CÃ¢u, hiá»ƒn thá»‹ nÃºt phá»¥ bÃªn dÆ°á»›i trÃªn cÃ¹ng hÃ ng ngang
                if (value === 'vocabulary' || value === 'sentence') {
    const subModeContainer = document.createElement('div');
    subModeContainer.id = 'sub-mode-buttons';
    subModeContainer.style.display = 'flex';
    subModeContainer.style.flexDirection = 'row'; // Sáº¯p xáº¿p ngang
    subModeContainer.style.justifyContent = 'center';
    subModeContainer.style.gap = '10px';
    subModeContainer.style.marginTop = '10px';
	
	const reviewBtn = document.createElement('button2');
    reviewBtn.className = 'quiz-type-button sub-mode-button'; // ThÃªm class sub-mode-button
    reviewBtn.textContent = 'Ã”n Táº­p';
    reviewBtn.addEventListener('click', () => {
        isNewWordMode = false;
        startQuizMode();
    });

    const learnNewBtn = document.createElement('button2');
    learnNewBtn.className = 'quiz-type-button sub-mode-button'; // ThÃªm class sub-mode-button
    learnNewBtn.textContent = 'Há»c';
    learnNewBtn.addEventListener('click', () => {
        isNewWordMode = true;
        startQuizMode();
    });
	
    subModeContainer.appendChild(reviewBtn);
    subModeContainer.appendChild(learnNewBtn);
    
    quizTypeButtonsContainer.appendChild(subModeContainer);
                } else {
                    startQuizMode();
                }
            });
            quizTypeButtonsContainer.appendChild(btn);
        }

        if (selectedMode === 'taiwanese') {
            createQuizTypeButton('1.Há»™i Thoáº¡i', 'dialogue');
            createQuizTypeButton('2.Tá»« Vá»±ng', 'vocabulary');
            createQuizTypeButton('3.Máº«u CÃ¢u', 'sentence');
        } else if (selectedMode === 'samtukinh') {
            createQuizTypeButton('Tá»« Vá»±ng', 'vocabulary');
            createQuizTypeButton('BÃ i ThÆ¡', 'dialogue');
        } else if (selectedMode === 'poetry') {
            createQuizTypeButton('Tá»« Vá»±ng', 'vocabulary');
            createQuizTypeButton('BÃ i ThÆ¡', 'dialogue');
        } else if (selectedMode === 'hongngam') {
            createQuizTypeButton('Tá»« Vá»±ng', 'vocabulary');
            createQuizTypeButton('BÃ i ThÆ¡', 'dialogue');
        }
    });
});

// HÃ m chuyá»ƒn sang mÃ n hÃ¬nh khá»Ÿi Ä‘á»™ng (giá»¯ nguyÃªn)
function startQuizMode() {
    document.getElementById('mode-selection-screen').style.display = 'none';
    document.getElementById('start-screen').style.display = 'block';

    const welcomeDiv = document.getElementById('start-screen').querySelector('.welcome-title');
    let quizTypeName = quizTypeDisplayNames[quizType];
    if (quizType === 'dialogue') {
        quizTypeName = quizTypeDisplayNames.dialogue[selectedMode] || 'Há»™i Thoáº¡i';
    }
    welcomeDiv.textContent = `${quizTypeName} \n ${modeDisplayNames[selectedMode]} `;

    const dialogueContainer = document.getElementById('dialogue-select-container');
    const dialogueLabel = dialogueContainer.querySelector('label[for="dialogue-number"]');
    dialogueContainer.style.display = quizType === 'dialogue' ? 'block' : 'none';
    dialogueLabel.textContent = selectedMode === 'taiwanese' ? 'Chá»n Há»™i thoáº¡i:' : 'Chá»n Pháº§n ThÆ¡:';

    const wordCountContainer = document.getElementById('word-count-container');
    const timeLimitContainer = document.getElementById('time-limit-container');
    if (quizType === 'dialogue') {
        wordCountContainer.style.display = 'none';
        timeLimitContainer.style.display = 'none';
    } else {
        wordCountContainer.style.display = 'block';
        timeLimitContainer.style.display = 'block';
    }

// Táº¡o nhiá»‡m vá»¥ ngáº«u nhiÃªn
    generateRandomMission();
}

    document.getElementById('start-button').addEventListener('click', () => {
    const jsonFile = quizType === "vocabulary" ? dataUrls[selectedMode].vocabulary : dataUrls[selectedMode].sentence;

    if (quizType === 'dialogue') {
        jsonData = [];
        allWords = [];
        startGame();
    } else {
        fetch(jsonFile)
            .then(response => {
                if (!response.ok) throw new Error('KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u JSON');
                return response.json();
            })
            .then(data => {
                jsonData = data;
                allWords = data;
                startGame();
            })
            .catch(error => {
                console.error('Lá»—i khi load JSON:', error);
                alert('KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u. Vui lÃ²ng thá»­ láº¡i!');
            });
    }
});

    
    function getAllPinyinCombinations(hanzi) {
        const cleanHanzi = hanzi.replace(/[.,!?ï¼Œã€‚ï¼ï¼Ÿ]/g, '');
        const chars = cleanHanzi.split('');
        let pinyinArrays = [];
        
        chars.forEach(char => {
            const pinyinOptions = pinyinTuDienData[char];
            if (pinyinOptions) {
                pinyinArrays.push(pinyinOptions.split(','));
            } else {
                pinyinArrays.push(['']);
            }
        });
        
        let combinations = [''];
        pinyinArrays.forEach(options => {
            let newCombinations = [];
            combinations.forEach(combo => {
                options.forEach(option => {
                    newCombinations.push(combo ? `${combo} ${option}` : option);
                });
            });
            combinations = newCombinations;
        });
        
        return combinations;
    }

    function hanziToPinyin(hanzi) {
        const cleanHanzi = hanzi.replace(/[.,!?ï¼Œã€‚ï¼ï¼Ÿ]/g, '');
        const chars = cleanHanzi.split('');
        let pinyinResult = [];
        
        chars.forEach(char => {
            const pinyinOptions = pinyinTuDienData[char];
            if (pinyinOptions) {
                const firstPinyin = pinyinOptions.split(',')[0];
                pinyinResult.push(firstPinyin);
            } else {
                pinyinResult.push('');
            }
        });
        
        return pinyinResult.join(' ').trim();
    }

    function isPinyinMatch(inputPinyin, questionPinyinOptions) {
        if (!inputPinyin) return false;
        return questionPinyinOptions.some(option => option === inputPinyin);
    }

    function showAnalysis() {
        let hanziAnalysis = '';
        let phanTichText = currentQuestion.phanTich ? currentQuestion.phanTich.replace(/\|/g, '\n') : '';
        const hanziChars = currentQuestion.hanzi.replace(/[.,!?ï¼Œã€‚ï¼ï¼Ÿ]/g, '').split('');
        hanziChars.forEach(char => {
            const hanTuInfo = bangHanTuData.find(item => item.hanTu === char);
            if (hanTuInfo) {
                const cauTaoFormatted = hanTuInfo.cauTao.replace(/\|/g, '\n');
                hanziAnalysis += `<b>+ HÃ¡n Tá»±:</b> ${hanTuInfo.hanTu}\n<span style="color: blue;">${cauTaoFormatted}</span>\n`;
            }
        });
        const phanTichElement = document.getElementById('phanTich');
        const phanTichContainer = document.getElementById('phanTich-container');
        let finalContent = '';
        if (hanziAnalysis) finalContent += hanziAnalysis;
        if (phanTichText) finalContent += `<span style="color: red;"><b>+ PhÃ¢n TÃ­ch Chung:</b></span>\n${phanTichText}`;
        phanTichElement.innerHTML = finalContent;
        if (finalContent.trim()) {
            phanTichContainer.style.display = 'block';
            phanTichElement.style.display = 'block';
        } else {
            phanTichContainer.style.display = 'none';
            phanTichElement.style.display = 'none';
        }
    }

    function hideAllPanels() {
        document.getElementById('menuContainer').style.display = 'none';
        document.getElementById('searchContainer').style.display = 'none';
        document.getElementById('hanziiContainer').style.display = 'none';
        document.getElementById('translateContainer').style.display = 'none';
        relatedHanziList.style.display = 'none';
    }

    function toggleRelated() {
        if (relatedHanziList.style.display === 'block') {
            relatedHanziList.style.display = 'none';
        } else {
            hideAllPanels();
            showRelatedHanzi();
            relatedHanziList.style.display = 'block';
        }
    }

    function toggleMenu() {
        const menu = document.getElementById('menuContainer');
        if (menu.style.display === 'block') {
            menu.style.display = 'none';
        } else {
            hideAllPanels();
            menu.style.display = 'block';
            if (!document.getElementById('volumeButtons').innerHTML) {
                createVolumeButtons();
            }
        }
    }

    function createVolumeButtons() {
        const volumeDiv = document.getElementById('volumeButtons');
        volumeDiv.innerHTML = '';
        for (let i = 1; i <= 6; i++) {
            const btn = document.createElement('button2');
            btn.textContent = `Quyá»ƒn ${i}`;
            btn.className = 'volume-btn';
            btn.onclick = () => {
                if (selectedVolume !== i) {
                    selectVolume(i);
                }
            };
            volumeDiv.appendChild(btn);
        }
    }

    function selectVolume(volume) {
        selectedVolume = volume;
        updateButtonStates();
        createLessonButtons(volume);
    }

    function createLessonButtons(volume) {
        const lessonDiv = document.getElementById('lessonButtons');
        lessonDiv.innerHTML = '';
        const lessonCounts = [15, 15, 12, 12, 10, 10];
        const lessonCount = lessonCounts[volume - 1];
        
        for (let i = 1; i <= lessonCount; i++) {
            const btn = document.createElement('button2');
            btn.textContent = `BÃ i ${i}`;
            btn.className = 'lesson-btn';
            btn.onclick = () => {
                if (selectedLesson !== i) {
                    selectLesson(i);
                }
            };
            lessonDiv.appendChild(btn);
        }
        updateButtonStates();
    }

    function selectLesson(lesson) {
        selectedLesson = lesson;
        updateButtonStates();
        const baiValue = calculateBaiValue(selectedVolume, selectedLesson);
        loadLessonData(baiValue);
    }

    function calculateBaiValue(volume, lesson) {
        switch (volume) {
            case 1: return lesson;
            case 2: return 15 + lesson;
            case 3: return 15 + 15 + lesson;
            case 4: return 15 + 15 + 12 + lesson;
            case 5: return 15 + 15 + 12 + 12 + lesson;
            case 6: return 15 + 15 + 12 + 12 + 10 + lesson;
        }
    }

    function updateButtonStates() {
        const volumeButtons = document.querySelectorAll('.volume-btn');
        const lessonButtons = document.querySelectorAll('.lesson-btn');
        
        volumeButtons.forEach((btn, index) => {
            btn.classList.toggle('active', index + 1 === selectedVolume);
        });
        
        lessonButtons.forEach((btn, index) => {
            btn.classList.toggle('active', index + 1 === selectedLesson);
        });
    }

    function loadLessonData(baiValue) {
        const tableContainer = document.getElementById('tableContainer');
        const filteredData = hanzi3Data.filter(item => parseInt(item.bai) === baiValue);
        
        let tableHTML = `
            <table>
                <tr>
                    <th>ID</th>
                    <th>HÃ¡n tá»±</th>
                    <th>Pinyin</th>
                    <th>KÃ½ hiá»‡u</th>
                    <th>NghÄ©a</th>
                </tr>
        `;
        
        filteredData.forEach(item => {
            tableHTML += `
                <tr onclick="selectHanzi('${item.hanzi}')">
                    <td>${item.id}</td>
                    <td>${item.hanzi}</td>
                    <td>${item.pinyin}</td>
                    <td>${item.kyhieu}</td>
                    <td>${item.nghia}</td>
                </tr>
            `;
        });
        
        tableHTML += '</table>';
        tableContainer.innerHTML = tableHTML;
    }

    function updateHanzi(hanzi) {
        giatrihanzi = hanzi;
        console.log('Selected hanzi:', giatrihanzi);
        const hanziiContainer = document.getElementById('hanziiContainer');
        const hanziiIframe = document.getElementById('hanziiIframe');
        
        if (hanziiContainer.style.display === 'block' && giatrihanzi === hanzi) {
            hanziiContainer.style.display = 'none';
        } else {
            hideAllPanels();
            hanziiIframe.src = `https://hanzii.net/search/kanji/${encodeURIComponent(giatrihanzi)}?hl=vi`;
            hanziiContainer.style.display = 'block';
        }
    }

    function selectHanzi(hanzi) {
        updateHanzi(hanzi);
    }

   document.addEventListener('click', function(event) {
    const infoPopup = document.getElementById('info-popup');
    const nestedInfoPopup = document.getElementById('nested-info-popup');
    const authorPopup = document.getElementById('author-popup');
    
    // Kiá»ƒm tra náº¿u info-popup Ä‘ang hiá»ƒn thá»‹ vÃ  nháº¥p chuá»™t bÃªn ngoÃ i
    if (infoPopup.style.display === 'block' && !infoPopup.contains(event.target)) {
        closeInfoPopup();
    }
    
    // Kiá»ƒm tra náº¿u nested-info-popup Ä‘ang hiá»ƒn thá»‹ vÃ  nháº¥p chuá»™t bÃªn ngoÃ i
    if (nestedInfoPopup.style.display === 'block' && !nestedInfoPopup.contains(event.target)) {
        closeNestedInfoPopup();
    }
    
    // Kiá»ƒm tra náº¿u author-popup Ä‘ang hiá»ƒn thá»‹ vÃ  nháº¥p chuá»™t bÃªn ngoÃ i
    if (authorPopup.style.display === 'block' && !authorPopup.contains(event.target)) {
        closeAuthorPopup();
    }
});

    function toggleSearch() {
        const searchContainer = document.getElementById('searchContainer');
        const searchInput = document.getElementById('searchInput');
        if (searchContainer.style.display === 'block') {
            searchContainer.style.display = 'none';
        } else {
            hideAllPanels();
            searchContainer.style.display = 'block';
            searchInput.value = currentQuestion.hanzi;
        }
    }

    function searchHanzi() {
        const input = document.getElementById('searchInput').value.trim();
        if (input) {
            updateHanzi(input);
        }
    }

    function toggleTranslate() {
        const translateContainer = document.getElementById('translateContainer');
        const translateIframe = document.getElementById('translateIframe');
        if (translateContainer.style.display === 'block') {
            translateContainer.style.display = 'none';
        } else {
            hideAllPanels();
            translateIframe.src = 'https://vi.ilovetranslation.com/';
            translateContainer.style.display = 'block';
        }
    }

    function timeToSeconds(timeStr) {
    try {
        // Loáº¡i bá» khoáº£ng tráº¯ng vÃ  kiá»ƒm tra Ä‘á»‹nh dáº¡ng
        timeStr = timeStr.trim();
        if (!/^\d+:\d{2}:\d{2}$/.test(timeStr)) {
            throw new Error("Äá»‹nh dáº¡ng thá»i gian khÃ´ng Ä‘Ãºng, yÃªu cáº§u phÃºt:giÃ¢y:pháº§n_trÄƒm_giÃ¢y");
        }

        const [minutes, seconds, centiseconds] = timeStr.split(':').map(Number);
        if (isNaN(minutes) || isNaN(seconds) || isNaN(centiseconds)) {
            throw new Error("GiÃ¡ trá»‹ thá»i gian khÃ´ng há»£p lá»‡");
        }

        // Äáº£m báº£o seconds vÃ  centiseconds náº±m trong pháº¡m vi há»£p lá»‡
        if (seconds >= 60 || centiseconds >= 100) {
            throw new Error("GiÃ¡ trá»‹ giÃ¢y hoáº·c pháº§n trÄƒm giÃ¢y khÃ´ng há»£p lá»‡");
        }

        return minutes * 60 + seconds + centiseconds / 100;
    } catch (error) {
        console.error("Lá»—i xá»­ lÃ½ thá»i gian:", error.message, "Chuá»—i thá»i gian:", timeStr);
        return 0;
    }
}

    function setupAudio(audioElement, link, timeRange) {
        audioElement.src = link;
        if (timeRange && timeRange.includes(' - ')) {
            const [startTimeStr, endTimeStr] = timeRange.split(' - ');
            audioStartTime = Math.max(0, timeToSeconds(startTimeStr) - 0.2);
            audioEndTime = timeToSeconds(endTimeStr) + 0.2;
            audioElement.currentTime = audioStartTime;
        }
    }

    function playCurrentAudio(callback) {
        const audio = document.getElementById('audio');
        audio.currentTime = audioStartTime;
        audio.play().catch(error => {
            console.error("Lá»—i phÃ¡t audio:", error);
        });

        audio.onended = () => {
            callback();
        };

        audio.addEventListener('timeupdate', function handler() {
            if (audio.currentTime >= audioEndTime) {
                audio.pause();
                audio.currentTime = audioStartTime;
                audio.removeEventListener('timeupdate', handler);
                audio.onended();
            }
        });
    }

    const audio = document.getElementById('audio');
    const playButton = document.getElementById('playButton');
    let isHintVisible = false;
    const hintButton = document.getElementById('hintButton');

    hintButton.addEventListener('click', function() {
    const questionElement = document.getElementById('question');
    const pinyinElement = document.getElementById('pinyin');
    const kyhieuElement = document.getElementById('kyhieu');
    const pinyinContainer = document.getElementById('pinyin-container');
    const phanTichElement = document.getElementById('phanTich');
    const phanTichContainer = document.getElementById('phanTich-container');
    const meaningContainer = document.getElementById('meaning-container');
    const dialogueDisplay = document.getElementById('dialogue-display');

    if (isHintVisible) {
        pinyinElement.style.display = 'none';
        kyhieuElement.style.display = 'none';
        pinyinContainer.style.display = 'none';
        phanTichElement.style.display = 'none';
        phanTichContainer.style.display = 'none';
        questionElement.style.display = 'none';
        meaningContainer.style.display = showMeaning ? 'block' : 'none';
        if (quizType === 'dialogue' && !isScrambleMode) {
            dialogueDisplay.style.display = 'block';
        }
        isHintVisible = false;
    } else {
        questionElement.innerText = currentQuestion.hanzi.replace(/\|/g, '\n');
        pinyinElement.innerText = currentQuestion.pinyin ? currentQuestion.pinyin.replace(/\|/g, '\n') : '';
        kyhieuElement.innerText = currentQuestion.kyhieu ? currentQuestion.kyhieu.replace(/\|/g, '\n') : '';
        if (quizType === 'vocabulary') showAnalysis();
        
        // Hiá»ƒn thá»‹ HÃ¡n tá»± trong má»i cháº¿ Ä‘á»™
        questionElement.style.display = 'block';
        
        // Hiá»ƒn thá»‹ pinyin vÃ  kÃ½ hiá»‡u náº¿u cÃ³
        pinyinElement.style.display = currentQuestion.pinyin ? 'block' : 'none';
        kyhieuElement.style.display = currentQuestion.kyhieu ? 'block' : 'none';
        
        // Hiá»ƒn thá»‹ pinyinContainer náº¿u cÃ³ pinyin hoáº·c kÃ½ hiá»‡u, hoáº·c trong Há»™i Thoáº¡i Ä‘á»ƒ chá»©a HÃ¡n tá»±
        pinyinContainer.style.display = (currentQuestion.pinyin || currentQuestion.kyhieu || quizType === 'dialogue') ? 'flex' : 'none';
        
        // Xá»­ lÃ½ phÃ¢n tÃ­ch cho Tá»« Vá»±ng
        if (quizType === 'vocabulary') {
            phanTichContainer.style.display = 'block';
            phanTichElement.style.display = 'block';
        } else {
            phanTichContainer.style.display = 'none';
            phanTichElement.style.display = 'none';
        }
        
        meaningContainer.style.display = 'block';
        if (quizType === 'dialogue') {
            dialogueDisplay.style.display = 'block';
        }
        isHintVisible = true;
    }
});

    playButton.addEventListener('click', function() {
    if (currentQuestion.linkmp3) {
        setupAudio(audio, currentQuestion.linkmp3, currentQuestion.time);
        playCurrentAudio(() => {});
    } else {
        console.warn('KhÃ´ng cÃ³ linkmp3 Ä‘á»ƒ phÃ¡t:', currentQuestion);
    }
});

    function showRelatedHanzi() {
        const hanzi = currentQuestion.hanzi;
        const characters = hanzi.split('');
        const relatedWords = allWords.filter(word => 
            characters.some(char => word.hanzi.includes(char)) && word.hanzi !== hanzi
        );

        relatedHanziList.innerHTML = '';
        if (relatedWords.length === 0) {
            relatedHanziList.innerHTML = '<p>KhÃ´ng tÃ¬m tháº¥y hanzi liÃªn quan.</p>';
        } else {
            relatedWords.forEach(word => {
                const p = document.createElement('p');
                p.innerText = `${word.id}. ${word.hanzi} (${word.pinyin}): ${word.nghia} | BÃ i: ${word.bai}`;
                relatedHanziList.appendChild(p);
            });
        }
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function updateStatus() {
        document.getElementById('wrong-count').innerText = `Sá»‘ tá»« bá»‹ sai: ${wrongHanzi.length}`;
        document.getElementById('total-count').innerText = `Tá»•ng sá»‘ tá»«: ${totalWords - questionCount}`;
        document.getElementById('review-mode').style.display = isReviewMode ? 'inline' : 'none';
    }

    function getUniqueWrongOptions(currentHanzi, sourceArray, count) {
        const filtered = sourceArray.filter(item => item.hanzi !== currentHanzi);
        const shuffled = shuffle([...filtered]);
        return shuffled.slice(0, Math.min(count, shuffled.length));
    }

    let totalWords = 0;

    function loadNewQuestion() {
	
	// áº¨n hÃ¬nh áº£nh há»™i thoáº¡i náº¿u khÃ´ng pháº£i cháº¿ Ä‘á»™ dialogue
const dialogueImage = document.getElementById('dialogue-image');
if (quizType !== 'dialogue') {
    dialogueImage.style.display = 'none';
}

    currentScrambleAnswer = '';
    document.getElementById('diceButton').disabled = false;
    relatedHanziList.style.display = 'none';
    document.getElementById('question').style.display = 'none';
    document.getElementById('pinyin-container').style.display = 'none';
    document.getElementById('pinyin').style.display = 'none';
    document.getElementById('kyhieu').style.display = 'none';

    const phanTichContainer = document.getElementById('phanTich-container');
    const relatedBtn = document.querySelector('.related-btn');
    const infoButton = document.getElementById('infoButton');
    const authorButton = document.getElementById('authorButton');

    infoButton.style.display = 'none';
    authorButton.style.display = 'none';
    // XÃ³a dÃ²ng nÃ y: relatedBtn.style.display = 'inline-block';
    phanTichContainer.style.display = 'none';

    // Cáº­p nháº­t hiá»ƒn thá»‹ nÃºt ğŸ” vÃ  ğŸ”—
    updateButtonVisibility();

    // Äáº£m báº£o status-container hiá»ƒn thá»‹ cho Tá»« Vá»±ng vÃ  Máº«u CÃ¢u
    const statusContainer = document.getElementById('status-container');
    if (quizType === 'vocabulary' || quizType === 'sentence') {
        statusContainer.style.display = 'flex';
    } else {
        statusContainer.style.display = 'none';
    }

    let currentList = isReviewMode ? currentReviewList.map(id => allWords.find(word => word.id === id)).filter(word => word) : selectedHanzi;

    if (quizType === 'dialogue') {
        if (questionCount >= currentList.length || questionCount < 0) {
            endGame();
            return;
        }
        currentQuestion = currentList[questionCount];
        if (!currentQuestion) {
            console.error(`KhÃ´ng tÃ¬m tháº¥y cÃ¢u há»i táº¡i questionCount: ${questionCount}`);
            endGame();
            return;
        }

        // Hiá»ƒn thá»‹ nÃºt ğŸ“‹ vÃ  ğŸ‘² cho Há»™i Thoáº¡i
        if (currentQuestion.thongTin) {
            infoButton.style.display = 'inline-block';
            infoButton.onclick = () => showInfoPopup(currentQuestion.thongTin);
        }
        if (currentQuestion.tacGia) {
            authorButton.style.display = 'inline-block';
            authorButton.onclick = () => showAuthorPopup(currentQuestion.tacGia);
        }

        relatedBtn.style.display = 'none';
        if (isWritingMode) {
            startWritingMode();
        } else if (isScrambleMode) {
            startScrambleGame();
        } else {
            updateDialogueContainer();
            document.getElementById('dialogue-display').style.display = 'block';
            document.getElementById('option-buttons').style.display = 'none';
            document.getElementById('meaning-container').style.display = showMeaning ? 'block' : 'none';
        }
    } else {
        // Kiá»ƒm tra Ä‘iá»u kiá»‡n chuyá»ƒn sang cháº¿ Ä‘á»™ Ã´n táº­p
        if (questionCount >= maxWords || questionCount >= currentList.length) {
            if (wrongHanzi.length > 0 && !isReviewMode) {
                isReviewMode = true;
                questionCount = 0;
                currentReviewList = [...wrongHanzi];
                totalWords = currentReviewList.length;
                wrongHanzi = [];
                currentList = currentReviewList.map(id => allWords.find(word => word.id === id)).filter(word => word);
                const reviewHanziDisplay = document.getElementById('review-hanzi-display');
                const reviewHanziList = document.getElementById('review-hanzi-list');
                reviewHanziList.innerHTML = '';
                currentList.forEach(word => {
                    const li = document.createElement('li');
                    li.textContent = `ID: ${word.id}, Hanzi: ${word.hanzi}`;
                    reviewHanziList.appendChild(li);
                });
                reviewHanziDisplay.style.display = 'block';
            } else {
                endGame();
                return;
            }
        }

        currentQuestion = currentList[questionCount];
        if (!currentQuestion) {
            console.error(`KhÃ´ng tÃ¬m tháº¥y cÃ¢u há»i táº¡i questionCount: ${questionCount}`);
            endGame();
            return;
        }

        // Hiá»ƒn thá»‹ nÃºt ğŸ“‹ cho Máº«u CÃ¢u
        if (quizType === 'sentence' && currentQuestion.thongTin) {
            infoButton.style.display = 'inline-block';
            infoButton.onclick = () => showInfoPopup(currentQuestion.thongTin);
        }

        if (quizType === 'sentence') {
            relatedBtn.style.display = 'none';
        }

        if (timerInterval) clearInterval(timerInterval);

        document.getElementById('searchInput').value = currentQuestion.hanzi;

        const meaningContainer = document.getElementById('meaning-container');
        const optionButtons = document.getElementById('option-buttons');
        const answerInput = document.getElementById('answerInput');

        document.getElementById('meaning').innerText = currentQuestion.nghia.replace(/\|/g, '\n');
        meaningContainer.style.display = showMeaning ? 'block' : 'none';
        document.getElementById('dialogue-display').style.display = 'none';

        if (isWritingMode) {
            startWritingMode();
        } else if (isScrambleMode) {
            startScrambleGame();
        } else {
            optionButtons.style.display = 'grid';
            isHintVisible = false;
            if (currentQuestion.linkmp3) {
                setupAudio(audio, currentQuestion.linkmp3, currentQuestion.time);
                if (!showMeaning) {
                    playCurrentAudio(() => {});
                }
            }

            const optionCount = quizType === "vocabulary" ? 9 : 5;
            const otherOptions = getUniqueWrongOptions(currentQuestion.hanzi, allWords, optionCount);
            const options = shuffle([currentQuestion, ...otherOptions]);

            optionButtons.innerHTML = '';
            options.forEach(option => {
                const button = document.createElement('button');
                button.innerText = option.hanzi.replace(/\|/g, '\n');
                button.style.justifyContent = quizType === "sentence" ? 'flex-start' : 'center';
                button.addEventListener('click', () => validateAnswer(button, option));
                optionButtons.appendChild(button);
            });

            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').disabled = false;
            document.getElementById('inputPinyinDisplay').textContent = '';

            timeRemaining = timeLimit;
            const timerElement = document.getElementById('timer');
            timerElement.innerText = `Thá»i gian: ${timeRemaining}`;
            timerInterval = setInterval(() => {
                timeRemaining--;
                timerElement.innerText = `Thá»i gian: ${timeRemaining}`;
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    const fakeOption = { hanzi: '' };
                    validateAnswer(null, fakeOption);
                }
            }, 1000);
        }
    }

    updateStatus();
	
}

    function validateAnswer(button, selectedOption) {
    const feedbackMessage = document.getElementById('feedback');
    const pinyinElement = document.getElementById('pinyin');
    const kyhieuElement = document.getElementById('kyhieu');
    const pinyinContainer = document.getElementById('pinyin-container');
    const phanTichElement = document.getElementById('phanTich');
    const phanTichContainer = document.getElementById('phanTich-container');
    const answerInput = document.getElementById('answerInput');
    const meaningContainer = document.getElementById('meaning-container');
    const questionElement = document.getElementById('question');
    const readCompleteContainer = document.getElementById('read-complete-container');

    if (selectedOption.hanzi === currentQuestion.hanzi) {
        if (button) button.classList.add('correct');
        feedbackMessage.innerText = 'Tá»‘t láº¯m, báº¡n Ä‘Ã£ chá»n Ä‘Ãºng!';
        feedbackMessage.style.display = 'block';
        document.querySelectorAll('#option-buttons button').forEach(btn => btn.disabled = true);
        answerInput.disabled = true;
        if (timerInterval) clearInterval(timerInterval);

        questionElement.innerText = currentQuestion.hanzi.replace(/\|/g, '\n');
        pinyinElement.innerText = currentQuestion.pinyin.replace(/\|/g, '\n');
        kyhieuElement.innerText = currentQuestion.kyhieu.replace(/\|/g, '\n');
        if (quizType === 'vocabulary') showAnalysis();

        questionElement.style.display = 'block';
        pinyinElement.style.display = 'block';
        kyhieuElement.style.display = 'block';
        pinyinContainer.style.display = 'flex';
        if (quizType === 'vocabulary') {
earnedEXP += 1; // 1 Ä‘iá»ƒm cho Tá»« Vá»±ng
document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
            phanTichContainer.style.display = 'block';
            phanTichElement.style.display = 'block';
        } else {
earnedEXP += 2; // 2 Ä‘iá»ƒm cho Máº«u CÃ¢u
document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
            phanTichContainer.style.display = 'none';
            phanTichElement.style.display = 'none';
        }
        meaningContainer.style.display = 'block';
        isHintVisible = true;

        const nextAction = () => {
            feedbackMessage.style.display = 'none';
            pinyinElement.style.display = 'none';
            kyhieuElement.style.display = 'none';
            pinyinContainer.style.display = 'none';
            phanTichContainer.style.display = 'none';
            phanTichElement.style.display = 'none';
            questionElement.style.display = 'none';
            readCompleteContainer.style.display = 'none';
            meaningContainer.style.display = showMeaning ? 'block' : 'none';
            isHintVisible = false;
            answerInput.value = '';
            answerInput.disabled = false;
            questionCount++;
            if (questionCount < selectedHanzi.length) {
                loadNewQuestion();
            } else {
                // Kiá»ƒm tra cháº¿ Ä‘á»™ Ã´n táº­p
                if ((quizType === 'vocabulary' || quizType === 'sentence') && wrongHanzi.length > 0 && !isReviewMode) {
                    isReviewMode = true;
                    questionCount = 0;
                    currentReviewList = [...wrongHanzi];
                    totalWords = currentReviewList.length;
                    wrongHanzi = [];
                    selectedHanzi = currentReviewList.map(id => allWords.find(word => word.id === id)).filter(word => word);
                    const reviewHanziDisplay = document.getElementById('review-hanzi-display');
                    const reviewHanziList = document.getElementById('review-hanzi-list');
                    reviewHanziList.innerHTML = '';
                    selectedHanzi.forEach(word => {
                        const li = document.createElement('li');
                        li.textContent = `ID: ${word.id}, Hanzi: ${word.hanzi}`;
                        reviewHanziList.appendChild(li);
                    });
                    reviewHanziDisplay.style.display = 'block';
                    loadNewQuestion();
                } else {
                    endGame();
                }
            }
        };

        if (isNewWordMode) {
            readCompleteContainer.style.display = 'block';
            const readCompleteButton = document.getElementById('read-complete-button');
            readCompleteButton.onclick = () => {
                playCurrentAudio(nextAction);
            };
        } else {
            playCurrentAudio(nextAction);
        }
    } else {
        if (button) button.classList.add('incorrect');
        feedbackMessage.innerText = 'Sai rá»“i, vui lÃ²ng chá»n láº¡i!';
        feedbackMessage.style.display = 'block';
        if (quizType === 'vocabulary' || quizType === 'sentence') {
    if (!wrongHanzi.includes(currentQuestion.id)) {
        wrongHanzi.push(currentQuestion.id);
        const wrongHanziList = document.getElementById('wrong-hanzi-list');
        const li = document.createElement('li');
        li.textContent = `ID: ${currentQuestion.id}, Hanzi: ${currentQuestion.hanzi}`;
        wrongHanziList.appendChild(li);
    }
    // Trá»« Ä‘iá»ƒm dá»±a trÃªn loáº¡i quiz
    if (quizType === 'vocabulary') {
        earnedEXP -= 3;
    } else if (quizType === 'sentence') {
        earnedEXP -=6;
    }
    document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
}
        setTimeout(() => {
            if (button) button.classList.remove('incorrect');
            feedbackMessage.innerText = '';
            feedbackMessage.style.display = 'none';
            answerInput.value = '';
            updateStatus();
        }, 200);
    }
}

    function endGame() {
    // Dá»«ng timer náº¿u Ä‘ang cháº¡y
    if (timerInterval) clearInterval(timerInterval);

    // VÃ´ hiá»‡u hÃ³a cÃ¡c nÃºt vÃ  input
    document.getElementById('answerInput').disabled = true;
    document.getElementById('playButton').disabled = true;
    document.getElementById('hintButton').disabled = true;
    document.getElementById('diceButton').disabled = true;
    document.getElementById('writeButton').disabled = true;
    document.getElementById('write-dialogue-button').disabled = true;
    document.getElementById('back-button').disabled = true;
    document.getElementById('next-button').disabled = true;
    document.querySelectorAll('#option-buttons button').forEach(btn => btn.disabled = true);
    document.querySelectorAll('#scrambled-buttons button').forEach(btn => btn.disabled = true);

    // Dá»«ng audio
    const audio = document.getElementById('audio');
    audio.src = '';

    // Kiá»ƒm tra nhiá»‡m vá»¥ ngáº«u nhiÃªn
    let finalEXP = earnedEXP;
    let missionMessage = '';
    const lessonInput = document.getElementById('lesson-input').value.trim();
    const lessonFilter = parseLessonInput(lessonInput);
    if (randomMissionLesson && lessonFilter && lessonFilter.includes(randomMissionLesson.toString())) {
        finalEXP *= 2;
        missionMessage = `<div style="font-size: 18px; color: green; text-align: center; margin: 10px 0;">
            HoÃ n thÃ nh nhiá»‡m vá»¥! EXP Ä‘Æ°á»£c nhÃ¢n Ä‘Ã´i!
        </div>`;
    }

    // Kiá»ƒm tra náº¿u Ä‘ang á»Ÿ cháº¿ Ä‘á»™ Tá»« Vá»±ng hoáº·c Máº«u CÃ¢u vÃ  cÃ²n tá»« sai
    if ((quizType === 'vocabulary' || quizType === 'sentence') && wrongHanzi.length > 0) {
        // Chuyá»ƒn sang cháº¿ Ä‘á»™ Ã´n táº­p
        isReviewMode = true;
        questionCount = 0;
        currentReviewList = [...wrongHanzi];
        totalWords = currentReviewList.length;
        wrongHanzi = []; // XÃ³a danh sÃ¡ch tá»« sai Ä‘á»ƒ báº¯t Ä‘áº§u lÆ°á»£t má»›i
        selectedHanzi = currentReviewList.map(id => allWords.find(word => word.id === id)).filter(word => word);

        // Cáº­p nháº­t danh sÃ¡ch tá»« Ã´n táº­p
        const reviewHanziDisplay = document.getElementById('review-hanzi-display');
        const reviewHanziList = document.getElementById('review-hanzi-list');
        reviewHanziList.innerHTML = '';
        selectedHanzi.forEach(word => {
            const li = document.createElement('li');
            li.textContent = `ID: ${word.id}, Hanzi: ${word.hanzi}`;
            reviewHanziList.appendChild(li);
        });
        reviewHanziDisplay.style.display = 'block';

        // Táº£i cÃ¢u há»i má»›i
        document.getElementById('answerInput').disabled = false;
        document.getElementById('playButton').disabled = false;
        document.getElementById('hintButton').disabled = false;
        loadNewQuestion();
    } else {
        // Hiá»ƒn thá»‹ popup thÃ´ng bÃ¡o hoÃ n thÃ nh
        const popup = document.getElementById('endgame-popup');
        const popupContent = document.getElementById('endgame-popup-content');
        popupContent.innerHTML = `
            <div style="font-size: 24px; color: green; text-align: center;">
                BÃ i Ã´n táº­p Ä‘Ã£ hoÃ n thÃ nh!
            </div>
            ${missionMessage}
            <div style="font-size: 18px; text-align: center; margin: 10px 0;">
                Äiá»ƒm kinh nghiá»‡m kiáº¿m Ä‘Æ°á»£c: ${finalEXP}
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button2 id="claim-exp-button" class="quiz-type-button">NHáº¬N ÄIá»‚M KINH NGHIá»†M</button2>
            </div>
        `;
        popup.style.display = 'block';

        // Gáº¯n sá»± kiá»‡n cho nÃºt Nháº­n Ä‘iá»ƒm kinh nghiá»‡m
        document.getElementById('claim-exp-button').addEventListener('click', () => claimExperience(finalEXP));
    }
}

    function parseLessonInput(input) {
    // Láº¥y danh sÃ¡ch bÃ i há»£p lá»‡ dá»±a trÃªn cáº¥p Ä‘á»™ hiá»‡n táº¡i
    const currentLevel = parseInt(document.getElementById('account-level').textContent) || 1;
    const validLessons = lessonListData
        .filter(item => currentLevel >= item.level_unlock)
        .map(item => item.bai.toString());

    if (!input) {
        // Náº¿u input trá»‘ng, chá»n ngáº«u nhiÃªn má»™t bÃ i tá»« danh sÃ¡ch há»£p lá»‡
        if (validLessons.length === 0) {
            alert('KhÃ´ng cÃ³ bÃ i nÃ o há»£p lá»‡ hoáº·c Ä‘Ã£ má»Ÿ khÃ³a!');
            return null;
        }
        const randomLesson = validLessons[Math.floor(Math.random() * validLessons.length)];
        return [randomLesson];
    }

    if (input.includes('-')) {
        const [start, end] = input.split('-').map(num => parseInt(num.trim()));
        if (isNaN(start) || isNaN(end) || start > end) {
            alert('Äá»‹nh dáº¡ng khoáº£ng bÃ i khÃ´ng há»£p lá»‡!');
            return null;
        }
        // Lá»c chá»‰ cÃ¡c bÃ i há»£p lá»‡ vÃ  Ä‘Ã£ má»Ÿ khÃ³a trong khoáº£ng tá»« start Ä‘áº¿n end
        const filteredLessons = [];
        for (let i = start; i <= end; i++) {
            if (validLessons.includes(i.toString())) {
                filteredLessons.push(i.toString());
            }
        }
        if (filteredLessons.length === 0) {
            alert('KhÃ´ng cÃ³ bÃ i nÃ o há»£p lá»‡ hoáº·c Ä‘Ã£ má»Ÿ khÃ³a trong khoáº£ng Ä‘Ã£ chá»n!');
            return null;
        }
        return filteredLessons;
    }

    if (input.includes(',')) {
        const lessons = input.split(',').map(num => num.trim());
        // Lá»c chá»‰ cÃ¡c bÃ i há»£p lá»‡ vÃ  Ä‘Ã£ má»Ÿ khÃ³a
        const filteredLessons = lessons.filter(num => !isNaN(parseInt(num)) && validLessons.includes(num));
        if (filteredLessons.length === 0) {
            alert('KhÃ´ng cÃ³ bÃ i nÃ o há»£p lá»‡ hoáº·c Ä‘Ã£ má»Ÿ khÃ³a trong danh sÃ¡ch Ä‘Ã£ chá»n!');
            return null;
        }
        return filteredLessons;
    }

    const singleLesson = input.trim();
    const lessonData = lessonListData.find(item => item.bai.toString() === singleLesson);
    if (!lessonData) {
        alert(`BÃ i ${singleLesson} khÃ´ng cÃ³ trong danh sÃ¡ch bÃ i há»£p lá»‡!`);
        return null;
    }
    if (currentLevel < lessonData.level_unlock) {
        alert(`Báº¡n chÆ°a Ä‘áº¡t cáº¥p ${lessonData.level_unlock} Ä‘á»ƒ má»Ÿ khÃ³a bÃ i ${singleLesson}!`);
        return null;
    }
    return [singleLesson];
}

    function startGame() {
    const diceButton = document.getElementById('diceButton');
    const writeButton = document.getElementById('writeButton');
    const diceDialogueButton = document.getElementById('dice-button');
    const writeDialogueButton = document.getElementById('write-dialogue-button');
    
    diceButton.style.display = (quizType === "sentence" || quizType === "dialogue") ? 'inline-block' : 'none';
    writeButton.style.display = (quizType === "vocabulary" || quizType === "sentence") ? 'inline-block' : 'none';
    diceDialogueButton.style.display = (quizType === "dialogue") ? 'inline-block' : 'none';
    writeDialogueButton.style.display = (quizType === "dialogue") ? 'inline-block' : 'none';

    const phanTichContainer = document.getElementById('phanTich-container');
    const relatedBtn = document.querySelector('.related-btn');
    if (quizType === 'dialogue' || quizType === 'sentence') {
        phanTichContainer.style.display = 'none';
        relatedBtn.style.display = 'none';
    } else {
        phanTichContainer.style.display = 'none';
        // XÃ³a dÃ²ng nÃ y: relatedBtn.style.display = 'inline-block';
    }

    // Cáº­p nháº­t hiá»ƒn thá»‹ nÃºt ğŸ” vÃ  ğŸ”— dá»±a trÃªn selectedMode
    updateButtonVisibility();

    const wordCountInput = document.getElementById('word-count');
    const lessonInput = document.getElementById('lesson-input').value;
    const timeLimitInput = document.getElementById('time-limit');

    // Hiá»ƒn thá»‹ status-container cho Tá»« Vá»±ng vÃ  Máº«u CÃ¢u
    const statusContainer = document.getElementById('status-container');
    if (quizType === 'vocabulary' || quizType === 'sentence') {
        statusContainer.style.display = 'flex';
    } else {
        statusContainer.style.display = 'none';
    }

    if (quizType !== 'dialogue') {
        // Sá»­ dá»¥ng toÃ n bá»™ sá»‘ tá»« trong bÃ i náº¿u Ä‘á»ƒ trá»‘ng
        maxWords = parseInt(wordCountInput.value) || Infinity;
        if (!maxWords || maxWords < 1) maxWords = Infinity;

        timeLimit = parseInt(timeLimitInput.value) || 20;
        timeRemaining = timeLimit;
    } else {
        maxWords = Infinity;
        timeLimit = 0;
        timeRemaining = 0;
    }

    let filteredWords = [];
    const lessonFilter = parseLessonInput(lessonInput);

// Kiá»ƒm tra náº¿u lessonFilter lÃ  null (tá»©c lÃ  khÃ´ng cÃ³ bÃ i há»£p lá»‡)
    if (!lessonFilter && lessonInput) {
        return; // Dá»«ng hÃ m startGame, khÃ´ng cháº¡y game
    }

// Láº¥y danh sÃ¡ch cÃ¡c bÃ i há»£p lá»‡ dá»±a trÃªn cáº¥p Ä‘á»™ hiá»‡n táº¡i
    const currentLevel = parseInt(document.getElementById('account-level').textContent) || 1;
    const validLessons = lessonListData
        .filter(item => currentLevel >= item.level_unlock)
        .map(item => item.bai.toString());

    if (quizType === 'dialogue') {
        selectedDialogue = document.getElementById('dialogue-number').value.trim();
        filteredWords = dialogueData.filter(item => lessonFilter ? lessonFilter.includes(item.bai) : true);
        if (filteredWords.length === 0) {
            alert('KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u há»™i thoáº¡i!');
            return;
        }

        if (!selectedDialogue) {
            let allDialogues = [];
            filteredWords.forEach(item => {
                const dialoguesInBai = Object.keys(item.hoiThoai)
                    .filter(key => item.hoiThoai[key].length > 0)
                    .map(key => item.hoiThoai[key]);
                allDialogues = allDialogues.concat(dialoguesInBai);
            });
            if (allDialogues.length === 0) {
                alert('KhÃ´ng tÃ¬m tháº¥y há»™i thoáº¡i nÃ o trong bÃ i nÃ y!');
                return;
            }
            allWords = shuffle([...allDialogues]).flat();
        } else {
            const dialogueNum = parseInt(selectedDialogue);
            if (isNaN(dialogueNum) || dialogueNum < 1) {
                alert('Vui lÃ²ng nháº­p sá»‘ há»™i thoáº¡i há»£p lá»‡!');
                return;
            }
            allWords = filteredWords[0].hoiThoai[dialogueNum] || [];
            if (allWords.length === 0) {
                alert(`KhÃ´ng tÃ¬m tháº¥y há»™i thoáº¡i sá»‘ ${dialogueNum} trong bÃ i nÃ y!`);
                return;
            }
        }
        selectedHanzi = allWords;
        totalWords = selectedHanzi.length;
    } else {
        filteredWords = jsonData;
        if (lessonFilter) {
            filteredWords = jsonData.filter(word => lessonFilter.includes(word.bai));
        }
        allWords = filteredWords;
        if (filteredWords.length === 0) {
            alert('KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u cho lá»±a chá»n nÃ y!');
            return;
        }
        if (maxWords > filteredWords.length) maxWords = filteredWords.length;
        selectedHanzi = shuffle([...filteredWords]).slice(0, maxWords);
        totalWords = selectedHanzi.length;
    }

    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('game-container').style.display = 'block';

    const pinyinContainer = document.getElementById('pinyin-container');
    const pinyinKyhieuGroup = document.querySelector('.pinyin-kyhieu-group');
    const buttonGrid = document.getElementById('option-buttons');
    const meaningContainer = document.getElementById('meaning-container');
    const questionElement = document.getElementById('question');

    if (quizType === "dialogue" || quizType === "sentence") {
        pinyinContainer.style.textAlign = 'left';
        pinyinContainer.style.marginTop = '0';
        pinyinContainer.style.display = 'none';
        pinyinContainer.style.flexDirection = 'column';
        pinyinContainer.style.alignItems = 'flex-start';
        pinyinKyhieuGroup.style.flexDirection = 'column';
        pinyinKyhieuGroup.style.textAlign = 'left';
        pinyinKyhieuGroup.style.justifyContent = 'flex-start';
        buttonGrid.style.gridTemplateColumns = 'repeat(1, 1fr)';
        meaningContainer.style.textAlign = 'left';
        questionElement.style.textAlign = 'left';
    } else {
        pinyinContainer.style.textAlign = 'center';
        pinyinContainer.style.marginTop = '0';
        pinyinContainer.style.display = 'none';
        pinyinContainer.style.flexDirection = 'column';
        pinyinContainer.style.alignItems = 'center';
        pinyinKyhieuGroup.style.flexDirection = 'row';
        pinyinKyhieuGroup.style.textAlign = 'center';
        pinyinKyhieuGroup.style.justifyContent = 'center';
        buttonGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
        meaningContainer.style.textAlign = 'center';
        questionElement.style.textAlign = 'center';
    }

    questionCount = 0;
    wrongHanzi = [];
    isReviewMode = false;
    currentReviewList = [];
    loadNewQuestion();

    const answerInput = document.getElementById('answerInput');
    const inputPinyinDisplay = document.getElementById('inputPinyinDisplay');
    const testButton = document.getElementById('testButton');
    const autoCheck = document.getElementById('autoCheck');

    function displayPinyin() {
        const userInput = answerInput.value.trim();
        inputPinyinDisplay.textContent = '';
        if (userInput) {
            const inputPinyin = hanziToPinyin(userInput);
            inputPinyinDisplay.textContent = `Pinyin: ${inputPinyin}`;
        }
    }

    function checkPinyin() {
        const userInput = document.getElementById('answerInput').value.trim();
        const feedbackMessage = document.getElementById('feedback');
        const inputPinyinDisplay = document.getElementById('inputPinyinDisplay');
        const readCompleteContainer = document.getElementById('read-complete-container');

        if (!userInput) {
            feedbackMessage.innerText = 'Vui lÃ²ng nháº­p HÃ¡n tá»±!';
            feedbackMessage.style.display = 'block';
            setTimeout(() => {
                feedbackMessage.innerText = '';
                feedbackMessage.style.display = 'none';
            }, 1000);
            return;
        }

        const cleanUserInput = userInput.replace(/[.,!?ï¼Œã€‚ï¼ï¼Ÿ]/g, '');
        const cleanQuestionHanzi = currentQuestion.hanzi.replace(/[.,!?ï¼Œã€‚ï¼ï¼Ÿ]/g, '');
        const inputPinyin = hanziToPinyin(cleanUserInput);
        const questionPinyinOptions = getAllPinyinCombinations(cleanQuestionHanzi);
        const isCorrect = isPinyinMatch(inputPinyin, questionPinyinOptions);

        if (isCorrect) {
            feedbackMessage.innerText = 'Tá»‘t láº¯m, báº¡n Ä‘Ã£ chá»n Ä‘Ãºng!';
            feedbackMessage.style.display = 'block';
            document.getElementById('answerInput').disabled = true;
            if (timerInterval) clearInterval(timerInterval);

            const questionElement = document.getElementById('question');
            const pinyinElement = document.getElementById('pinyin');
            const kyhieuElement = document.getElementById('kyhieu');
            const pinyinContainer = document.getElementById('pinyin-container');
            const phanTichElement = document.getElementById('phanTich');
            const phanTichContainer = document.getElementById('phanTich-container');
            const meaningContainer = document.getElementById('meaning-container');

            questionElement.innerText = currentQuestion.hanzi.replace(/\|/g, '\n');
            pinyinElement.innerText = currentQuestion.pinyin ? currentQuestion.pinyin.replace(/\|/g, '\n') : hanziToPinyin(currentQuestion.hanzi);
            kyhieuElement.innerText = currentQuestion.kyhieu ? currentQuestion.kyhieu.replace(/\|/g, '\n') : '';
            questionElement.style.display = 'block';
            pinyinElement.style.display = 'block';
            kyhieuElement.style.display = currentQuestion.kyhieu ? 'block' : 'none';
            pinyinContainer.style.display = 'flex';
            meaningContainer.style.display = 'block';
            if (quizType === 'vocabulary') {
                showAnalysis();
                phanTichContainer.style.display = 'block';
                phanTichElement.style.display = 'block';
if (quizType === 'vocabulary') {
            earnedEXP += 2; // 2 Ä‘iá»ƒm cho Tá»« Vá»±ng
document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
        } else if (quizType === 'sentence') {
            earnedEXP += 4; // 4 Ä‘iá»ƒm cho Máº«u CÃ¢u
document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
        }
            }

            const nextAction = () => {
                feedbackMessage.style.display = 'none';
                questionCount++;
                currentScrambleAnswer = '';
                pinyinElement.style.display = 'none';
                kyhieuElement.style.display = 'none';
                pinyinContainer.style.display = 'none';
                phanTichContainer.style.display = 'none';
                phanTichElement.style.display = 'none';
                questionElement.style.display = 'none';
                readCompleteContainer.style.display = 'none';
                meaningContainer.style.display = showMeaning ? 'block' : 'none';
                document.getElementById('answerInput').value = '';
                document.getElementById('answerInput').disabled = false;
                inputPinyinDisplay.textContent = '';

                if (questionCount < selectedHanzi.length) {
                    if (quizType === 'sentence' && isScrambleMode) {
                        startScrambleGame();
                    } else {
                        if (quizType === 'dialogue') {
                            updateDialogueContainer();
                        }
                        loadNewQuestion();
                    }
                } else {
                    endGame();
                }
            };

            if (isNewWordMode) {
                readCompleteContainer.style.display = 'block';
                const readCompleteButton = document.getElementById('read-complete-button');
                readCompleteButton.onclick = () => {
                    playCurrentAudio(nextAction);
                };
            } else {
                playCurrentAudio(nextAction);
            }
        } else {
            feedbackMessage.innerText = 'Sai rá»“i, vui lÃ²ng nháº­p láº¡i!';
            feedbackMessage.style.display = 'block';
            // Ghi nháº­n cÃ¢u sai cho Tá»« Vá»±ng vÃ  Máº«u CÃ¢u
            if ((quizType === 'vocabulary' || quizType === 'sentence') && !wrongHanzi.includes(currentQuestion.id)) {
                wrongHanzi.push(currentQuestion.id);
                const wrongHanziList = document.getElementById('wrong-hanzi-list');
                const li = document.createElement('li');
                li.textContent = `ID: ${currentQuestion.id}, Hanzi: ${currentQuestion.hanzi}`;
                wrongHanziList.appendChild(li);
                updateStatus();
            }
            setTimeout(() => {
                feedbackMessage.innerText = '';
                feedbackMessage.style.display = 'none';
                if (quizType !== 'dialogue') {
                    document.getElementById('answerInput').value = '';
                    inputPinyinDisplay.textContent = '';
                }
            }, 1000);
        }
    }

    answerInput.removeEventListener('input', answerInput._inputHandler);
    function inputHandler() {
        displayPinyin();
        if (autoCheck.checked) {
            checkPinyin();
        }
    }
    answerInput._inputHandler = inputHandler;
    answerInput.addEventListener('input', inputHandler);

    testButton.removeEventListener('click', testButton._clickHandler);
    function testHandler() {
        checkPinyin();
    }
    testButton._clickHandler = testHandler;
    testButton.addEventListener('click', testHandler);
	
	// áº¨n hÃ¬nh áº£nh há»™i thoáº¡i náº¿u khÃ´ng pháº£i cháº¿ Ä‘á»™ dialogue
const dialogueImage = document.getElementById('dialogue-image');
if (quizType !== 'dialogue') {
    dialogueImage.style.display = 'none';
}
}

    // Sá»± kiá»‡n cho diceButton (dÃ¹ng trong Máº«u CÃ¢u vÃ  Há»™i Thoáº¡i)
document.getElementById('diceButton').addEventListener('click', function() {
    if (isWritingMode) {
        stopWritingMode(); // Táº¯t cháº¿ Ä‘á»™ táº­p viáº¿t náº¿u Ä‘ang báº­t
    }
    if (!isScrambleMode) {
        startScrambleGame(); // Báº­t cháº¿ Ä‘á»™ xáº¿p chá»¯
    } else {
        stopScrambleGame(); // Táº¯t cháº¿ Ä‘á»™ xáº¿p chá»¯
    }
});

 function displayScrambleQuestion() {
    const dialogueContainer = document.getElementById('dialogue-container');
    dialogueContainer.innerHTML = '';

    const hanzi = currentQuestion.hanzi.replace(/\|/g, '');
    const correctAnswer = hanzi;
    const validChars = correctAnswer.split('').filter(char => !/[.,!?ï¼Œã€‚ï¼ï¼Ÿ]/.test(char));
    let hiddenHanzi = '';
    let answerIndex = 0; // Chá»‰ sá»‘ theo dÃµi vá»‹ trÃ­ trong currentScrambleAnswer

    for (let j = 0; j < correctAnswer.length; j++) {
        if (/[.,!?ï¼Œã€‚ï¼ï¼Ÿ]/.test(correctAnswer[j])) {
            hiddenHanzi += correctAnswer[j]; // Giá»¯ nguyÃªn dáº¥u cÃ¢u
        } else {
            if (answerIndex < currentScrambleAnswer.length) {
                hiddenHanzi += currentScrambleAnswer[answerIndex];
                answerIndex++;
            } else {
                hiddenHanzi += '*';
                answerIndex++;
            }
        }
    }

    const dialogueBox = document.createElement('div');
    dialogueBox.className = 'dialogue-box';
    dialogueBox.innerText = hiddenHanzi;
    dialogueContainer.appendChild(dialogueBox);
}

function startScrambleGame() {
    isScrambleMode = true;
    document.getElementById('writing-container').style.display = 'none';
    document.getElementById('option-buttons').style.display = 'none';
    document.getElementById('word-scramble-game').style.display = 'none';
    document.getElementById('question').style.display = 'none';
    document.getElementById('pinyin-container').style.display = 'none';
    document.getElementById('dialogue-display').style.display = 'block';

    // áº¨n nÃºt Back vÃ  Next trong Máº«u CÃ¢u
    if (quizType === 'sentence') {
        document.getElementById('back-button').style.display = 'none';
        document.getElementById('next-button').style.display = 'none';
    } else {
        document.getElementById('back-button').style.display = 'inline-block';
        document.getElementById('next-button').style.display = 'inline-block';
    }

    // Cáº­p nháº­t currentQuestion dá»±a trÃªn questionCount
    if (questionCount < selectedHanzi.length) {
        currentQuestion = selectedHanzi[questionCount];
    }

    currentScrambleAnswer = '';

    // Cáº­p nháº­t Dá»‹ch nghÄ©a
    document.getElementById('meaning').innerText = currentQuestion.nghia.replace(/\|/g, '\n');
    document.getElementById('meaning-container').style.display = showMeaning ? 'block' : 'none';

    // PhÃ¡t Ã¢m thanh khi báº¯t Ä‘áº§u cÃ¢u há»i
    if (currentQuestion.linkmp3) {
        setupAudio(audio, currentQuestion.linkmp3, currentQuestion.time);
        playCurrentAudio(() => {});
    }

    // Hiá»ƒn thá»‹ cÃ¢u há»i
    if (quizType === 'sentence') {
        displayScrambleQuestion();
    } else {
        updateDialogueContainer();
    }

    // Lá»c bá» dáº¥u cÃ¢u khá»i danh sÃ¡ch kÃ½ tá»± cho nÃºt xáº¿p chá»¯
    const hanzi = currentQuestion.hanzi.replace(/\|/g, '');
    const characters = hanzi.split('').filter(char => !/[.,!?ï¼Œã€‚ï¼ï¼Ÿ]/.test(char));
    const shuffledChars = shuffle([...characters]);

    const scrambleButtonsContainer = document.getElementById('scrambled-buttons');
    scrambleButtonsContainer.innerHTML = '';
    scrambleButtonsContainer.style.display = 'flex';
    shuffledChars.forEach(char => {
        const button = document.createElement('button');
        button.innerText = char;
        button.addEventListener('click', () => handleScrambleButtonClick(button, char));
        scrambleButtonsContainer.appendChild(button);
    });
}

function stopScrambleGame() {
    isScrambleMode = false;
    document.getElementById('word-scramble-game').style.display = 'none';
    document.getElementById('scrambled-buttons').style.display = 'none';
    document.getElementById('diceButton').disabled = false;

    if (quizType === 'sentence') {
        // KhÃ´i phá»¥c giao diá»‡n nÃºt báº¥m cho Máº«u CÃ¢u
        document.getElementById('dialogue-display').style.display = 'none';
        document.getElementById('option-buttons').style.display = 'grid';
        document.getElementById('meaning-container').style.display = showMeaning ? 'block' : 'none';
        document.getElementById('back-button').style.display = 'none';
        document.getElementById('next-button').style.display = 'none';
        loadNewQuestion(); // Táº£i láº¡i giao diá»‡n nÃºt báº¥m
    } else {
        // Giá»¯ giao diá»‡n Há»™i Thoáº¡i
        document.getElementById('dialogue-display').style.display = 'block';
        document.getElementById('option-buttons').style.display = 'none';
        document.getElementById('back-button').style.display = 'inline-block';
        document.getElementById('next-button').style.display = 'inline-block';
        updateDialogueContainer();
    }
}

function handleScrambleButtonClick(button, char) {
    const correctAnswer = currentQuestion.hanzi.replace(/\|/g, '').replace(/[.,!?ï¼Œã€‚ï¼ï¼Ÿ]/g, '');
    const nextChar = correctAnswer[currentScrambleAnswer.length];

    if (char === nextChar) {
        currentScrambleAnswer += char;
        button.style.display = 'none';

// Award 1 EXP for each correct character
        earnedEXP += 1;
        document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;

        if (quizType === 'sentence') {
            displayScrambleQuestion();
        } else {
            updateDialogueContainer();
        }

        if (currentScrambleAnswer === correctAnswer) {
            document.getElementById('feedback').innerText = 'Tá»‘t láº¯m, báº¡n Ä‘Ã£ chá»n Ä‘Ãºng!';
            document.getElementById('feedback').style.display = 'block';
            document.getElementById('answerInput').disabled = true;
            if (timerInterval) clearInterval(timerInterval);

            const questionElement = document.getElementById('question');
            const pinyinElement = document.getElementById('pinyin');
            const kyhieuElement = document.getElementById('kyhieu');
            const pinyinContainer = document.getElementById('pinyin-container');
            const phanTichElement = document.getElementById('phanTich');
            const phanTichContainer = document.getElementById('phanTich-container');
            const meaningContainer = document.getElementById('meaning-container');
            const readCompleteContainer = document.getElementById('read-complete-container');

            questionElement.innerText = currentQuestion.hanzi.replace(/\|/g, '\n');
            pinyinElement.innerText = currentQuestion.pinyin ? currentQuestion.pinyin.replace(/\|/g, '\n') : hanziToPinyin(currentQuestion.hanzi);
            kyhieuElement.innerText = currentQuestion.kyhieu ? currentQuestion.kyhieu.replace(/\|/g, '\n') : '';
            questionElement.style.display = 'block';
            pinyinElement.style.display = 'block';
            kyhieuElement.style.display = currentQuestion.kyhieu ? 'block' : 'none';
            pinyinContainer.style.display = 'flex';
            meaningContainer.style.display = 'block';
            if (quizType === 'vocabulary') {
                showAnalysis();
                phanTichContainer.style.display = 'block';
                phanTichElement.style.display = 'block';
                earnedEXP += 0; // 1 Ä‘iá»ƒm cho Tá»« Vá»±ng
document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
            } else if (quizType === 'sentence') {
               earnedEXP += 0; // 5 Ä‘iá»ƒm cho Máº«u CÃ¢u
document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
            }

            const nextAction = () => {
                document.getElementById('feedback').style.display = 'none';
                currentScrambleAnswer = '';
                pinyinElement.style.display = 'none';
                kyhieuElement.style.display = 'none';
                pinyinContainer.style.display = 'none';
                phanTichContainer.style.display = 'none';
                phanTichElement.style.display = 'none';
                questionElement.style.display = 'none';
                readCompleteContainer.style.display = 'none';
                meaningContainer.style.display = showMeaning ? 'block' : 'none';
                document.getElementById('answerInput').value = '';
                document.getElementById('answerInput').disabled = false;
                document.getElementById('inputPinyinDisplay').textContent = '';

                questionCount++;
                if (questionCount < selectedHanzi.length) {
                    if (quizType === 'sentence' && isScrambleMode) {
                        startScrambleGame();
                    } else {
                        if (quizType === 'dialogue') {
                            updateDialogueContainer();
                        }
                        loadNewQuestion();
                    }
                } else {
                    endGame();
                }
            };

            if (isNewWordMode) {
                readCompleteContainer.style.display = 'block';
                const readCompleteButton = document.getElementById('read-complete-button');
                readCompleteButton.onclick = () => {
                    playCurrentAudio(nextAction);
                };
            } else {
                playCurrentAudio(nextAction);
            }
        }
    } else {
        button.classList.add('incorrect');
// Trá»« 2 Ä‘iá»ƒm khi chá»n sai kÃ½ tá»± trong cháº¿ Ä‘á»™ Máº«u cÃ¢u hoáº·c Há»™i thoáº¡i
        if (quizType === 'sentence' || quizType === 'dialogue') {
            earnedEXP -=2;
            document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
        }
        setTimeout(() => {
            button.classList.remove('incorrect');
        }, 200);
    }
}

    document.getElementById('back-button').addEventListener('click', function() {
        if (quizType === 'dialogue' && questionCount > 0) {
earnedEXP -=2;
            document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
            questionCount--;
            currentScrambleAnswer = '';
            loadNewQuestion();
        }
    });

    document.getElementById('next-button').addEventListener('click', function() {
    if (quizType === 'dialogue' && showMeaning && currentQuestion.linkmp3) {
        // PhÃ¡t audio trÆ°á»›c khi xá»­ lÃ½ logic Next
        const audio = document.getElementById('audio');
        setupAudio(audio, currentQuestion.linkmp3, currentQuestion.time);
        playCurrentAudio(() => {
            // Callback: Thá»±c hiá»‡n logic Next sau khi audio phÃ¡t xong
            if (questionCount < selectedHanzi.length - 1) {
                earnedEXP += 2; // 2 Ä‘iá»ƒm cho má»—i cÃ¢u Há»™i Thoáº¡i
                document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
                questionCount++;
                currentScrambleAnswer = '';
                loadNewQuestion();
            } else {
                earnedEXP += 2; // ThÃªm 2 Ä‘iá»ƒm cho cÃ¢u cuá»‘i
                document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
                endGame();
            }
        });
    } else if (quizType === 'dialogue') {
        // HÃ nh vi bÃ¬nh thÆ°á»ng cho Há»™i Thoáº¡i (khi showMeaning = false hoáº·c khÃ´ng cÃ³ linkmp3)
        if (questionCount < selectedHanzi.length - 1) {
            earnedEXP += 2; // 2 Ä‘iá»ƒm cho má»—i cÃ¢u Há»™i Thoáº¡i
            document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
            questionCount++;
            currentScrambleAnswer = '';
            loadNewQuestion();
        } else {
            earnedEXP += 2; // ThÃªm 2 Ä‘iá»ƒm cho cÃ¢u cuá»‘i
            document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;
            endGame();
        }
    }
});

    function showHanziPopup(char) {
    const popup = document.getElementById('hanzi-popup');
    const popupContent = document.getElementById('hanzi-popup-content');
    let content = '';

    // Kiá»ƒm tra xem char cÃ³ pháº£i lÃ  tá»«/cá»¥m tá»« má»›i trong hanzi3Data khÃ´ng
    const lessonInput = document.getElementById('lesson-input').value.trim();
    const lessonFilter = parseLessonInput(lessonInput) || [];
    const wordInfo = hanzi3Data.find(item => item.hanzi === char && lessonFilter.includes(item.bai));
    if (wordInfo) {
        content += '<strong style="color: darkblue; text-align: center; display: block;">ThÃ´ng tin tá»« má»›i:</strong>';
        content += `<p><strong>Tá»« má»›i: </strong><span style="color: red">${char}</span> <span style="color: blue">(${wordInfo.pinyin})</span></p>`;
        content += `<p><strong>HÃ¡n viá»‡t: </strong><span style="color: green">${wordInfo.kyhieu.replace(/\|/g, '\n')}</span></p>`;
        content += `<p><strong>NghÄ©a: </strong><span style="color: green">${wordInfo.nghia.replace(/\|/g, '\n')}</span></p>`;
        if (wordInfo.phanTich) {
            content += `<p><strong>PhÃ¢n tÃ­ch:</strong></p>`;
            content += `<p><span style="color: blue">${wordInfo.phanTich.replace(/\|/g, '\n')}</span></p>`;
        }
        content += '<hr>'; // ThÃªm Ä‘Æ°á»ng phÃ¢n cÃ¡ch sau thÃ´ng tin tá»«/cá»¥m tá»« má»›i
    }

    // TÃ¡ch cá»¥m tá»« thÃ nh tá»«ng kÃ½ tá»± vÃ  láº¥y thÃ´ng tin tá»« bangHanTuData
    const characters = char.split('');
    content += '<strong style="color: darkblue; text-align: center; display: block;">PhÃ¢n tÃ­ch HÃ¡n Tá»±:</strong>';
    characters.forEach(c => {
        const hanTuInfo = bangHanTuData.find(item => item.hanTu === c);
        const pinyinInfo = pinyinTuDienData[c];
        content += `<p><strong>HÃ¡n Tá»±:</strong> <span style="color: red">${c}</span></p>`;
        if (pinyinInfo) {
            content += `<p><strong>Pinyin:</strong> <span style="color: blue">${pinyinInfo}</span></p>`;
        } else {
            content += `<p>KhÃ´ng tÃ¬m tháº¥y pinyin cho HÃ¡n tá»±: <span style="color: purple">${c}</span></p>`;
        }
        if (hanTuInfo) {
            content += `<p><span style="color: purple">${hanTuInfo.cauTao.replace(/\|/g, '\n')}</span></p>`;
        } else {
            content += `<p>KhÃ´ng tÃ¬m tháº¥y cáº¥u táº¡o cho HÃ¡n tá»±: <span style="color: purple">${c}</span></p>`;
        }
        content += '<hr class="dashed-divider">'; // ThÃªm Ä‘Æ°á»ng nÃ©t Ä‘á»©t giá»¯a cÃ¡c kÃ½ tá»±
    });

    popupContent.innerHTML = content;
    popup.style.display = 'block';
}

    function closeHanziPopup() {
        document.getElementById('hanzi-popup').style.display = 'none';
    }

    function updateDialogueContainer() {
    const dialogueContainer = document.getElementById('dialogue-container');
    const dialogueDisplay = document.getElementById('dialogue-display');
    const dialogueImage = document.getElementById('dialogue-image');
    const meaningContainer = document.getElementById('meaning-container');
    const optionButtons = document.getElementById('option-buttons');
    const answerInput = document.getElementById('answerInput');

    dialogueContainer.innerHTML = '';

    // Láº¥y danh sÃ¡ch tá»« má»›i tá»« hanzi3Data tÆ°Æ¡ng á»©ng vá»›i bÃ i hiá»‡n táº¡i
    const lessonInput = document.getElementById('lesson-input').value.trim();
    const lessonFilter = parseLessonInput(lessonInput) || [];
    const newWords = hanzi3Data.filter(word => lessonFilter.includes(word.bai)).map(word => word.hanzi);

    for (let i = 0; i <= questionCount; i++) {
        const question = selectedHanzi[i];
        if (!question) continue;

        const dialogueBox = document.createElement('div');
        dialogueBox.className = 'dialogue-box';
        if (question.kieu === 'A') {
            dialogueBox.classList.add('kieu-A');
        } else if (question.kieu === 'B') {
            dialogueBox.classList.add('kieu-B');
        } else if (question.kieu === 'C') {
            dialogueBox.classList.add('kieu-C');
        } else if (question.kieu === 'D') {
            dialogueBox.classList.add('kieu-D');
        } else if (question.kieu === 'E') {
            dialogueBox.classList.add('kieu-E');
        } else if (question.kieu === 'F') {
            dialogueBox.classList.add('kieu-F');
        } else if (question.kieu === 'G') {
            dialogueBox.classList.add('kieu-G');
        }

        const nhanVatSpan = document.createElement('span');
        nhanVatSpan.className = 'nhanvat';
        nhanVatSpan.innerText = question.nhanVat ? `${question.nhanVat} ` : '';
        dialogueBox.appendChild(nhanVatSpan);

        const hanziContainer = document.createElement('span');
        const hanzi = question.hanzi.replace(/\|/g, '');

        if (i === questionCount && (isScrambleMode || isWritingMode)) {
            const validChars = hanzi.split('').filter(char => !/[.,!?ï¼Œã€‚ï¼ï¼Ÿ]/.test(char));
            let hiddenHanzi = '';
            let answerIndex = 0;

            hanzi.split('').forEach(char => {
                if (/[.,!?ï¼Œã€‚ï¼ï¼Ÿ]/.test(char)) {
                    hiddenHanzi += char;
                } else {
                    if (answerIndex < currentScrambleAnswer.length) {
                        hiddenHanzi += currentScrambleAnswer[answerIndex];
                        answerIndex++;
                    } else {
                        hiddenHanzi += '*';
                        answerIndex++;
                    }
                }
            });

            hanziContainer.innerText = hiddenHanzi;
        } else {
            let currentText = '';
            let j = 0;
            while (j < hanzi.length) {
                let matched = false;
                // Kiá»ƒm tra cÃ¡c cá»¥m tá»« má»›i cÃ³ Ä‘á»™ dÃ i tá»« dÃ i Ä‘áº¿n ngáº¯n
                for (let len = Math.min(4, hanzi.length - j); len >= 1; len--) {
                    const substring = hanzi.substr(j, len);
                    if (newWords.includes(substring)) {
                        const wordSpan = document.createElement('span');
                        wordSpan.style.color = 'red';
                        wordSpan.className = 'hanzi-clickable';
                        wordSpan.innerText = substring;
                        wordSpan.addEventListener('click', () => showHanziPopup(substring));
                        hanziContainer.appendChild(wordSpan);
                        j += len;
                        matched = true;
                        break;
                    }
                }
                if (!matched) {
                    const char = hanzi[j];
                    const charSpan = document.createElement('span');
                    if (char.trim() && !/[.,!?ï¼Œã€‚ï¼ï¼Ÿ]/.test(char)) {
                        charSpan.className = 'hanzi-clickable';
                        charSpan.addEventListener('click', () => showHanziPopup(char));
                    }
                    charSpan.innerText = char;
                    hanziContainer.appendChild(charSpan);
                    j++;
                }
            }
        }
        dialogueBox.appendChild(hanziContainer);
        dialogueContainer.appendChild(dialogueBox);
    }

    currentQuestion = selectedHanzi[questionCount];
    if (!currentQuestion) return;

    dialogueDisplay.style.display = 'block';
    dialogueImage.src = currentQuestion.anh || '';
    dialogueImage.style.display = !currentQuestion.anh ? 'none' : 'block';
    document.getElementById('meaning').innerText = currentQuestion.nghia ? currentQuestion.nghia.replace(/\|/g, '\n') : '';
    meaningContainer.style.display = showMeaning ? 'block' : 'none';
    optionButtons.style.display = 'none';
    document.getElementById('timer').innerText = '';

    dialogueContainer.scrollTop = dialogueContainer.scrollHeight;
    dialogueDisplay.scrollTop = dialogueDisplay.scrollHeight;

    isHintVisible = false;
    document.getElementById('question').style.display = 'none';
    document.getElementById('pinyin-container').style.display = 'none';
    document.getElementById('pinyin').style.display = 'none';
    document.getElementById('kyhieu').style.display = 'none';
    document.getElementById('phanTich-container').style.display = 'none';
    document.getElementById('phanTich').style.display = 'none';

    if (!isScrambleMode && !isWritingMode && currentQuestion.linkmp3 && !showMeaning) {
        setupAudio(audio, currentQuestion.linkmp3, currentQuestion.time);
        playCurrentAudio(() => {});
    }

    answerInput.value = '';
    answerInput.disabled = false;
    document.getElementById('inputPinyinDisplay').textContent = '';

    updateStatus();
}

function showInfoPopup(txtLink) {
    const popup = document.getElementById('info-popup');
    const popupContent = document.getElementById('info-popup-content');

    fetch(txtLink)
        .then(response => {
            if (!response.ok) throw new Error('KhÃ´ng thá»ƒ táº£i file thÃ´ng tin');
            return response.text();
        })
        .then(data => {
            // TÃ¡ch ná»™i dung thÃ nh cÃ¡c dÃ²ng
            const lines = data.split('\n');
            let htmlContent = '';
            
            // Xá»­ lÃ½ tá»«ng dÃ²ng
            lines.forEach(line => {
                // Loáº¡i bá» khoáº£ng tráº¯ng Ä‘áº§u/cuá»‘i dÃ²ng
                const trimmedLine = line.trim();
                
                // Kiá»ƒm tra dÃ²ng cÃ³ khá»›p vá»›i máº«u _*.txt khÃ´ng
                if (trimmedLine.match(/^_[^.]+\.txt$/)) {
                    // Táº¡o nÃºt báº¥m vá»›i tÃªn tÃ¹y chá»‰nh
                    htmlContent += `<a href="#" onclick="showNestedInfoPopup('${trimmedLine}'); return false;">>>Báº¥m Ä‘á»ƒ xem<<</a>\n`;
                } else {
                    // Giá»¯ nguyÃªn dÃ²ng dÆ°á»›i dáº¡ng vÄƒn báº£n, thoÃ¡t kÃ½ tá»± HTML
                    htmlContent += `${line.replace(/</g, '<').replace(/>/g, '>')}\n`;
                }
            });

            // GÃ¡n ná»™i dung Ä‘Ã£ xá»­ lÃ½
            popupContent.innerHTML = htmlContent;
            popup.style.display = 'block';
        })
        .catch(error => {
            console.error('Lá»—i khi táº£i file thÃ´ng tin:', error);
            popupContent.innerText = 'KhÃ´ng thá»ƒ táº£i thÃ´ng tin.';
            popup.style.display = 'block';
        });
}

function showNestedInfoPopup(txtLink) {
    const popup = document.getElementById('nested-info-popup');
    const popupContent = document.getElementById('nested-info-popup-content');

    fetch(txtLink)
        .then(response => {
            if (!response.ok) throw new Error('KhÃ´ng thá»ƒ táº£i file thÃ´ng tin liÃªn káº¿t');
            return response.text();
        })
        .then(data => {
            // TÃ¡ch ná»™i dung thÃ nh cÃ¡c dÃ²ng
            const lines = data.split('\n');
            let htmlContent = '';
            
            // Xá»­ lÃ½ tá»«ng dÃ²ng
            lines.forEach(line => {
                // Loáº¡i bá» khoáº£ng tráº¯ng Ä‘áº§u/cuá»‘i dÃ²ng
                const trimmedLine = line.trim();
                
                // Kiá»ƒm tra dÃ²ng cÃ³ khá»›p vá»›i máº«u _*.txt khÃ´ng
                if (trimmedLine.match(/^_[^.]+\.txt$/)) {
                    // Táº¡o nÃºt báº¥m vá»›i tÃªn tÃ¹y chá»‰nh
                    htmlContent += `<a href="#" onclick="showNestedInfoPopup('${trimmedLine}'); return false;">>>Báº¥m Ä‘á»ƒ xem<<</a>\n`;
                } else {
                    // Giá»¯ nguyÃªn dÃ²ng dÆ°á»›i dáº¡ng vÄƒn báº£n, thoÃ¡t kÃ½ tá»± HTML
                    htmlContent += `${line.replace(/</g, '<').replace(/>/g, '>')}\n`;
                }
            });

            // GÃ¡n ná»™i dung Ä‘Ã£ xá»­ lÃ½
            popupContent.innerHTML = htmlContent;
            popup.style.display = 'block';
        })
        .catch(error => {
            console.error('Lá»—i khi táº£i file thÃ´ng tin liÃªn káº¿t:', error);
            popupContent.innerText = 'KhÃ´ng thá»ƒ táº£i thÃ´ng tin liÃªn káº¿t.';
            popup.style.display = 'block';
        });
}

function closeNestedInfoPopup() {
    document.getElementById('nested-info-popup').style.display = 'none';
}

function showAuthorPopup(txtLink) {
    const popup = document.getElementById('author-popup');
    const popupContent = document.getElementById('author-popup-content');

    fetch(txtLink)
        .then(response => {
            if (!response.ok) throw new Error('KhÃ´ng thá»ƒ táº£i file tÃ¡c giáº£');
            return response.text();
        })
        .then(data => {
            const lines = data.split('\n');
            const imageUrl = lines[0].trim();
            const textContent = lines.slice(1).join('\n');

            let content = '';
            if (imageUrl.endsWith('.jpg') || imageUrl.endsWith('.png')) {
                content += `<img src="${imageUrl}" alt="Author Image">`;
            }
            content += `<div>${textContent}</div>`;

            popupContent.innerHTML = content;
            popup.style.display = 'block';
        })
        .catch(error => {
            console.error('Lá»—i khi táº£i file tÃ¡c giáº£:', error);
            popupContent.innerText = 'KhÃ´ng thá»ƒ táº£i thÃ´ng tin tÃ¡c giáº£.';
            popup.style.display = 'block';
        });
}

document.querySelectorAll('.meaning-button').forEach(button => {
    button.addEventListener('click', () => {
        console.log('Meaning button clicked:', button.getAttribute('data-value')); // Debug
        // XÃ³a lá»›p active tá»« táº¥t cáº£ cÃ¡c nÃºt
        document.querySelectorAll('.meaning-button').forEach(btn => btn.classList.remove('active'));
        // ThÃªm lá»›p active cho nÃºt Ä‘Æ°á»£c nháº¥n
        button.classList.add('active');
        // Cáº­p nháº­t showMeaning dá»±a trÃªn data-value
        showMeaning = button.getAttribute('data-value') === 'show';
        console.log('showMeaning updated to:', showMeaning); // Debug
    });
});

function updateButtonVisibility() {
    const relatedBtn = document.querySelector('.related-btn');
    const magnifierBtn = document.querySelector('.magnifier-btn');
    
    if (selectedMode === 'taiwanese') {
        relatedBtn.style.display = 'inline-block';
        magnifierBtn.style.display = 'inline-block';
    } else {
        relatedBtn.style.display = 'none';
        magnifierBtn.style.display = 'none';
    }
}

function closeInfoPopup() {
    document.getElementById('info-popup').style.display = 'none';
}

function closeAuthorPopup() {
    document.getElementById('author-popup').style.display = 'none';
}

// Sá»± kiá»‡n cho writeButton (dÃ¹ng trong Tá»« Vá»±ng vÃ  Máº«u CÃ¢u)
document.getElementById('writeButton').addEventListener('click', function() {
    if (isScrambleMode) {
        stopScrambleGame(); // Táº¯t cháº¿ Ä‘á»™ xáº¿p chá»¯ náº¿u Ä‘ang báº­t
    }
    if (!isWritingMode) {
        startWritingMode(); // Báº­t cháº¿ Ä‘á»™ táº­p viáº¿t
    } else {
        stopWritingMode(); // Táº¯t cháº¿ Ä‘á»™ táº­p viáº¿t
    }
});

// Sá»± kiá»‡n cho write-dialogue-button (dÃ¹ng trong Há»™i Thoáº¡i)
document.getElementById('write-dialogue-button').addEventListener('click', function() {
    if (isScrambleMode) {
        stopScrambleGame(); // Táº¯t cháº¿ Ä‘á»™ xáº¿p chá»¯ náº¿u Ä‘ang báº­t
    }
    if (!isWritingMode) {
        startWritingMode(); // Báº­t cháº¿ Ä‘á»™ táº­p viáº¿t
    } else {
        stopWritingMode(); // Táº¯t cháº¿ Ä‘á»™ táº­p viáº¿t
    }
});

document.getElementById('back-to-mode-button').addEventListener('click', () => {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('mode-selection-screen').style.display = 'block';
    // Reset cÃ¡c tráº¡ng thÃ¡i náº¿u cáº§n
    document.getElementById('quiz-type-buttons').style.display = 'none';
    document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
});

document.getElementById('homeButton').addEventListener('click', () => {
    if (confirm('Báº¡n cÃ³ muá»‘n quay vá» mÃ n hÃ¬nh chá»n cháº¿ Ä‘á»™? Tiáº¿n Ä‘á»™ hiá»‡n táº¡i sáº½ bá»‹ máº¥t.')) {
        // áº¨n cÃ¡c container khÃ´ng cáº§n thiáº¿t
        document.getElementById('game-container').style.display = 'none';
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('endgame-popup').style.display = 'none';
        
        // áº¨n cÃ¡c báº£ng chá»©c nÄƒng
        document.getElementById('related-hanzi-list').style.display = 'none';
        document.getElementById('menuContainer').style.display = 'none';
        document.getElementById('searchContainer').style.display = 'none';
        document.getElementById('translateContainer').style.display = 'none';
        document.getElementById('hanziiContainer').style.display = 'none';
        document.getElementById('hanzi-popup').style.display = 'none';
        document.getElementById('info-popup').style.display = 'none';
        document.getElementById('author-popup').style.display = 'none';
        document.getElementById('nested-info-popup').style.display = 'none';

        // Hiá»ƒn thá»‹ mÃ n hÃ¬nh chá»n cháº¿ Ä‘á»™
        const modeSelectionScreen = document.getElementById('mode-selection-screen');
        modeSelectionScreen.style.display = 'block';
        
        // Äáº£m báº£o cÃ¡c thÃ nh pháº§n bÃªn trong mode-selection-screen hiá»ƒn thá»‹
        const quizTypeButtons = document.getElementById('quiz-type-buttons');
        quizTypeButtons.style.display = 'none'; // áº¨n nÃºt loáº¡i Ã´n táº­p
        const accountInfo = document.getElementById('account-info');
        accountInfo.style.display = 'block';
        
        // Äáº£m báº£o cÃ¡c nÃºt cháº¿ Ä‘á»™ hiá»ƒn thá»‹
        document.querySelectorAll('.mode-button').forEach(btn => {
            btn.style.display = 'block';
            btn.classList.remove('active');
        });

        // Reset tráº¡ng thÃ¡i trÃ² chÆ¡i
        questionCount = 0;
        wrongHanzi = [];
        selectedHanzi = [];
        isReviewMode = false;
        isScrambleMode = false;
        isWritingMode = false;
        isNewWordMode = false;
        currentScrambleAnswer = '';
        currentCharIndex = 0;
        randomMissionLesson = null; // Reset nhiá»‡m vá»¥ ngáº«u nhiÃªn
        earnedEXP = 0; // Reset EXP kiáº¿m Ä‘Æ°á»£c
document.getElementById('earned-exp').textContent = `Äiá»ƒm: ${earnedEXP}`;

        // Reset giao diá»‡n trÃ² chÆ¡i
        document.getElementById('answerInput').value = '';
        document.getElementById('answerInput').disabled = false;
        document.getElementById('playButton').disabled = false;
        document.getElementById('hintButton').disabled = false;
        document.getElementById('wrong-hanzi-list').innerHTML = '';
        document.getElementById('review-hanzi-list').innerHTML = '';
        document.getElementById('review-hanzi-display').style.display = 'none';
        document.getElementById('option-buttons').innerHTML = '';
        document.getElementById('scrambled-buttons').innerHTML = '';
        document.getElementById('dialogue-container').innerHTML = '';
        document.getElementById('writing-container').style.display = 'none';
        document.getElementById('pinyin-container').style.display = 'none';
        document.getElementById('phanTich-container').style.display = 'none';
        document.getElementById('meaning-container').style.display = 'none';
        document.getElementById('dialogue-display').style.display = 'none';

        // Reset cÃ¡c trÆ°á»ng input
        document.getElementById('lesson-input').value = '';
        document.getElementById('word-count').value = '30';
        document.getElementById('time-limit').value = '20';
        document.getElementById('dialogue-number').value = '';

        // Reset audio
        const audio = document.getElementById('audio');
        audio.src = '';
        audio.pause();

        // Dá»«ng timer náº¿u Ä‘ang cháº¡y
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        // Äáº£m báº£o header-container hiá»ƒn thá»‹
        document.querySelector('.header-container').style.display = 'block';

        // Táº£i láº¡i dá»¯ liá»‡u tÃ i khoáº£n Ä‘á»ƒ Ä‘áº£m báº£o thÃ´ng tin má»›i nháº¥t
        loadAccountData();
    }
});

function returnToModeSelection() {
    // áº¨n popup
    document.getElementById('hanzi-popup').style.display = 'none';

    // áº¨n game-container
    document.getElementById('game-container').style.display = 'none';

    // Hiá»ƒn thá»‹ mode-selection-screen
    document.getElementById('mode-selection-screen').style.display = 'block';

    // Reset tráº¡ng thÃ¡i trÃ² chÆ¡i
    document.getElementById('quiz-type-buttons').style.display = 'none';
    document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
    questionCount = 0;
    wrongHanzi = [];
    selectedHanzi = [];
    isReviewMode = false;
    isScrambleMode = false;
    isWritingMode = false;
    isNewWordMode = false;
    currentScrambleAnswer = '';
    currentCharIndex = 0;
    document.getElementById('answerInput').value = '';
    document.getElementById('answerInput').disabled = false;
    document.getElementById('playButton').disabled = false;
    document.getElementById('hintButton').disabled = false;
    document.getElementById('wrong-hanzi-list').innerHTML = '';
    document.getElementById('review-hanzi-list').innerHTML = '';
    document.getElementById('review-hanzi-display').style.display = 'none';

    // Reset cÃ¡c trÆ°á»ng input
    document.getElementById('lesson-input').value = '';
    document.getElementById('word-count').value = '30';
    document.getElementById('time-limit').value = '20';
    document.getElementById('dialogue-number').value = '';

// ÄÃ³ng endgame-popup
    const popup = document.getElementById('endgame-popup');
    if (popup) {
        popup.style.display = 'none';
    }

    // Reset cÃ¡c biáº¿n vÃ  tráº¡ng thÃ¡i trÃ² chÆ¡i (náº¿u cáº§n)
    isReviewMode = false;
    questionCount = 0;
    wrongHanzi = [];
    currentReviewList = [];
    selectedHanzi = [];
    totalWords = 0;

    // Chuyá»ƒn vá» mÃ n hÃ¬nh chá»n cháº¿ Ä‘á»™
    document.getElementById('mode-selection').style.display = 'block';
    document.getElementById('quiz-container').style.display = 'none';
    document.getElementById('review-hanzi-display').style.display = 'none';

    // Báº­t láº¡i cÃ¡c nÃºt vÃ  input náº¿u cáº§n
    document.getElementById('answerInput').disabled = false;
    document.getElementById('playButton').disabled = false;
    document.getElementById('hintButton').disabled = false;
}

// Xá»­ lÃ½ checkbox hiá»‡n máº­t kháº©u cho Ä‘Äƒng nháº­p
document.getElementById('show-login-pass').addEventListener('change', function() {
    const passwordInput = document.getElementById('login-pass');
    passwordInput.type = this.checked ? 'text' : 'password';
});

// Xá»­ lÃ½ checkbox hiá»‡n máº­t kháº©u cho Ä‘Äƒng kÃ½
document.getElementById('show-register-pass').addEventListener('change', function() {
    const passwordInput = document.getElementById('register-pass');
    passwordInput.type = this.checked ? 'text' : 'password';
});
// Danh sÃ¡ch link YouTube
const youtubeLinks = [
    'https://www.youtube.com/watch?v=YtJmoUiMmhY',
    'https://www.youtube.com/watch?v=4F6ssqaefdg',
    'https://www.youtube.com/watch?v=0fNAnbo3LAs'
];

// HÃ m chá»n vÃ  phÃ¡t video ngáº«u nhiÃªn vá»›i loop
function playRandomYouTubeVideo() {
    const randomIndex = Math.floor(Math.random() * youtubeLinks.length);
    const videoUrl = youtubeLinks[randomIndex];
    const videoId = videoUrl.split('v=')[1].split('&')[0]; // Láº¥y ID video
    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1&playlist=${videoId}`;
    document.getElementById('youtube-player').src = embedUrl;
}

// PhÃ¡t video khi táº£i mÃ n hÃ¬nh Ä‘Äƒng nháº­p
playRandomYouTubeVideo();

// PhÃ¡t video má»›i khi chuyá»ƒn tá»« Ä‘Äƒng kÃ½ vá» Ä‘Äƒng nháº­p
document.getElementById('show-login').addEventListener('click', () => {
    document.getElementById('login-container').style.display = 'block';
    document.getElementById('register-container').style.display = 'none';
    document.getElementById('auth-error').style.display = 'none';
    playRandomYouTubeVideo(); // PhÃ¡t video ngáº«u nhiÃªn
});
</script>
</body>
</html>